1:aa4dd7c: /**
1:aa4dd7c:  *  Licensed to the Apache Software Foundation (ASF) under one or more
1:aa4dd7c:  *  contributor license agreements.  See the NOTICE file distributed with
1:aa4dd7c:  *  this work for additional information regarding copyright ownership.
1:aa4dd7c:  *  The ASF licenses this file to You under the Apache License, Version 2.0
1:aa4dd7c:  *  (the "License"); you may not use this file except in compliance with
1:aa4dd7c:  *  the License.  You may obtain a copy of the License at
1:aa4dd7c:  *
1:aa4dd7c:  *     http://www.apache.org/licenses/LICENSE-2.0
1:aa4dd7c:  *
1:aa4dd7c:  *  Unless required by applicable law or agreed to in writing, software
1:aa4dd7c:  *  distributed under the License is distributed on an "AS IS" BASIS,
1:aa4dd7c:  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
1:aa4dd7c:  *  See the License for the specific language governing permissions and
1:aa4dd7c:  *  limitations under the License.
1:aa4dd7c:  */
1:1f8e5bb: package org.apache.aries.samples.ariestrader.persist.jpa.am;
3:aa4dd7c: 
1:aa4dd7c: import java.math.BigDecimal;
1:aa4dd7c: import java.sql.Timestamp;
1:aa4dd7c: import java.util.ArrayList;
1:aa4dd7c: import java.util.Collection;
1:aa4dd7c: import java.util.Iterator;
1:aa4dd7c: 
1:aa4dd7c: import javax.persistence.EntityManager;
1:aa4dd7c: import javax.persistence.EntityManagerFactory;
1:aa4dd7c: import javax.persistence.Query;
1:aa4dd7c: 
1:61d7f67: import org.apache.aries.samples.ariestrader.api.TradeServices;
1:3364e3f: import org.apache.aries.samples.ariestrader.entities.AccountDataBeanImpl;
1:3364e3f: import org.apache.aries.samples.ariestrader.entities.AccountProfileDataBeanImpl;
1:3364e3f: import org.apache.aries.samples.ariestrader.entities.HoldingDataBeanImpl;
1:3364e3f: import org.apache.aries.samples.ariestrader.entities.OrderDataBeanImpl;
1:3364e3f: import org.apache.aries.samples.ariestrader.entities.QuoteDataBeanImpl;
1:880e087: import org.apache.aries.samples.ariestrader.api.persistence.AccountDataBean;
1:880e087: import org.apache.aries.samples.ariestrader.api.persistence.AccountProfileDataBean;
1:880e087: import org.apache.aries.samples.ariestrader.api.persistence.HoldingDataBean;
1:880e087: import org.apache.aries.samples.ariestrader.api.persistence.MarketSummaryDataBean;
1:880e087: import org.apache.aries.samples.ariestrader.api.persistence.OrderDataBean;
1:880e087: import org.apache.aries.samples.ariestrader.api.persistence.QuoteDataBean;
1:61d7f67: import org.apache.aries.samples.ariestrader.util.FinancialUtils;
1:61d7f67: import org.apache.aries.samples.ariestrader.util.Log;
1:61d7f67: import org.apache.aries.samples.ariestrader.util.TradeConfig;
1:aa4dd7c: 
1:aa4dd7c: /**
1:aa4dd7c:  * TradeJpaAm uses JPA via a Application Managed (AM)
1:aa4dd7c:  * entity managers to implement the business methods of the
1:aa4dd7c:  * Trade online broker application. These business methods
1:aa4dd7c:  * represent the features and operations that can be performed
1:aa4dd7c:  * by customers of the brokerage such as login, logout, get a
1:aa4dd7c:  * stock quote, buy or sell a stock, etc. and are specified in
1:aa4dd7c:  * the {@link
1:61d7f67:  * org.apache.aries.samples.ariestrader.TradeServices}
1:aa4dd7c:  * interface
1:aa4dd7c:  * 
1:61d7f67:  * @see org.apache.aries.samples.ariestrader.TradeServices
1:aa4dd7c:  * 
1:aa4dd7c:  */
1:aa4dd7c: 
1:aa4dd7c: public class TradeJpaAm implements TradeServices {
1:aa4dd7c: 
1:012ec29: //    @PersistenceUnit(unitName="ariestrader-am")
1:aa4dd7c:     private static EntityManagerFactory emf;
1:aa4dd7c: 
1:aa4dd7c:     private static boolean initialized = false;
1:aa4dd7c: 
1:aa4dd7c:     /**
1:aa4dd7c:      * Zero arg constructor for TradeJpaAm
1:aa4dd7c:      */
1:aa4dd7c:     public TradeJpaAm() {
1:aa4dd7c:     }
1:aa4dd7c: 
1:012ec29:     public void setEmf (EntityManagerFactory emf) { 
1:012ec29:         this.emf = emf;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public void init() {
1:aa4dd7c:         if (initialized)
1:aa4dd7c:             return;
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:init -- *** initializing");
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:init -- +++ initialized");
1:aa4dd7c: 
1:aa4dd7c:         initialized = true;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public void destroy() {
1:aa4dd7c:         try {
1:aa4dd7c:             if (!initialized)
1:aa4dd7c:                 return;
1:aa4dd7c:             Log.trace("TradeJpaAm:destroy");
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm:destroy", e);
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public MarketSummaryDataBean getMarketSummary() {
1:aa4dd7c:         MarketSummaryDataBean marketSummaryData;
1:aa4dd7c: 
1:aa4dd7c:         /*
1:aa4dd7c:          * Creating entiManager
1:aa4dd7c:          */
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         try {
1:aa4dd7c:             if (Log.doTrace())
1:aa4dd7c:                 Log.trace("TradeJpaAm:getMarketSummary -- getting market summary");
1:aa4dd7c: 
1:aa4dd7c:             // Find Trade Stock Index Quotes (Top 100 quotes)
1:aa4dd7c:             // ordered by their change in value
1:aa4dd7c:             Collection<QuoteDataBean> quotes;
1:aa4dd7c: 
1:aa4dd7c:             Query query = entityManager.createNamedQuery("quoteejb.quotesByChange");
1:aa4dd7c:             quotes = query.getResultList();
1:aa4dd7c: 
1:aa4dd7c:             QuoteDataBean[] quoteArray = (QuoteDataBean[]) quotes.toArray(new QuoteDataBean[quotes.size()]);
1:aa4dd7c:             ArrayList<QuoteDataBean> topGainers = new ArrayList<QuoteDataBean>(
1:aa4dd7c:                                                                               5);
1:aa4dd7c:             ArrayList<QuoteDataBean> topLosers = new ArrayList<QuoteDataBean>(5);
1:aa4dd7c:             BigDecimal TSIA = FinancialUtils.ZERO;
1:aa4dd7c:             BigDecimal openTSIA = FinancialUtils.ZERO;
1:aa4dd7c:             double totalVolume = 0.0;
1:aa4dd7c: 
1:aa4dd7c:             if (quoteArray.length > 5) {
1:aa4dd7c:                 for (int i = 0; i < 5; i++)
1:aa4dd7c:                     topGainers.add(quoteArray[i]);
1:aa4dd7c:                 for (int i = quoteArray.length - 1; i >= quoteArray.length - 5; i--)
1:aa4dd7c:                     topLosers.add(quoteArray[i]);
1:aa4dd7c: 
1:aa4dd7c:                 for (QuoteDataBean quote : quoteArray) {
1:aa4dd7c:                     BigDecimal price = quote.getPrice();
1:aa4dd7c:                     BigDecimal open = quote.getOpen();
1:aa4dd7c:                     double volume = quote.getVolume();
1:aa4dd7c:                     TSIA = TSIA.add(price);
1:aa4dd7c:                     openTSIA = openTSIA.add(open);
1:aa4dd7c:                     totalVolume += volume;
1:aa4dd7c:                 }
1:aa4dd7c:                 TSIA = TSIA.divide(new BigDecimal(quoteArray.length),
1:aa4dd7c:                                    FinancialUtils.ROUND);
1:aa4dd7c:                 openTSIA = openTSIA.divide(new BigDecimal(quoteArray.length),
1:aa4dd7c:                                            FinancialUtils.ROUND);
1:aa4dd7c:             }
1:aa4dd7c: 
1:aa4dd7c:             marketSummaryData = new MarketSummaryDataBean(TSIA, openTSIA,
1:aa4dd7c:                                                           totalVolume, topGainers, topLosers);
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm:getMarketSummary", e);
1:aa4dd7c:             throw new RuntimeException("TradeJpaAm:getMarketSummary -- error ", e);
1:aa4dd7c:         }
1:aa4dd7c:         /*
1:aa4dd7c:          * closing entitymanager
1:aa4dd7c:          */
1:aa4dd7c:         entityManager.close();
1:aa4dd7c: 
1:aa4dd7c:         return marketSummaryData;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public OrderDataBean buy(String userID, String symbol, double quantity, int orderProcessingMode) {
1:aa4dd7c:         OrderDataBean order = null;
1:aa4dd7c:         BigDecimal total;
1:aa4dd7c:         /*
1:aa4dd7c:          * creating entitymanager
1:aa4dd7c:          */
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         try {
1:aa4dd7c:             if (Log.doTrace())
1:aa4dd7c:                 Log.trace("TradeJpaAm:buy", userID, symbol, quantity, orderProcessingMode);
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c: 
1:aa4dd7c:             AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c:             AccountDataBean account = profile.getAccount();
1:aa4dd7c: 
1:aa4dd7c:             QuoteDataBeanImpl quote = entityManager.find(QuoteDataBeanImpl.class, symbol);
1:aa4dd7c: 
1:aa4dd7c:             HoldingDataBeanImpl holding = null; // The holding will be created by this buy order
1:aa4dd7c: 
1:aa4dd7c:             order = createOrder( account, (QuoteDataBean) quote, (HoldingDataBean) holding, "buy", quantity, entityManager);
1:aa4dd7c: 
1:aa4dd7c:             // order = createOrder(account, quote, holding, "buy", quantity);
1:aa4dd7c:             // UPDATE - account should be credited during completeOrder
1:aa4dd7c: 
1:aa4dd7c:             BigDecimal price = quote.getPrice();
1:aa4dd7c:             BigDecimal orderFee = order.getOrderFee();
1:aa4dd7c:             BigDecimal balance = account.getBalance();
1:aa4dd7c:             total = (new BigDecimal(quantity).multiply(price)).add(orderFee);
1:aa4dd7c:             account.setBalance(balance.subtract(total));
1:aa4dd7c: 
1:aa4dd7c:             // commit the transaction before calling completeOrder
2:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c: 
1:aa4dd7c:             if (orderProcessingMode == TradeConfig.SYNCH)
1:aa4dd7c:                 completeOrder(order.getOrderID(), false);
1:aa4dd7c:             else if (orderProcessingMode == TradeConfig.ASYNCH_2PHASE)
1:aa4dd7c:                 queueOrder(order.getOrderID(), true);
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm:buy(" + userID + "," + symbol + "," + quantity + ") --> failed", e);
1:aa4dd7c:             /* On exception - cancel the order */
1:aa4dd7c:             // TODO figure out how to do this with JPA
1:aa4dd7c:             if (order != null)
1:aa4dd7c:                 order.cancel();
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c: 
1:aa4dd7c:             // throw new EJBException(e);
1:aa4dd7c:             throw new RuntimeException(e);
1:aa4dd7c:         }
1:aa4dd7c:         if (entityManager != null) {
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:b8c0170:         // after the purchase or sale of a stock, update the stocks volume and
1:aa4dd7c:         // price
1:aa4dd7c:         updateQuotePriceVolume(symbol, TradeConfig.getRandomPriceChangeFactor(), quantity);
1:aa4dd7c: 
1:aa4dd7c:         return order;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public OrderDataBean sell(String userID, Integer holdingID,
1:aa4dd7c:                               int orderProcessingMode) {
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         OrderDataBean order = null;
1:aa4dd7c:         BigDecimal total;
1:aa4dd7c:         try {
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             if (Log.doTrace())
1:aa4dd7c:                 Log.trace("TradeJpaAm:sell", userID, holdingID, orderProcessingMode);
1:aa4dd7c: 
1:aa4dd7c:             AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c: 
1:aa4dd7c:             AccountDataBean account = profile.getAccount();
1:aa4dd7c:             HoldingDataBeanImpl holding = entityManager.find(HoldingDataBeanImpl.class, holdingID);
1:aa4dd7c: 
1:aa4dd7c:             if (holding == null) {
1:aa4dd7c:                 Log.error("TradeJpaAm:sell User " + userID
1:aa4dd7c:                           + " attempted to sell holding " + holdingID
1:aa4dd7c:                           + " which has already been sold");
1:aa4dd7c: 
1:aa4dd7c:                 OrderDataBean orderData = new OrderDataBeanImpl();
1:aa4dd7c:                 orderData.setOrderStatus("cancelled");
1:aa4dd7c: 
1:aa4dd7c:                 entityManager.persist(orderData);
1:b29ad20: 
1:b29ad20:                 entityManager.getTransaction().commit();
1:b29ad20: 
1:aa4dd7c:                 if (entityManager != null) {
1:aa4dd7c:                     entityManager.close();
1:aa4dd7c:                     entityManager = null;
1:aa4dd7c: 
1:aa4dd7c:                 }
1:aa4dd7c: 
1:aa4dd7c:                 return orderData;
1:aa4dd7c:             }
1:aa4dd7c: 
1:aa4dd7c:             QuoteDataBean quote = holding.getQuote();
1:aa4dd7c:             double quantity = holding.getQuantity();
1:aa4dd7c: 
1:aa4dd7c:             order = createOrder(account, quote, holding, "sell", quantity,
1:aa4dd7c:                                 entityManager);
1:aa4dd7c:             // UPDATE the holding purchase data to signify this holding is
1:aa4dd7c:             // "inflight" to be sold
1:aa4dd7c:             // -- could add a new holdingStatus attribute to holdingEJB
1:aa4dd7c:             holding.setPurchaseDate(new java.sql.Timestamp(0));
1:aa4dd7c: 
1:aa4dd7c:             // UPDATE - account should be credited during completeOrder
1:aa4dd7c:             BigDecimal price = quote.getPrice();
1:aa4dd7c:             BigDecimal orderFee = order.getOrderFee();
1:aa4dd7c:             BigDecimal balance = account.getBalance();
1:aa4dd7c:             total = (new BigDecimal(quantity).multiply(price)).subtract(orderFee);
1:aa4dd7c: 
1:aa4dd7c:             account.setBalance(balance.add(total));
1:aa4dd7c: 
1:aa4dd7c:             // commit the transaction before calling completeOrder
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c: 
1:aa4dd7c:             if (orderProcessingMode == TradeConfig.SYNCH)
1:aa4dd7c:                 completeOrder(order.getOrderID(), false);
1:aa4dd7c:             else if (orderProcessingMode == TradeConfig.ASYNCH_2PHASE)
1:aa4dd7c:                 queueOrder(order.getOrderID(), true);
1:aa4dd7c: 
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm:sell(" + userID + "," + holdingID + ") --> failed", e);
1:aa4dd7c:             // TODO figure out JPA cancel
1:aa4dd7c:             if (order != null)
1:aa4dd7c:                 order.cancel();
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c: 
1:aa4dd7c:             throw new RuntimeException("TradeJpaAm:sell(" + userID + "," + holdingID + ")", e);
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (entityManager != null) {
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (!(order.getOrderStatus().equalsIgnoreCase("cancelled")))
1:aa4dd7c:             //after the purchase or sell of a stock, update the stocks volume and price
1:aa4dd7c:             updateQuotePriceVolume(order.getSymbol(), TradeConfig.getRandomPriceChangeFactor(), order.getQuantity());
1:aa4dd7c: 
1:aa4dd7c:         return order;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public void queueOrder(Integer orderID, boolean twoPhase) {
1:aa4dd7c:         Log
1:aa4dd7c:         .error("TradeJpaAm:queueOrder() not implemented for this runtime mode");
1:aa4dd7c:         throw new UnsupportedOperationException(
1:aa4dd7c:                                                "TradeJpaAm:queueOrder() not implemented for this runtime mode");
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public OrderDataBean completeOrder(Integer orderID, boolean twoPhase)
1:aa4dd7c:     throws Exception {
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c:         OrderDataBeanImpl order = null;
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:completeOrder", orderID + " twoPhase=" + twoPhase);
1:aa4dd7c: 
1:aa4dd7c:         order = entityManager.find(OrderDataBeanImpl.class, orderID);
1:aa4dd7c:         order.getQuote();
1:aa4dd7c: 
1:aa4dd7c:         if (order == null) {
1:aa4dd7c:             Log.error("TradeJpaAm:completeOrder -- Unable to find Order " + orderID + " FBPK returned " + order);
1:aa4dd7c:             return null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (order.isCompleted()) {
1:aa4dd7c:             throw new RuntimeException("Error: attempt to complete Order that is already completed\n" + order);
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         AccountDataBean account = order.getAccount();
1:aa4dd7c:         QuoteDataBean quote = order.getQuote();
1:aa4dd7c:         HoldingDataBean holding = order.getHolding();
1:aa4dd7c:         BigDecimal price = order.getPrice();
1:aa4dd7c:         double quantity = order.getQuantity();
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:completeOrder--> Completing Order "
1:aa4dd7c:                       + order.getOrderID() + "\n\t Order info: " + order
1:aa4dd7c:                       + "\n\t Account info: " + account + "\n\t Quote info: "
1:aa4dd7c:                       + quote + "\n\t Holding info: " + holding);
1:aa4dd7c: 
1:aa4dd7c:         HoldingDataBean newHolding = null;
1:aa4dd7c:         if (order.isBuy()) {
1:aa4dd7c:             /*
1:aa4dd7c:              * Complete a Buy operation - create a new Holding for the Account -
1:aa4dd7c:              * deduct the Order cost from the Account balance
1:aa4dd7c:              */
1:aa4dd7c: 
1:aa4dd7c:             newHolding = createHolding(account, quote, quantity, price, entityManager);
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         try {
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c: 
1:aa4dd7c:             if (newHolding != null) {
1:aa4dd7c:                 order.setHolding(newHolding);
1:aa4dd7c:             }
1:aa4dd7c: 
1:aa4dd7c:             if (order.isSell()) {
1:aa4dd7c:                 /*
1:aa4dd7c:                  * Complete a Sell operation - remove the Holding from the Account -
1:aa4dd7c:                  * deposit the Order proceeds to the Account balance
1:aa4dd7c:                  */
1:aa4dd7c:                 if (holding == null) {
1:aa4dd7c:                     Log.error("TradeJpaAm:completeOrder -- Unable to sell order " + order.getOrderID() + " holding already sold");
1:aa4dd7c:                     order.cancel();
1:aa4dd7c:                     entityManager.getTransaction().commit();
1:aa4dd7c:                     return order;
1:aa4dd7c:                 }
1:aa4dd7c:                 else {
1:aa4dd7c:                     entityManager.remove(holding);
1:aa4dd7c:                     order.setHolding(null);
1:aa4dd7c:                 }
1:aa4dd7c:             }
1:aa4dd7c: 
1:aa4dd7c:             order.setOrderStatus("closed");
1:aa4dd7c: 
1:aa4dd7c:             order.setCompletionDate(new java.sql.Timestamp(System.currentTimeMillis()));
1:aa4dd7c: 
1:aa4dd7c:             if (Log.doTrace())
1:aa4dd7c:                 Log.trace("TradeJpaAm:completeOrder--> Completed Order "
1:aa4dd7c:                           + order.getOrderID() + "\n\t Order info: " + order
1:aa4dd7c:                           + "\n\t Account info: " + account + "\n\t Quote info: "
1:aa4dd7c:                           + quote + "\n\t Holding info: " + holding);
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             e.printStackTrace();
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (entityManager != null) {
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         return order;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public void cancelOrder(Integer orderID, boolean twoPhase) {
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:cancelOrder", orderID + " twoPhase=" + twoPhase);
1:aa4dd7c: 
1:aa4dd7c:         OrderDataBeanImpl order = entityManager.find(OrderDataBeanImpl.class, orderID);
1:aa4dd7c:         /*
1:aa4dd7c:          * managed transaction
1:aa4dd7c:          */
1:aa4dd7c:         try {
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             order.cancel();
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c:         entityManager.close();
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public void orderCompleted(String userID, Integer orderID) {
1:aa4dd7c:         if (Log.doActionTrace())
1:aa4dd7c:             Log.trace("TradeAction:orderCompleted", userID, orderID);
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("OrderCompleted", userID, orderID);
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public Collection<OrderDataBean> getOrders(String userID) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getOrders", userID);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c:         AccountDataBean account = profile.getAccount();
1:aa4dd7c:         entityManager.close();
1:aa4dd7c:         return account.getOrders();
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public Collection<OrderDataBean> getClosedOrders(String userID) {
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getClosedOrders", userID);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         try {
1:aa4dd7c: 
1:aa4dd7c:             // Get the primary keys for all the closed Orders for this
1:aa4dd7c:             // account.
1:aa4dd7c:             /*
1:aa4dd7c:              * managed transaction
1:aa4dd7c:              */
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             Query query = entityManager.createNamedQuery("orderejb.closedOrders");
1:aa4dd7c:             query.setParameter("userID", userID);
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:             Collection results = query.getResultList();
1:aa4dd7c:             Iterator itr = results.iterator();
1:aa4dd7c:             // Spin through the orders to populate the lazy quote fields
1:aa4dd7c:             while (itr.hasNext()) {
1:aa4dd7c:                 OrderDataBeanImpl thisOrder = (OrderDataBeanImpl) itr.next();
1:aa4dd7c:                 thisOrder.getQuote();
1:aa4dd7c:             }
1:aa4dd7c: 
1:aa4dd7c:             if (TradeConfig.jpaLayer == TradeConfig.OPENJPA) {
1:aa4dd7c:                 Query updateStatus = entityManager.createNamedQuery("orderejb.completeClosedOrders");
1:aa4dd7c:                 /*
1:aa4dd7c:                  * managed transaction
1:aa4dd7c:                  */
1:aa4dd7c:                 try {
1:aa4dd7c:                     entityManager.getTransaction().begin();
1:aa4dd7c:                     updateStatus.setParameter("userID", userID);
1:aa4dd7c: 
1:aa4dd7c:                     updateStatus.executeUpdate();
1:aa4dd7c:                     entityManager.getTransaction().commit();
1:aa4dd7c:                 }
1:aa4dd7c:                 catch (Exception e) {
1:aa4dd7c:                     entityManager.getTransaction().rollback();
1:aa4dd7c:                     entityManager.close();
1:aa4dd7c:                     entityManager = null;
1:aa4dd7c:                 }
1:aa4dd7c:             }
1:aa4dd7c:             else if (TradeConfig.jpaLayer == TradeConfig.HIBERNATE) {
1:aa4dd7c:                 /*
1:aa4dd7c:                  * Add logic to do update orders operation, because JBoss5'
1:aa4dd7c:                  * Hibernate 3.3.1GA DB2Dialect and MySQL5Dialect do not work
1:aa4dd7c:                  * with annotated query "orderejb.completeClosedOrders" defined
1:aa4dd7c:                  * in OrderDatabean
1:aa4dd7c:                  */
1:aa4dd7c:                 Query findaccountid = entityManager.createNativeQuery(
1:aa4dd7c:                                                         "select "
1:aa4dd7c:                                                         + "a.ACCOUNTID, "
1:aa4dd7c:                                                         + "a.LOGINCOUNT, "
1:aa4dd7c:                                                         + "a.LOGOUTCOUNT, "
1:aa4dd7c:                                                         + "a.LASTLOGIN, "
1:aa4dd7c:                                                         + "a.CREATIONDATE, "
1:aa4dd7c:                                                         + "a.BALANCE, "
1:aa4dd7c:                                                         + "a.OPENBALANCE, "
1:aa4dd7c:                                                         + "a.PROFILE_USERID "
1:aa4dd7c:                                                         + "from accountejb a where a.profile_userid = ?",
1:3364e3f:                                                         org.apache.aries.samples.ariestrader.entities.AccountDataBeanImpl.class);
1:aa4dd7c:                 findaccountid.setParameter(1, userID);
1:aa4dd7c:                 AccountDataBeanImpl account = (AccountDataBeanImpl) findaccountid.getSingleResult();
1:aa4dd7c:                 Integer accountid = account.getAccountID();
1:aa4dd7c:                 Query updateStatus = entityManager.createNativeQuery("UPDATE orderejb o SET o.orderStatus = 'completed' WHERE "
1:aa4dd7c:                                                                      + "o.orderStatus = 'closed' AND o.ACCOUNT_ACCOUNTID  = ?");
1:aa4dd7c:                 updateStatus.setParameter(1, accountid.intValue());
1:aa4dd7c:                 updateStatus.executeUpdate();
1:aa4dd7c:             }
1:aa4dd7c:             if (entityManager != null) {
1:aa4dd7c:                 entityManager.close();
1:aa4dd7c:                 entityManager = null;
1:aa4dd7c:             }
1:aa4dd7c:             return results;
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm.getClosedOrders", e);
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:             throw new RuntimeException(
1:aa4dd7c:                                       "TradeJpaAm.getClosedOrders - error", e);
1:aa4dd7c: 
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public QuoteDataBean createQuote(String symbol, String companyName, BigDecimal price) {
1:aa4dd7c: 
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c:         try {
1:aa4dd7c:             QuoteDataBeanImpl quote = new QuoteDataBeanImpl(symbol, companyName, 0, price, price, price, price, 0);
1:aa4dd7c:             /*
1:aa4dd7c:              * managed transaction
1:aa4dd7c:              */
1:aa4dd7c:             try {
1:aa4dd7c:                 entityManager.getTransaction().begin();
1:aa4dd7c:                 entityManager.persist(quote);
1:aa4dd7c:                 entityManager.getTransaction().commit();
1:aa4dd7c:             }
1:aa4dd7c:             catch (Exception e) {
1:aa4dd7c:                 entityManager.getTransaction().rollback();
1:aa4dd7c:             }
1:aa4dd7c: 
1:aa4dd7c:             if (Log.doTrace())
1:aa4dd7c:                 Log.trace("TradeJpaAm:createQuote-->" + quote);
1:aa4dd7c: 
1:aa4dd7c:             if (entityManager != null) {
1:aa4dd7c:                 entityManager.close();
1:aa4dd7c:                 entityManager = null;
1:aa4dd7c:             }
1:aa4dd7c:             return quote;
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm:createQuote -- exception creating Quote", e);
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:             throw new RuntimeException(e);
1:aa4dd7c:         }
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public QuoteDataBean getQuote(String symbol) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getQuote", symbol);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         QuoteDataBeanImpl qdb = entityManager.find(QuoteDataBeanImpl.class, symbol);
1:aa4dd7c: 
1:aa4dd7c:         if (entityManager != null) {
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c:         return qdb;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public Collection<QuoteDataBean> getAllQuotes() {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getAllQuotes");
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         Query query = entityManager.createNamedQuery("quoteejb.allQuotes");
1:aa4dd7c: 
1:aa4dd7c:         if (entityManager != null) {
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c: 
1:aa4dd7c:         }
1:aa4dd7c:         return query.getResultList();
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public QuoteDataBean updateQuotePriceVolume(String symbol,
1:aa4dd7c:                                                 BigDecimal changeFactor, double sharesTraded) {
1:aa4dd7c:         if (!TradeConfig.getUpdateQuotePrices()) {
1:aa4dd7c:             return new QuoteDataBeanImpl();
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:updateQuote", symbol, changeFactor);
1:aa4dd7c: 
1:aa4dd7c:         /*
1:aa4dd7c:          * Add logic to determine JPA layer, because JBoss5' Hibernate 3.3.1GA
1:aa4dd7c:          * DB2Dialect and MySQL5Dialect do not work with annotated query
1:aa4dd7c:          * "quoteejb.quoteForUpdate" defined in QuoteDataBeanImpl
1:aa4dd7c:          */
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c:         QuoteDataBeanImpl quote = null;
1:aa4dd7c:         if (TradeConfig.jpaLayer == TradeConfig.HIBERNATE) {
1:aa4dd7c:             quote = entityManager.find(QuoteDataBeanImpl.class, symbol);
1:aa4dd7c:         } else if (TradeConfig.jpaLayer == TradeConfig.OPENJPA) {
1:aa4dd7c:   
1:aa4dd7c:             Query q = entityManager.createNamedQuery("quoteejb.quoteForUpdate");
1:aa4dd7c:             q.setParameter(1, symbol);
1:aa4dd7c:   
1:aa4dd7c:             quote = (QuoteDataBeanImpl) q.getSingleResult();
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         BigDecimal oldPrice = quote.getPrice();
1:aa4dd7c: 
1:aa4dd7c:         if (quote.getPrice().equals(TradeConfig.PENNY_STOCK_PRICE)) {
1:aa4dd7c:             changeFactor = TradeConfig.PENNY_STOCK_RECOVERY_MIRACLE_MULTIPLIER;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         BigDecimal newPrice = changeFactor.multiply(oldPrice).setScale(2, BigDecimal.ROUND_HALF_UP);
1:aa4dd7c: 
1:aa4dd7c:         /*
1:aa4dd7c:          * managed transaction
1:aa4dd7c:          */
1:aa4dd7c: 
1:aa4dd7c:         try {
1:aa4dd7c: 
1:aa4dd7c:             quote.setPrice(newPrice);
1:aa4dd7c:             quote.setVolume(quote.getVolume() + sharesTraded);
1:aa4dd7c:             quote.setChange((newPrice.subtract(quote.getOpen()).doubleValue()));
1:d24b46e:             if (newPrice.compareTo(quote.getHigh()) == 1) quote.setHigh(newPrice);
1:d24b46e:             else if (newPrice.compareTo(quote.getLow()) == -1) quote.setLow(newPrice);
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             entityManager.merge(quote);
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (entityManager != null) {
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         this.publishQuotePriceChange(quote, oldPrice, changeFactor, sharesTraded);
1:aa4dd7c: 
1:aa4dd7c:         return quote;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public Collection<HoldingDataBean> getHoldings(String userID) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getHoldings", userID);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c:         /*
1:aa4dd7c:          * managed transaction
1:aa4dd7c:          */
1:aa4dd7c:         entityManager.getTransaction().begin();
1:aa4dd7c: 
1:aa4dd7c:         Query query = entityManager.createNamedQuery("holdingejb.holdingsByUserID");
1:aa4dd7c:         query.setParameter("userID", userID);
1:aa4dd7c: 
1:aa4dd7c:         entityManager.getTransaction().commit();
1:aa4dd7c:         Collection<HoldingDataBean> holdings = query.getResultList();
1:aa4dd7c:         /*
1:b8c0170:          * Inflate the lazy data members
1:aa4dd7c:          */
1:aa4dd7c:         Iterator itr = holdings.iterator();
1:aa4dd7c:         while (itr.hasNext()) {
1:aa4dd7c:             ((HoldingDataBean) itr.next()).getQuote();
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         entityManager.close();
1:aa4dd7c:         entityManager = null;
1:aa4dd7c:         return holdings;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public HoldingDataBean getHolding(Integer holdingID) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getHolding", holdingID);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c:         return entityManager.find(HoldingDataBeanImpl.class, holdingID);
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public AccountDataBean getAccountData(String userID) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getAccountData", userID);
1:aa4dd7c: 
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c:         /*
2:aa4dd7c:          * Inflate the lazy data memebers
1:aa4dd7c:          */
1:aa4dd7c:         AccountDataBean account = profile.getAccount();
1:aa4dd7c:         account.getProfile();
1:aa4dd7c: 
1:aa4dd7c:         // Added to populate transient field for account
1:aa4dd7c:         account.setProfileID(profile.getUserID());
1:aa4dd7c:         entityManager.close();
1:aa4dd7c:         entityManager = null;
1:aa4dd7c: 
1:aa4dd7c:         return account;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public AccountProfileDataBean getAccountProfileData(String userID) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:getProfileData", userID);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         AccountProfileDataBeanImpl apb = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c:         entityManager.close();
1:aa4dd7c:         entityManager = null;
1:aa4dd7c:         return apb;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public AccountProfileDataBean updateAccountProfile(String userID, String password, String fullName, String address, String email, String creditcard) throws Exception {
1:aa4dd7c: 
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:updateAccountProfileData", userID);
1:aa4dd7c:         /*
1:aa4dd7c:          * // Retrieve the previous account profile in order to get account
1:aa4dd7c:          * data... hook it into new object AccountProfileDataBean temp =
1:aa4dd7c:          * entityManager.find(AccountProfileDataBean.class,
1:aa4dd7c:          * profileData.getUserID()); // In order for the object to merge
1:aa4dd7c:          * correctly, the account has to be hooked into the temp object... // -
1:aa4dd7c:          * may need to reverse this and obtain the full object first
1:aa4dd7c:          * 
1:aa4dd7c:          * profileData.setAccount(temp.getAccount());
1:aa4dd7c:          * 
1:aa4dd7c:          * //TODO this might not be correct temp =
1:aa4dd7c:          * entityManager.merge(profileData); //System.out.println(temp);
1:aa4dd7c:          */
1:aa4dd7c: 
1:aa4dd7c:         AccountProfileDataBeanImpl temp = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c:         temp.setAddress(address);
1:aa4dd7c:         temp.setPassword(password);
1:aa4dd7c:         temp.setFullName(fullName);
1:aa4dd7c:         temp.setCreditCard(creditcard);
1:aa4dd7c:         temp.setEmail(email);
1:aa4dd7c:         /*
1:aa4dd7c:          * Managed Transaction
1:aa4dd7c:          */
1:aa4dd7c:         try {
1:aa4dd7c: 
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             entityManager.merge(temp);
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         return temp;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public AccountDataBean login(String userID, String password)
1:aa4dd7c:     throws Exception {
1:aa4dd7c: 
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c: 
1:aa4dd7c:         if (profile == null) {
1:aa4dd7c:             throw new RuntimeException("No such user: " + userID);
1:aa4dd7c:         }
1:aa4dd7c:         /*
1:aa4dd7c:          * Managed Transaction
1:aa4dd7c:          */
1:aa4dd7c:         entityManager.getTransaction().begin();
1:aa4dd7c:         entityManager.merge(profile);
1:aa4dd7c: 
1:aa4dd7c:         AccountDataBean account = profile.getAccount();
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:login", userID, password);
1:aa4dd7c: 
1:aa4dd7c:         account.login(password);
1:aa4dd7c:         entityManager.getTransaction().commit();
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:login(" + userID + "," + password + ") success" + account);
1:aa4dd7c:         entityManager.close();
1:aa4dd7c:         return account;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public void logout(String userID) {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:logout", userID);
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c:         AccountDataBean account = profile.getAccount();
1:aa4dd7c: 
1:aa4dd7c:         /*
1:aa4dd7c:          * Managed Transaction
1:aa4dd7c:          */
1:aa4dd7c:         try {
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             account.logout();
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:logout(" + userID + ") success");
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public AccountDataBean register(String userID, String password, String fullname, 
1:aa4dd7c:                                     String address, String email, String creditcard,
1:aa4dd7c:                                     BigDecimal openBalance) {
1:aa4dd7c:         AccountDataBeanImpl account = null;
1:aa4dd7c:         AccountProfileDataBeanImpl profile = null;
1:aa4dd7c:         EntityManager entityManager = emf.createEntityManager();
1:aa4dd7c: 
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:register", userID, password, fullname, address, email, creditcard, openBalance);
1:aa4dd7c: 
1:aa4dd7c:         // Check to see if a profile with the desired userID already exists
1:aa4dd7c: 
1:aa4dd7c:         profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:aa4dd7c: 
1:aa4dd7c:         if (profile != null) {
1:aa4dd7c:             Log.error("Failed to register new Account - AccountProfile with userID(" + userID + ") already exists");
1:aa4dd7c:             return null;
1:aa4dd7c:         }
1:aa4dd7c:         else {
1:aa4dd7c:             profile = new AccountProfileDataBeanImpl(userID, password, fullname,
1:aa4dd7c:                                                  address, email, creditcard);
1:aa4dd7c:             account = new AccountDataBeanImpl(0, 0, null, new Timestamp(System.currentTimeMillis()), openBalance, openBalance, userID);
1:aa4dd7c:             profile.setAccount((AccountDataBean)account);
1:aa4dd7c:             account.setProfile((AccountProfileDataBean)profile);
1:aa4dd7c:             /*
1:aa4dd7c:              * managed Transaction
1:aa4dd7c:              */
1:aa4dd7c:             try {
1:aa4dd7c:                 entityManager.getTransaction().begin();
1:aa4dd7c:                 entityManager.persist(profile);
1:aa4dd7c:                 entityManager.persist(account);
1:aa4dd7c:                 entityManager.getTransaction().commit();
1:aa4dd7c:             }
1:aa4dd7c:             catch (Exception e) {
1:aa4dd7c:                 entityManager.getTransaction().rollback();
1:aa4dd7c:                 entityManager.close();
1:aa4dd7c:                 entityManager = null;
1:aa4dd7c:             }
1:aa4dd7c:         }
1:aa4dd7c: 
1:aa4dd7c: 
1:aa4dd7c:         return account;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     /*
1:aa4dd7c:      * NO LONGER USE
1:aa4dd7c:      */
1:aa4dd7c: 
1:aa4dd7c:     private void publishQuotePriceChange(QuoteDataBean quote,
1:aa4dd7c:                                          BigDecimal oldPrice, BigDecimal changeFactor, double sharesTraded) {
1:aa4dd7c:         if (!TradeConfig.getPublishQuotePriceChange())
1:aa4dd7c:             return;
1:aa4dd7c:         Log.error("TradeJpaAm:publishQuotePriceChange - is not implemented for this runtime mode");
1:aa4dd7c:         throw new UnsupportedOperationException("TradeJpaAm:publishQuotePriceChange - is not implemented for this runtime mode");
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     /*
1:aa4dd7c:      * new Method() that takes EntityManager as a parameter
1:aa4dd7c:      */
1:aa4dd7c:     private OrderDataBean createOrder(AccountDataBean account,
1:aa4dd7c:                                       QuoteDataBean quote, HoldingDataBean holding, String orderType,
1:aa4dd7c:                                       double quantity, EntityManager entityManager) {
1:aa4dd7c:         OrderDataBeanImpl order;
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:createOrder(orderID=" + " account="
1:aa4dd7c:                       + ((account == null) ? null : account.getAccountID())
1:aa4dd7c:                       + " quote=" + ((quote == null) ? null : quote.getSymbol())
1:aa4dd7c:                       + " orderType=" + orderType + " quantity=" + quantity);
1:aa4dd7c:         try {
1:aa4dd7c:             order = new OrderDataBeanImpl(orderType, 
1:aa4dd7c:                                       "open", 
1:aa4dd7c:                                       new Timestamp(System.currentTimeMillis()), 
1:aa4dd7c:                                       null, 
1:aa4dd7c:                                       quantity, 
1:aa4dd7c:                                       quote.getPrice().setScale(FinancialUtils.SCALE, FinancialUtils.ROUND),
1:aa4dd7c:                                       TradeConfig.getOrderFee(orderType), 
1:aa4dd7c:                                       account, 
1:aa4dd7c:                                       quote, 
1:aa4dd7c:                                       holding);
1:aa4dd7c:                 entityManager.persist(order);
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             Log.error("TradeJpaAm:createOrder -- failed to create Order", e);
1:aa4dd7c:             throw new RuntimeException("TradeJpaAm:createOrder -- failed to create Order", e);
1:aa4dd7c:         }
1:aa4dd7c:         return order;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     private HoldingDataBean createHolding(AccountDataBean account,
1:aa4dd7c:                                           QuoteDataBean quote, double quantity, BigDecimal purchasePrice,
1:aa4dd7c:                                           EntityManager entityManager) throws Exception {
1:aa4dd7c:         HoldingDataBeanImpl newHolding = new HoldingDataBeanImpl(quantity,
1:aa4dd7c:                                                          purchasePrice, new Timestamp(System.currentTimeMillis()),
1:aa4dd7c:                                                          account, quote);
1:aa4dd7c:         try {
1:aa4dd7c:             /*
1:aa4dd7c:              * manage transactions
1:aa4dd7c:              */
1:aa4dd7c:             entityManager.getTransaction().begin();
1:aa4dd7c:             entityManager.persist(newHolding);
1:aa4dd7c:             entityManager.getTransaction().commit();
1:aa4dd7c:         }
1:aa4dd7c:         catch (Exception e) {
1:aa4dd7c:             entityManager.getTransaction().rollback();
1:aa4dd7c:             entityManager.close();
1:aa4dd7c:             entityManager = null;
1:aa4dd7c:         }
1:aa4dd7c:         return newHolding;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public double investmentReturn(double investment, double NetValue)
1:aa4dd7c:     throws Exception {
1:aa4dd7c:         if (Log.doTrace())
1:aa4dd7c:             Log.trace("TradeJpaAm:investmentReturn");
1:aa4dd7c: 
1:aa4dd7c:         double diff = NetValue - investment;
1:aa4dd7c:         double ir = diff / investment;
1:aa4dd7c:         return ir;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     public QuoteDataBean pingTwoPhase(String symbol) throws Exception {
1:aa4dd7c:         Log
1:aa4dd7c:         .error("TradeJpaAm:pingTwoPhase - is not implemented for this runtime mode");
1:aa4dd7c:         throw new UnsupportedOperationException("TradeJpaAm:pingTwoPhase - is not implemented for this runtime mode");
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     class quotePriceComparator implements java.util.Comparator {
1:aa4dd7c:         public int compare(Object quote1, Object quote2) {
1:aa4dd7c:             double change1 = ((QuoteDataBean) quote1).getChange();
1:aa4dd7c:             double change2 = ((QuoteDataBean) quote2).getChange();
1:aa4dd7c:             return new Double(change2).compareTo(change1);
1:aa4dd7c:         }
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c:     /**
1:aa4dd7c:      * Get mode - returns the persistence mode (TradeConfig.JPA)
1:aa4dd7c:      * 
1:8ef753d:      * @return TradeConfig.ModeType
1:aa4dd7c:      */
1:8ef753d:     public TradeConfig.ModeType getMode() {
1:8ef753d:         return TradeConfig.ModeType.JPA_AM;
1:aa4dd7c:     }
1:aa4dd7c: 
1:aa4dd7c: }
============================================================================
author:Joseph Alan Bohn
-------------------------------------------------------------------------------
commit:8ef753d
/////////////////////////////////////////////////////////////////////////
1:      * @return TradeConfig.ModeType
1:     public TradeConfig.ModeType getMode() {
1:         return TradeConfig.ModeType.JPA_AM;
commit:39f53f6
commit:d24b46e
/////////////////////////////////////////////////////////////////////////
1:             if (newPrice.compareTo(quote.getHigh()) == 1) quote.setHigh(newPrice);
1:             else if (newPrice.compareTo(quote.getLow()) == -1) quote.setLow(newPrice);
commit:b8c0170
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
1:         // after the purchase or sale of a stock, update the stocks volume and
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
1:          * Inflate the lazy data members
commit:1f8e5bb
/////////////////////////////////////////////////////////////////////////
1: package org.apache.aries.samples.ariestrader.persist.jpa.am;
commit:880e087
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.samples.ariestrader.api.persistence.AccountDataBean;
1: import org.apache.aries.samples.ariestrader.api.persistence.AccountProfileDataBean;
1: import org.apache.aries.samples.ariestrader.api.persistence.HoldingDataBean;
1: import org.apache.aries.samples.ariestrader.api.persistence.MarketSummaryDataBean;
1: import org.apache.aries.samples.ariestrader.api.persistence.OrderDataBean;
1: import org.apache.aries.samples.ariestrader.api.persistence.QuoteDataBean;
commit:b29ad20
/////////////////////////////////////////////////////////////////////////
1:                 entityManager.getTransaction().commit();
1: 
1: 
commit:989ba4e
commit:3364e3f
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.samples.ariestrader.entities.AccountDataBeanImpl;
1: import org.apache.aries.samples.ariestrader.entities.AccountProfileDataBeanImpl;
1: import org.apache.aries.samples.ariestrader.entities.HoldingDataBeanImpl;
1: import org.apache.aries.samples.ariestrader.entities.OrderDataBeanImpl;
1: import org.apache.aries.samples.ariestrader.entities.QuoteDataBeanImpl;
/////////////////////////////////////////////////////////////////////////
1:                                                         org.apache.aries.samples.ariestrader.entities.AccountDataBeanImpl.class);
commit:012ec29
/////////////////////////////////////////////////////////////////////////
1: //    @PersistenceUnit(unitName="ariestrader-am")
/////////////////////////////////////////////////////////////////////////
1:     public void setEmf (EntityManagerFactory emf) { 
1:         this.emf = emf;
commit:61d7f67
/////////////////////////////////////////////////////////////////////////
0: package org.apache.aries.samples.ariestrader.persist.jpa;
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.samples.ariestrader.api.TradeServices;
0: import org.apache.aries.samples.ariestrader.beans.AccountDataBeanImpl;
0: import org.apache.aries.samples.ariestrader.beans.AccountProfileDataBeanImpl;
0: import org.apache.aries.samples.ariestrader.beans.HoldingDataBeanImpl;
0: import org.apache.aries.samples.ariestrader.beans.OrderDataBeanImpl;
0: import org.apache.aries.samples.ariestrader.beans.QuoteDataBeanImpl;
0: import org.apache.aries.samples.ariestrader.persistence.api.AccountDataBean;
0: import org.apache.aries.samples.ariestrader.persistence.api.AccountProfileDataBean;
0: import org.apache.aries.samples.ariestrader.persistence.api.HoldingDataBean;
0: import org.apache.aries.samples.ariestrader.persistence.api.MarketSummaryDataBean;
0: import org.apache.aries.samples.ariestrader.persistence.api.OrderDataBean;
0: import org.apache.aries.samples.ariestrader.persistence.api.QuoteDataBean;
1: import org.apache.aries.samples.ariestrader.util.FinancialUtils;
1: import org.apache.aries.samples.ariestrader.util.Log;
1: import org.apache.aries.samples.ariestrader.util.TradeConfig;
/////////////////////////////////////////////////////////////////////////
1:  * org.apache.aries.samples.ariestrader.TradeServices}
1:  * @see org.apache.aries.samples.ariestrader.TradeServices
0:     @PersistenceUnit(unitName="ariestrader-am")
/////////////////////////////////////////////////////////////////////////
0:                                                         org.apache.aries.samples.ariestrader.beans.AccountDataBeanImpl.class);
commit:4eb010a
commit:aa4dd7c
/////////////////////////////////////////////////////////////////////////
1: /**
1:  *  Licensed to the Apache Software Foundation (ASF) under one or more
1:  *  contributor license agreements.  See the NOTICE file distributed with
1:  *  this work for additional information regarding copyright ownership.
1:  *  The ASF licenses this file to You under the Apache License, Version 2.0
1:  *  (the "License"); you may not use this file except in compliance with
1:  *  the License.  You may obtain a copy of the License at
1:  *
1:  *     http://www.apache.org/licenses/LICENSE-2.0
1:  *
1:  *  Unless required by applicable law or agreed to in writing, software
1:  *  distributed under the License is distributed on an "AS IS" BASIS,
1:  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
1:  *  See the License for the specific language governing permissions and
1:  *  limitations under the License.
1:  */
0: package org.apache.geronimo.samples.daytrader.persist.jpa;
1: 
1: import java.math.BigDecimal;
1: import java.sql.Timestamp;
1: import java.util.ArrayList;
1: import java.util.Collection;
1: import java.util.Iterator;
1: 
1: import javax.persistence.EntityManager;
1: import javax.persistence.EntityManagerFactory;
0: import javax.persistence.Persistence;
0: import javax.persistence.PersistenceUnit;
1: import javax.persistence.Query;
1: 
0: import org.apache.geronimo.samples.daytrader.api.TradeServices;
0: import org.apache.geronimo.samples.daytrader.beans.AccountDataBeanImpl;
0: import org.apache.geronimo.samples.daytrader.beans.AccountProfileDataBeanImpl;
0: import org.apache.geronimo.samples.daytrader.beans.HoldingDataBeanImpl;
0: import org.apache.geronimo.samples.daytrader.beans.OrderDataBeanImpl;
0: import org.apache.geronimo.samples.daytrader.beans.QuoteDataBeanImpl;
0: import org.apache.geronimo.samples.daytrader.persistence.api.AccountDataBean;
0: import org.apache.geronimo.samples.daytrader.persistence.api.AccountProfileDataBean;
0: import org.apache.geronimo.samples.daytrader.persistence.api.HoldingDataBean;
0: import org.apache.geronimo.samples.daytrader.persistence.api.MarketSummaryDataBean;
0: import org.apache.geronimo.samples.daytrader.persistence.api.OrderDataBean;
0: import org.apache.geronimo.samples.daytrader.persistence.api.QuoteDataBean;
0: import org.apache.geronimo.samples.daytrader.util.FinancialUtils;
0: import org.apache.geronimo.samples.daytrader.util.Log;
0: import org.apache.geronimo.samples.daytrader.util.TradeConfig;
1: 
1: /**
1:  * TradeJpaAm uses JPA via a Application Managed (AM)
1:  * entity managers to implement the business methods of the
1:  * Trade online broker application. These business methods
1:  * represent the features and operations that can be performed
1:  * by customers of the brokerage such as login, logout, get a
1:  * stock quote, buy or sell a stock, etc. and are specified in
1:  * the {@link
0:  * org.apache.geronimo.samples.daytrader.TradeServices}
1:  * interface
1:  * 
0:  * @see org.apache.geronimo.samples.daytrader.TradeServices
1:  * 
1:  */
1: 
1: public class TradeJpaAm implements TradeServices {
1: 
0:     @PersistenceUnit(unitName="daytrader-am")
1:     private static EntityManagerFactory emf;
1: 
0:     private static BigDecimal ZERO = new BigDecimal(0.0);
1: 
1:     private static boolean initialized = false;
1: 
1:     /**
1:      * Zero arg constructor for TradeJpaAm
1:      */
1:     public TradeJpaAm() {
1:     }
1: 
0:     public void setEmf (EntityManagerFactory em) { 
0:         emf = em;
1:     }
1: 
1:     public void init() {
1:         if (initialized)
1:             return;
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:init -- *** initializing");
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:init -- +++ initialized");
1: 
1:         initialized = true;
1:     }
1: 
1:     public void destroy() {
1:         try {
1:             if (!initialized)
1:                 return;
1:             Log.trace("TradeJpaAm:destroy");
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm:destroy", e);
1:         }
1: 
1:     }
1: 
1:     public MarketSummaryDataBean getMarketSummary() {
1:         MarketSummaryDataBean marketSummaryData;
1: 
1:         /*
1:          * Creating entiManager
1:          */
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         try {
1:             if (Log.doTrace())
1:                 Log.trace("TradeJpaAm:getMarketSummary -- getting market summary");
1: 
1:             // Find Trade Stock Index Quotes (Top 100 quotes)
1:             // ordered by their change in value
1:             Collection<QuoteDataBean> quotes;
1: 
1:             Query query = entityManager.createNamedQuery("quoteejb.quotesByChange");
1:             quotes = query.getResultList();
1: 
1:             QuoteDataBean[] quoteArray = (QuoteDataBean[]) quotes.toArray(new QuoteDataBean[quotes.size()]);
1:             ArrayList<QuoteDataBean> topGainers = new ArrayList<QuoteDataBean>(
1:                                                                               5);
1:             ArrayList<QuoteDataBean> topLosers = new ArrayList<QuoteDataBean>(5);
1:             BigDecimal TSIA = FinancialUtils.ZERO;
1:             BigDecimal openTSIA = FinancialUtils.ZERO;
1:             double totalVolume = 0.0;
1: 
1:             if (quoteArray.length > 5) {
1:                 for (int i = 0; i < 5; i++)
1:                     topGainers.add(quoteArray[i]);
1:                 for (int i = quoteArray.length - 1; i >= quoteArray.length - 5; i--)
1:                     topLosers.add(quoteArray[i]);
1: 
1:                 for (QuoteDataBean quote : quoteArray) {
1:                     BigDecimal price = quote.getPrice();
1:                     BigDecimal open = quote.getOpen();
1:                     double volume = quote.getVolume();
1:                     TSIA = TSIA.add(price);
1:                     openTSIA = openTSIA.add(open);
1:                     totalVolume += volume;
1:                 }
1:                 TSIA = TSIA.divide(new BigDecimal(quoteArray.length),
1:                                    FinancialUtils.ROUND);
1:                 openTSIA = openTSIA.divide(new BigDecimal(quoteArray.length),
1:                                            FinancialUtils.ROUND);
1:             }
1: 
1:             marketSummaryData = new MarketSummaryDataBean(TSIA, openTSIA,
1:                                                           totalVolume, topGainers, topLosers);
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm:getMarketSummary", e);
1:             throw new RuntimeException("TradeJpaAm:getMarketSummary -- error ", e);
1:         }
1:         /*
1:          * closing entitymanager
1:          */
1:         entityManager.close();
1: 
1:         return marketSummaryData;
1:     }
1: 
1:     public OrderDataBean buy(String userID, String symbol, double quantity, int orderProcessingMode) {
1:         OrderDataBean order = null;
1:         BigDecimal total;
1:         /*
1:          * creating entitymanager
1:          */
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         try {
1:             if (Log.doTrace())
1:                 Log.trace("TradeJpaAm:buy", userID, symbol, quantity, orderProcessingMode);
1: 
1:             entityManager.getTransaction().begin();
1: 
1:             AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:             AccountDataBean account = profile.getAccount();
1: 
1:             QuoteDataBeanImpl quote = entityManager.find(QuoteDataBeanImpl.class, symbol);
1: 
1:             HoldingDataBeanImpl holding = null; // The holding will be created by this buy order
1: 
1:             order = createOrder( account, (QuoteDataBean) quote, (HoldingDataBean) holding, "buy", quantity, entityManager);
1: 
1:             // order = createOrder(account, quote, holding, "buy", quantity);
1:             // UPDATE - account should be credited during completeOrder
1: 
1:             BigDecimal price = quote.getPrice();
1:             BigDecimal orderFee = order.getOrderFee();
1:             BigDecimal balance = account.getBalance();
1:             total = (new BigDecimal(quantity).multiply(price)).add(orderFee);
1:             account.setBalance(balance.subtract(total));
1: 
1:             // commit the transaction before calling completeOrder
1:             entityManager.getTransaction().commit();
1: 
1:             if (orderProcessingMode == TradeConfig.SYNCH)
1:                 completeOrder(order.getOrderID(), false);
1:             else if (orderProcessingMode == TradeConfig.ASYNCH_2PHASE)
1:                 queueOrder(order.getOrderID(), true);
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm:buy(" + userID + "," + symbol + "," + quantity + ") --> failed", e);
1:             /* On exception - cancel the order */
1:             // TODO figure out how to do this with JPA
1:             if (order != null)
1:                 order.cancel();
1: 
1:             entityManager.getTransaction().rollback();
1: 
1:             // throw new EJBException(e);
1:             throw new RuntimeException(e);
1:         }
1:         if (entityManager != null) {
1:             entityManager.close();
1:             entityManager = null;
1:         }
1: 
0:         // after the purchase or sell of a stock, update the stocks volume and
1:         // price
1:         updateQuotePriceVolume(symbol, TradeConfig.getRandomPriceChangeFactor(), quantity);
1: 
1:         return order;
1:     }
1: 
1:     public OrderDataBean sell(String userID, Integer holdingID,
1:                               int orderProcessingMode) {
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         OrderDataBean order = null;
1:         BigDecimal total;
1:         try {
1:             entityManager.getTransaction().begin();
1:             if (Log.doTrace())
1:                 Log.trace("TradeJpaAm:sell", userID, holdingID, orderProcessingMode);
1: 
1:             AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1: 
1:             AccountDataBean account = profile.getAccount();
1:             HoldingDataBeanImpl holding = entityManager.find(HoldingDataBeanImpl.class, holdingID);
1: 
1:             if (holding == null) {
1:                 Log.error("TradeJpaAm:sell User " + userID
1:                           + " attempted to sell holding " + holdingID
1:                           + " which has already been sold");
1: 
1:                 OrderDataBean orderData = new OrderDataBeanImpl();
1:                 orderData.setOrderStatus("cancelled");
1: 
1:                 entityManager.persist(orderData);
1: 
1:                 if (entityManager != null) {
1:                     entityManager.close();
1:                     entityManager = null;
1: 
1:                 }
1:                 entityManager.getTransaction().commit();
1:                 return orderData;
1:             }
1: 
1:             QuoteDataBean quote = holding.getQuote();
1:             double quantity = holding.getQuantity();
1: 
1:             order = createOrder(account, quote, holding, "sell", quantity,
1:                                 entityManager);
1:             // UPDATE the holding purchase data to signify this holding is
1:             // "inflight" to be sold
1:             // -- could add a new holdingStatus attribute to holdingEJB
1:             holding.setPurchaseDate(new java.sql.Timestamp(0));
1: 
1:             // UPDATE - account should be credited during completeOrder
1:             BigDecimal price = quote.getPrice();
1:             BigDecimal orderFee = order.getOrderFee();
1:             BigDecimal balance = account.getBalance();
1:             total = (new BigDecimal(quantity).multiply(price)).subtract(orderFee);
1: 
1:             account.setBalance(balance.add(total));
1: 
1:             // commit the transaction before calling completeOrder
1:             entityManager.getTransaction().commit();
1: 
1:             if (orderProcessingMode == TradeConfig.SYNCH)
1:                 completeOrder(order.getOrderID(), false);
1:             else if (orderProcessingMode == TradeConfig.ASYNCH_2PHASE)
1:                 queueOrder(order.getOrderID(), true);
1: 
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm:sell(" + userID + "," + holdingID + ") --> failed", e);
1:             // TODO figure out JPA cancel
1:             if (order != null)
1:                 order.cancel();
1: 
1:             entityManager.getTransaction().rollback();
1: 
1:             throw new RuntimeException("TradeJpaAm:sell(" + userID + "," + holdingID + ")", e);
1:         }
1: 
1:         if (entityManager != null) {
1:             entityManager.close();
1:             entityManager = null;
1:         }
1: 
1:         if (!(order.getOrderStatus().equalsIgnoreCase("cancelled")))
1:             //after the purchase or sell of a stock, update the stocks volume and price
1:             updateQuotePriceVolume(order.getSymbol(), TradeConfig.getRandomPriceChangeFactor(), order.getQuantity());
1: 
1:         return order;
1:     }
1: 
1:     public void queueOrder(Integer orderID, boolean twoPhase) {
1:         Log
1:         .error("TradeJpaAm:queueOrder() not implemented for this runtime mode");
1:         throw new UnsupportedOperationException(
1:                                                "TradeJpaAm:queueOrder() not implemented for this runtime mode");
1:     }
1: 
1:     public OrderDataBean completeOrder(Integer orderID, boolean twoPhase)
1:     throws Exception {
1:         EntityManager entityManager = emf.createEntityManager();
1:         OrderDataBeanImpl order = null;
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:completeOrder", orderID + " twoPhase=" + twoPhase);
1: 
1:         order = entityManager.find(OrderDataBeanImpl.class, orderID);
1:         order.getQuote();
1: 
1:         if (order == null) {
1:             Log.error("TradeJpaAm:completeOrder -- Unable to find Order " + orderID + " FBPK returned " + order);
1:             return null;
1:         }
1: 
1:         if (order.isCompleted()) {
1:             throw new RuntimeException("Error: attempt to complete Order that is already completed\n" + order);
1:         }
1: 
1:         AccountDataBean account = order.getAccount();
1:         QuoteDataBean quote = order.getQuote();
1:         HoldingDataBean holding = order.getHolding();
1:         BigDecimal price = order.getPrice();
1:         double quantity = order.getQuantity();
1: 
0:         String userID = account.getProfile().getUserID();
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:completeOrder--> Completing Order "
1:                       + order.getOrderID() + "\n\t Order info: " + order
1:                       + "\n\t Account info: " + account + "\n\t Quote info: "
1:                       + quote + "\n\t Holding info: " + holding);
1: 
1:         HoldingDataBean newHolding = null;
1:         if (order.isBuy()) {
1:             /*
1:              * Complete a Buy operation - create a new Holding for the Account -
1:              * deduct the Order cost from the Account balance
1:              */
1: 
1:             newHolding = createHolding(account, quote, quantity, price, entityManager);
1:         }
1: 
1:         try {
1:             entityManager.getTransaction().begin();
1: 
1:             if (newHolding != null) {
1:                 order.setHolding(newHolding);
1:             }
1: 
1:             if (order.isSell()) {
1:                 /*
1:                  * Complete a Sell operation - remove the Holding from the Account -
1:                  * deposit the Order proceeds to the Account balance
1:                  */
1:                 if (holding == null) {
1:                     Log.error("TradeJpaAm:completeOrder -- Unable to sell order " + order.getOrderID() + " holding already sold");
1:                     order.cancel();
1:                     entityManager.getTransaction().commit();
1:                     return order;
1:                 }
1:                 else {
1:                     entityManager.remove(holding);
1:                     order.setHolding(null);
1:                 }
1:             }
1: 
1:             order.setOrderStatus("closed");
1: 
1:             order.setCompletionDate(new java.sql.Timestamp(System.currentTimeMillis()));
1: 
1:             if (Log.doTrace())
1:                 Log.trace("TradeJpaAm:completeOrder--> Completed Order "
1:                           + order.getOrderID() + "\n\t Order info: " + order
1:                           + "\n\t Account info: " + account + "\n\t Quote info: "
1:                           + quote + "\n\t Holding info: " + holding);
1: 
1:             entityManager.getTransaction().commit();
1:         }
1:         catch (Exception e) {
1:             e.printStackTrace();
1:             entityManager.getTransaction().rollback();
1:         }
1: 
1:         if (entityManager != null) {
1:             entityManager.close();
1:             entityManager = null;
1:         }
1: 
1:         return order;
1:     }
1: 
1:     public void cancelOrder(Integer orderID, boolean twoPhase) {
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:cancelOrder", orderID + " twoPhase=" + twoPhase);
1: 
1:         OrderDataBeanImpl order = entityManager.find(OrderDataBeanImpl.class, orderID);
1:         /*
1:          * managed transaction
1:          */
1:         try {
1:             entityManager.getTransaction().begin();
1:             order.cancel();
1:             entityManager.getTransaction().commit();
1:         }
1:         catch (Exception e) {
1:             entityManager.getTransaction().rollback();
1:             entityManager.close();
1:             entityManager = null;
1:         }
1:         entityManager.close();
1:     }
1: 
1:     public void orderCompleted(String userID, Integer orderID) {
1:         if (Log.doActionTrace())
1:             Log.trace("TradeAction:orderCompleted", userID, orderID);
1:         if (Log.doTrace())
1:             Log.trace("OrderCompleted", userID, orderID);
1:     }
1: 
1:     public Collection<OrderDataBean> getOrders(String userID) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getOrders", userID);
1:         EntityManager entityManager = emf.createEntityManager();
1:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:         AccountDataBean account = profile.getAccount();
1:         entityManager.close();
1:         return account.getOrders();
1:     }
1: 
1:     public Collection<OrderDataBean> getClosedOrders(String userID) {
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getClosedOrders", userID);
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         try {
1: 
1:             // Get the primary keys for all the closed Orders for this
1:             // account.
1:             /*
1:              * managed transaction
1:              */
1:             entityManager.getTransaction().begin();
1:             Query query = entityManager.createNamedQuery("orderejb.closedOrders");
1:             query.setParameter("userID", userID);
1: 
1:             entityManager.getTransaction().commit();
1:             Collection results = query.getResultList();
1:             Iterator itr = results.iterator();
1:             // Spin through the orders to populate the lazy quote fields
1:             while (itr.hasNext()) {
1:                 OrderDataBeanImpl thisOrder = (OrderDataBeanImpl) itr.next();
1:                 thisOrder.getQuote();
1:             }
1: 
1:             if (TradeConfig.jpaLayer == TradeConfig.OPENJPA) {
1:                 Query updateStatus = entityManager.createNamedQuery("orderejb.completeClosedOrders");
1:                 /*
1:                  * managed transaction
1:                  */
1:                 try {
1:                     entityManager.getTransaction().begin();
1:                     updateStatus.setParameter("userID", userID);
1: 
1:                     updateStatus.executeUpdate();
1:                     entityManager.getTransaction().commit();
1:                 }
1:                 catch (Exception e) {
1:                     entityManager.getTransaction().rollback();
1:                     entityManager.close();
1:                     entityManager = null;
1:                 }
1:             }
1:             else if (TradeConfig.jpaLayer == TradeConfig.HIBERNATE) {
1:                 /*
1:                  * Add logic to do update orders operation, because JBoss5'
1:                  * Hibernate 3.3.1GA DB2Dialect and MySQL5Dialect do not work
1:                  * with annotated query "orderejb.completeClosedOrders" defined
1:                  * in OrderDatabean
1:                  */
1:                 Query findaccountid = entityManager.createNativeQuery(
1:                                                         "select "
1:                                                         + "a.ACCOUNTID, "
1:                                                         + "a.LOGINCOUNT, "
1:                                                         + "a.LOGOUTCOUNT, "
1:                                                         + "a.LASTLOGIN, "
1:                                                         + "a.CREATIONDATE, "
1:                                                         + "a.BALANCE, "
1:                                                         + "a.OPENBALANCE, "
1:                                                         + "a.PROFILE_USERID "
1:                                                         + "from accountejb a where a.profile_userid = ?",
0:                                                         org.apache.geronimo.samples.daytrader.beans.AccountDataBeanImpl.class);
1:                 findaccountid.setParameter(1, userID);
1:                 AccountDataBeanImpl account = (AccountDataBeanImpl) findaccountid.getSingleResult();
1:                 Integer accountid = account.getAccountID();
1:                 Query updateStatus = entityManager.createNativeQuery("UPDATE orderejb o SET o.orderStatus = 'completed' WHERE "
1:                                                                      + "o.orderStatus = 'closed' AND o.ACCOUNT_ACCOUNTID  = ?");
1:                 updateStatus.setParameter(1, accountid.intValue());
1:                 updateStatus.executeUpdate();
1:             }
1:             if (entityManager != null) {
1:                 entityManager.close();
1:                 entityManager = null;
1:             }
1:             return results;
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm.getClosedOrders", e);
1:             entityManager.close();
1:             entityManager = null;
1:             throw new RuntimeException(
1:                                       "TradeJpaAm.getClosedOrders - error", e);
1: 
1:         }
1: 
1:     }
1: 
1:     public QuoteDataBean createQuote(String symbol, String companyName, BigDecimal price) {
1: 
1:         EntityManager entityManager = emf.createEntityManager();
1:         try {
1:             QuoteDataBeanImpl quote = new QuoteDataBeanImpl(symbol, companyName, 0, price, price, price, price, 0);
1:             /*
1:              * managed transaction
1:              */
1:             try {
1:                 entityManager.getTransaction().begin();
1:                 entityManager.persist(quote);
1:                 entityManager.getTransaction().commit();
1:             }
1:             catch (Exception e) {
1:                 entityManager.getTransaction().rollback();
1:             }
1: 
1:             if (Log.doTrace())
1:                 Log.trace("TradeJpaAm:createQuote-->" + quote);
1: 
1:             if (entityManager != null) {
1:                 entityManager.close();
1:                 entityManager = null;
1:             }
1:             return quote;
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm:createQuote -- exception creating Quote", e);
1:             entityManager.close();
1:             entityManager = null;
1:             throw new RuntimeException(e);
1:         }
1:     }
1: 
1:     public QuoteDataBean getQuote(String symbol) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getQuote", symbol);
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         QuoteDataBeanImpl qdb = entityManager.find(QuoteDataBeanImpl.class, symbol);
1: 
1:         if (entityManager != null) {
1:             entityManager.close();
1:             entityManager = null;
1:         }
1:         return qdb;
1:     }
1: 
1:     public Collection<QuoteDataBean> getAllQuotes() {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getAllQuotes");
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         Query query = entityManager.createNamedQuery("quoteejb.allQuotes");
1: 
1:         if (entityManager != null) {
1:             entityManager.close();
1:             entityManager = null;
1: 
1:         }
1:         return query.getResultList();
1:     }
1: 
1:     public QuoteDataBean updateQuotePriceVolume(String symbol,
1:                                                 BigDecimal changeFactor, double sharesTraded) {
1:         if (!TradeConfig.getUpdateQuotePrices()) {
1:             return new QuoteDataBeanImpl();
1:         }
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:updateQuote", symbol, changeFactor);
1: 
1:         /*
1:          * Add logic to determine JPA layer, because JBoss5' Hibernate 3.3.1GA
1:          * DB2Dialect and MySQL5Dialect do not work with annotated query
1:          * "quoteejb.quoteForUpdate" defined in QuoteDataBeanImpl
1:          */
1:         EntityManager entityManager = emf.createEntityManager();
1:         QuoteDataBeanImpl quote = null;
1:         if (TradeConfig.jpaLayer == TradeConfig.HIBERNATE) {
1:             quote = entityManager.find(QuoteDataBeanImpl.class, symbol);
1:         } else if (TradeConfig.jpaLayer == TradeConfig.OPENJPA) {
1:   
1:             Query q = entityManager.createNamedQuery("quoteejb.quoteForUpdate");
1:             q.setParameter(1, symbol);
1:   
1:             quote = (QuoteDataBeanImpl) q.getSingleResult();
1:         }
1: 
1:         BigDecimal oldPrice = quote.getPrice();
1: 
1:         if (quote.getPrice().equals(TradeConfig.PENNY_STOCK_PRICE)) {
1:             changeFactor = TradeConfig.PENNY_STOCK_RECOVERY_MIRACLE_MULTIPLIER;
1:         }
1: 
1:         BigDecimal newPrice = changeFactor.multiply(oldPrice).setScale(2, BigDecimal.ROUND_HALF_UP);
1: 
1:         /*
1:          * managed transaction
1:          */
1: 
1:         try {
1: 
1:             quote.setPrice(newPrice);
1:             quote.setVolume(quote.getVolume() + sharesTraded);
1:             quote.setChange((newPrice.subtract(quote.getOpen()).doubleValue()));
1: 
1:             entityManager.getTransaction().begin();
1:             entityManager.merge(quote);
1:             entityManager.getTransaction().commit();
1:         }
1:         catch (Exception e) {
1:             entityManager.getTransaction().rollback();
1:         }
1: 
1:         if (entityManager != null) {
1:             entityManager.close();
1:             entityManager = null;
1:         }
1: 
1:         this.publishQuotePriceChange(quote, oldPrice, changeFactor, sharesTraded);
1: 
1:         return quote;
1:     }
1: 
1:     public Collection<HoldingDataBean> getHoldings(String userID) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getHoldings", userID);
1:         EntityManager entityManager = emf.createEntityManager();
1:         /*
1:          * managed transaction
1:          */
1:         entityManager.getTransaction().begin();
1: 
1:         Query query = entityManager.createNamedQuery("holdingejb.holdingsByUserID");
1:         query.setParameter("userID", userID);
1: 
1:         entityManager.getTransaction().commit();
1:         Collection<HoldingDataBean> holdings = query.getResultList();
1:         /*
1:          * Inflate the lazy data memebers
1:          */
1:         Iterator itr = holdings.iterator();
1:         while (itr.hasNext()) {
1:             ((HoldingDataBean) itr.next()).getQuote();
1:         }
1: 
1:         entityManager.close();
1:         entityManager = null;
1:         return holdings;
1:     }
1: 
1:     public HoldingDataBean getHolding(Integer holdingID) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getHolding", holdingID);
1:         EntityManager entityManager = emf.createEntityManager();
1:         return entityManager.find(HoldingDataBeanImpl.class, holdingID);
1:     }
1: 
1:     public AccountDataBean getAccountData(String userID) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getAccountData", userID);
1: 
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:         /*
1:          * Inflate the lazy data memebers
1:          */
1:         AccountDataBean account = profile.getAccount();
1:         account.getProfile();
1: 
1:         // Added to populate transient field for account
1:         account.setProfileID(profile.getUserID());
1:         entityManager.close();
1:         entityManager = null;
1: 
1:         return account;
1:     }
1: 
1:     public AccountProfileDataBean getAccountProfileData(String userID) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:getProfileData", userID);
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         AccountProfileDataBeanImpl apb = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:         entityManager.close();
1:         entityManager = null;
1:         return apb;
1:     }
1: 
1:     public AccountProfileDataBean updateAccountProfile(String userID, String password, String fullName, String address, String email, String creditcard) throws Exception {
1: 
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:updateAccountProfileData", userID);
1:         /*
1:          * // Retrieve the previous account profile in order to get account
1:          * data... hook it into new object AccountProfileDataBean temp =
1:          * entityManager.find(AccountProfileDataBean.class,
1:          * profileData.getUserID()); // In order for the object to merge
1:          * correctly, the account has to be hooked into the temp object... // -
1:          * may need to reverse this and obtain the full object first
1:          * 
1:          * profileData.setAccount(temp.getAccount());
1:          * 
1:          * //TODO this might not be correct temp =
1:          * entityManager.merge(profileData); //System.out.println(temp);
1:          */
1: 
1:         AccountProfileDataBeanImpl temp = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:         temp.setAddress(address);
1:         temp.setPassword(password);
1:         temp.setFullName(fullName);
1:         temp.setCreditCard(creditcard);
1:         temp.setEmail(email);
1:         /*
1:          * Managed Transaction
1:          */
1:         try {
1: 
1:             entityManager.getTransaction().begin();
1:             entityManager.merge(temp);
1:             entityManager.getTransaction().commit();
1:             entityManager.close();
1:         }
1:         catch (Exception e) {
1:             entityManager.getTransaction().rollback();
1:             entityManager.close();
1:             entityManager = null;
1:         }
1: 
1:         return temp;
1:     }
1: 
1:     public AccountDataBean login(String userID, String password)
1:     throws Exception {
1: 
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1: 
1:         if (profile == null) {
1:             throw new RuntimeException("No such user: " + userID);
1:         }
1:         /*
1:          * Managed Transaction
1:          */
1:         entityManager.getTransaction().begin();
1:         entityManager.merge(profile);
1: 
1:         AccountDataBean account = profile.getAccount();
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:login", userID, password);
1: 
1:         account.login(password);
1:         entityManager.getTransaction().commit();
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:login(" + userID + "," + password + ") success" + account);
1:         entityManager.close();
1:         return account;
1:     }
1: 
1:     public void logout(String userID) {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:logout", userID);
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         AccountProfileDataBeanImpl profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1:         AccountDataBean account = profile.getAccount();
1: 
1:         /*
1:          * Managed Transaction
1:          */
1:         try {
1:             entityManager.getTransaction().begin();
1:             account.logout();
1:             entityManager.getTransaction().commit();
1:             entityManager.close();
1:         }
1:         catch (Exception e) {
1:             entityManager.getTransaction().rollback();
1:             entityManager.close();
1:             entityManager = null;
1:         }
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:logout(" + userID + ") success");
1:     }
1: 
1:     public AccountDataBean register(String userID, String password, String fullname, 
1:                                     String address, String email, String creditcard,
1:                                     BigDecimal openBalance) {
1:         AccountDataBeanImpl account = null;
1:         AccountProfileDataBeanImpl profile = null;
1:         EntityManager entityManager = emf.createEntityManager();
1: 
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:register", userID, password, fullname, address, email, creditcard, openBalance);
1: 
1:         // Check to see if a profile with the desired userID already exists
1: 
1:         profile = entityManager.find(AccountProfileDataBeanImpl.class, userID);
1: 
1:         if (profile != null) {
1:             Log.error("Failed to register new Account - AccountProfile with userID(" + userID + ") already exists");
1:             return null;
1:         }
1:         else {
1:             profile = new AccountProfileDataBeanImpl(userID, password, fullname,
1:                                                  address, email, creditcard);
1:             account = new AccountDataBeanImpl(0, 0, null, new Timestamp(System.currentTimeMillis()), openBalance, openBalance, userID);
1:             profile.setAccount((AccountDataBean)account);
1:             account.setProfile((AccountProfileDataBean)profile);
1:             /*
1:              * managed Transaction
1:              */
1:             try {
1:                 entityManager.getTransaction().begin();
1:                 entityManager.persist(profile);
1:                 entityManager.persist(account);
1:                 entityManager.getTransaction().commit();
1:             }
1:             catch (Exception e) {
1:                 entityManager.getTransaction().rollback();
1:                 entityManager.close();
1:                 entityManager = null;
1:             }
1:         }
1: 
1: 
1:         return account;
1:     }
1: 
1:     /*
1:      * NO LONGER USE
1:      */
1: 
1:     private void publishQuotePriceChange(QuoteDataBean quote,
1:                                          BigDecimal oldPrice, BigDecimal changeFactor, double sharesTraded) {
1:         if (!TradeConfig.getPublishQuotePriceChange())
1:             return;
1:         Log.error("TradeJpaAm:publishQuotePriceChange - is not implemented for this runtime mode");
1:         throw new UnsupportedOperationException("TradeJpaAm:publishQuotePriceChange - is not implemented for this runtime mode");
1:     }
1: 
1:     /*
1:      * new Method() that takes EntityManager as a parameter
1:      */
1:     private OrderDataBean createOrder(AccountDataBean account,
1:                                       QuoteDataBean quote, HoldingDataBean holding, String orderType,
1:                                       double quantity, EntityManager entityManager) {
1:         OrderDataBeanImpl order;
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:createOrder(orderID=" + " account="
1:                       + ((account == null) ? null : account.getAccountID())
1:                       + " quote=" + ((quote == null) ? null : quote.getSymbol())
1:                       + " orderType=" + orderType + " quantity=" + quantity);
1:         try {
1:             order = new OrderDataBeanImpl(orderType, 
1:                                       "open", 
1:                                       new Timestamp(System.currentTimeMillis()), 
1:                                       null, 
1:                                       quantity, 
1:                                       quote.getPrice().setScale(FinancialUtils.SCALE, FinancialUtils.ROUND),
1:                                       TradeConfig.getOrderFee(orderType), 
1:                                       account, 
1:                                       quote, 
1:                                       holding);
1:                 entityManager.persist(order);
1:         }
1:         catch (Exception e) {
1:             Log.error("TradeJpaAm:createOrder -- failed to create Order", e);
1:             throw new RuntimeException("TradeJpaAm:createOrder -- failed to create Order", e);
1:         }
1:         return order;
1:     }
1: 
1:     private HoldingDataBean createHolding(AccountDataBean account,
1:                                           QuoteDataBean quote, double quantity, BigDecimal purchasePrice,
1:                                           EntityManager entityManager) throws Exception {
1:         HoldingDataBeanImpl newHolding = new HoldingDataBeanImpl(quantity,
1:                                                          purchasePrice, new Timestamp(System.currentTimeMillis()),
1:                                                          account, quote);
1:         try {
1:             /*
1:              * manage transactions
1:              */
1:             entityManager.getTransaction().begin();
1:             entityManager.persist(newHolding);
1:             entityManager.getTransaction().commit();
1:         }
1:         catch (Exception e) {
1:             entityManager.getTransaction().rollback();
1:             entityManager.close();
1:             entityManager = null;
1:         }
1:         return newHolding;
1:     }
1: 
1:     public double investmentReturn(double investment, double NetValue)
1:     throws Exception {
1:         if (Log.doTrace())
1:             Log.trace("TradeJpaAm:investmentReturn");
1: 
1:         double diff = NetValue - investment;
1:         double ir = diff / investment;
1:         return ir;
1:     }
1: 
1:     public QuoteDataBean pingTwoPhase(String symbol) throws Exception {
1:         Log
1:         .error("TradeJpaAm:pingTwoPhase - is not implemented for this runtime mode");
1:         throw new UnsupportedOperationException("TradeJpaAm:pingTwoPhase - is not implemented for this runtime mode");
1:     }
1: 
1:     class quotePriceComparator implements java.util.Comparator {
1:         public int compare(Object quote1, Object quote2) {
1:             double change1 = ((QuoteDataBean) quote1).getChange();
1:             double change2 = ((QuoteDataBean) quote2).getChange();
1:             return new Double(change2).compareTo(change1);
1:         }
1:     }
1: 
1:     /**
1:      * Get mode - returns the persistence mode (TradeConfig.JPA)
1:      * 
0:      * @return int mode
1:      */
0:     public int getMode() {
0:         return TradeConfig.JPA_AM;
1:     }
1: 
1: }
============================================================================