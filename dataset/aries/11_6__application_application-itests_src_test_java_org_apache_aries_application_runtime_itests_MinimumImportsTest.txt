1:f34e6a1: /*
1:694eb45:  * Licensed to the Apache Software Foundation (ASF) under one
1:694eb45:  * or more contributor license agreements.  See the NOTICE file
1:694eb45:  * distributed with this work for additional information
1:694eb45:  * regarding copyright ownership.  The ASF licenses this file
1:694eb45:  * to you under the Apache License, Version 2.0 (the
1:694eb45:  * "License"); you may not use this file except in compliance
1:694eb45:  * with the License.  You may obtain a copy of the License at
1:694eb45:  *
1:694eb45:  *   http://www.apache.org/licenses/LICENSE-2.0
1:694eb45:  *
1:694eb45:  * Unless required by applicable law or agreed to in writing,
1:694eb45:  * software distributed under the License is distributed on an
1:694eb45:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
1:694eb45:  * KIND, either express or implied.  See the License for the
1:694eb45:  * specific language governing permissions and limitations
1:694eb45:  * under the License.
1:f34e6a1:  */
1:694eb45: package org.apache.aries.application.runtime.itests;
1:92429ff: 
1:694eb45: import static org.junit.Assert.assertNotNull;
1:694eb45: import static org.junit.Assert.assertTrue;
1:0223547: import static org.ops4j.pax.exam.CoreOptions.*;
1:92429ff: 
1:92429ff: import java.io.BufferedReader;
1:92429ff: import java.io.File;
1:92429ff: import java.io.FileOutputStream;
1:92429ff: import java.io.FileWriter;
1:92429ff: import java.io.InputStreamReader;
1:92429ff: import java.io.OutputStream;
1:92429ff: 
1:694eb45: import org.apache.aries.application.management.AriesApplication;
1:694eb45: import org.apache.aries.application.management.AriesApplicationContext;
1:694eb45: import org.apache.aries.application.management.AriesApplicationManager;
1:86224ba: import org.apache.aries.itest.AbstractIntegrationTest;
1:694eb45: import org.apache.aries.unittest.fixture.ArchiveFixture;
1:694eb45: import org.apache.aries.unittest.fixture.ArchiveFixture.ZipFixture;
1:910fec0: import org.apache.aries.util.filesystem.FileSystem;
1:92429ff: import org.apache.felix.bundlerepository.Repository;
1:92429ff: import org.apache.felix.bundlerepository.RepositoryAdmin;
1:694eb45: import org.junit.Before;
1:694eb45: import org.junit.Test;
1:694eb45: import org.junit.runner.RunWith;
1:0223547: import org.ops4j.pax.exam.Configuration;
1:694eb45: import org.ops4j.pax.exam.Option;
1:0223547: import org.ops4j.pax.exam.junit.PaxExam;
1:0223547: import org.ops4j.pax.exam.spi.reactors.ExamReactorStrategy;
1:0223547: import org.ops4j.pax.exam.spi.reactors.PerClass;
1:92429ff: import org.osgi.framework.Constants;
1:694eb45: import org.osgi.framework.ServiceRegistration;
1:694eb45: import org.osgi.service.blueprint.container.BlueprintEvent;
1:694eb45: import org.osgi.service.blueprint.container.BlueprintListener;
1:92429ff: 
1:0223547: @RunWith(PaxExam.class)
1:0223547: @ExamReactorStrategy(PerClass.class)
1:694eb45: public class MinimumImportsTest extends AbstractIntegrationTest {
1:92429ff: 
1:0223547:     /* Use @Before not @BeforeClass so as to ensure that these resources
1:0223547:      * are created in the paxweb temp directory, and not in the svn tree
1:0223547:      */
1:0223547:     static boolean createdApplications = false;
1:0223547:     static String fake_app_management = "application.management.fake";
1:92429ff: 
1:0223547:     @Before
1:0223547:     public void createApplications() throws Exception {
1:92429ff: 
1:0223547:         if (createdApplications) {
1:0223547:             return;
1:92429ff:         }
1:0223547: 
1:0223547:         // need to fake a application manager to export the service in order to pass the resolving for the client
1:0223547:         // In the real situation, we don't allow customers' bundles to explicitly import the runtime services.
1:0223547:         ZipFixture bundle = ArchiveFixture.newJar().manifest()
1:0223547:                 .attribute(Constants.BUNDLE_SYMBOLICNAME, fake_app_management)
1:0223547:                 .attribute(Constants.BUNDLE_MANIFESTVERSION, "2")
1:0223547:                 .attribute(Constants.BUNDLE_VERSION, "1.0.0").end();
1:0223547: 
1:0223547:         OutputStream out = new FileOutputStream(fake_app_management + ".jar");
1:0223547:         bundle.writeOut(out);
1:0223547:         out.close();
1:0223547: 
1:0223547: 
1:0223547:         ZipFixture testEba = ArchiveFixture.newZip()
1:0223547:                 .jar("org.apache.aries.application.itests.minimports.jar")
1:0223547:                 .manifest().symbolicName("org.apache.aries.application.itests.minimports")
1:0223547:                 .attribute("Bundle-Version", "1.0.0")
1:0223547:                 .attribute("Import-Package", "org.apache.aries.application.management")
1:0223547:                 .end()
1:0223547:                 .binary("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class",
1:0223547:                         MinimumImportsTest.class.getClassLoader().getResourceAsStream("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class"))
1:0223547:                 .binary("OSGI-INF/blueprint/app-mgr-client.xml",
1:0223547:                         MinimumImportsTest.class.getClassLoader().getResourceAsStream("app-mgr-client.xml"))
1:0223547:                 .end();
1:0223547: 
1:0223547:         FileOutputStream fout = new FileOutputStream("appmgrclienttest.eba");
1:0223547:         testEba.writeOut(fout);
1:0223547:         fout.close();
1:0223547: 
1:0223547:         StringBuilder repositoryXML = new StringBuilder();
1:0223547: 
1:0223547:         BufferedReader reader = new BufferedReader(new InputStreamReader(MinimumImportsTest.class.getResourceAsStream("/basic/fakeAppMgrServiceRepo.xml")));
1:0223547:         String line;
1:0223547: 
1:0223547:         while ((line = reader.readLine()) != null) {
1:0223547:             repositoryXML.append(line);
1:0223547:             repositoryXML.append("\r\n");
1:f34e6a1:         }
1:f34e6a1: 
1:0223547:         String repo = repositoryXML.toString().replaceAll("bundle_location", new File(fake_app_management + ".jar").toURI().toString());
1:8069959: 
1:0223547:         System.out.println(repo);
1:8069959: 
1:0223547:         FileWriter writer = new FileWriter("repository.xml");
1:0223547:         writer.write(repo);
1:0223547:         writer.close();
1:0223547:         createdApplications = true;
1:8069959:     }
1:8069959: 
1:0223547:     public static class AppMgrClientBlueprintListener implements BlueprintListener {
1:92429ff: 
1:0223547:         Boolean success = null;
1:92429ff: 
1:0223547:         public void blueprintEvent(BlueprintEvent event) {
1:0223547:             if (event.getBundle().getSymbolicName().equals(
1:0223547:                     "org.apache.aries.application.itests.minimports")) {
1:0223547:                 if (event.getType() == event.FAILURE) {
1:0223547:                     success = Boolean.FALSE;
1:0223547:                 }
1:0223547:                 if (event.getType() == event.CREATED) {
1:0223547:                     success = Boolean.TRUE;
1:0223547:                 }
1:0223547:             }
1:0223547:         }
1:8069959:     }
1:92429ff: 
1:0223547:     @Test
1:0223547:     public void testAppUsingAriesApplicationManager() throws Exception {
1:92429ff: 
1:0223547:         // Register a BlueprintListener to listen for the events from the BlueprintContainer for the bundle in the appmgrclienttest.eba
1:92429ff: 
1:0223547:         AppMgrClientBlueprintListener acbl = new AppMgrClientBlueprintListener();
1:0223547:         ServiceRegistration sr = bundleContext.registerService("org.osgi.service.blueprint.container.BlueprintListener", acbl, null);
1:92429ff: 
1:0223547:         AriesApplicationManager manager = context().getService(AriesApplicationManager.class);
1:0223547:         AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("appmgrclienttest.eba")));
1:0223547:         RepositoryAdmin repositoryAdmin = context().getService(RepositoryAdmin.class);
1:92429ff: 
1:0223547:         Repository[] repos = repositoryAdmin.listRepositories();
1:0223547:         for (Repository repo : repos) {
1:0223547:             repositoryAdmin.removeRepository(repo.getURI());
1:0223547:         }
1:92429ff: 
1:0223547:         repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
1:92429ff: 
1:0223547:         AriesApplicationContext ctx = manager.install(app);
1:0223547:         ctx.start();
1:0223547: 
1:0223547:         int sleepfor = 3000;
1:0223547:         while ((acbl.success == null || acbl.success == false) && sleepfor > 0) {
1:0223547:             Thread.sleep(100);
1:0223547:             sleepfor -= 100;
1:0223547:         }
1:0223547:         assertNotNull("Timed out - didn't receive Blueprint CREATED or FAILURE event", acbl.success);
1:0223547:         assertTrue("Received Blueprint FAILURE event", acbl.success);
1:0223547: 
1:0223547:         ctx.stop();
1:0223547:         manager.uninstall(ctx);
1:0223547:         sr.unregister();
1:0223547:     }
1:0223547: 
1:0223547:     @Configuration
1:0223547:     public static Option[] configuration() {
1:0223547:         return options(
1:0223547: 
1:0223547:                 // framework / core bundles
1:0223547:                 mavenBundle("org.osgi", "org.osgi.core").versionAsInProject(),
1:0223547:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-api").versionAsInProject(),
1:0223547:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-service").versionAsInProject(),
1:0223547: 
1:0223547:                 // Logging
1:0223547:                 systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("INFO"),
1:0223547: 
1:0223547:                 // Bundles
1:0223547:                 junitBundles(),
1:0223547:                 mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit").versionAsInProject(),
1:0223547: 
1:0223547:                 // Bundles
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.api").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.management").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.default.local.platform").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries", "org.apache.aries.util").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.modeller").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint").versionAsInProject(),
1:0223547:                 mavenBundle("org.ow2.asm", "asm-all").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.proxy", "org.apache.aries.proxy").versionAsInProject());
1:0223547:     }
1:92429ff: 
1:92429ff: }
============================================================================
author:Christian Schneider
-------------------------------------------------------------------------------
commit:e334773
/////////////////////////////////////////////////////////////////////////
author:Jean-Baptiste Onofre
-------------------------------------------------------------------------------
commit:0223547
/////////////////////////////////////////////////////////////////////////
1: import static org.ops4j.pax.exam.CoreOptions.*;
/////////////////////////////////////////////////////////////////////////
1: import org.ops4j.pax.exam.Configuration;
1: import org.ops4j.pax.exam.junit.PaxExam;
1: import org.ops4j.pax.exam.spi.reactors.ExamReactorStrategy;
1: import org.ops4j.pax.exam.spi.reactors.PerClass;
1: @RunWith(PaxExam.class)
1: @ExamReactorStrategy(PerClass.class)
1:     /* Use @Before not @BeforeClass so as to ensure that these resources
1:      * are created in the paxweb temp directory, and not in the svn tree
1:      */
1:     static boolean createdApplications = false;
1:     static String fake_app_management = "application.management.fake";
1:     @Before
1:     public void createApplications() throws Exception {
1:         if (createdApplications) {
1:             return;
1: 
1:         // need to fake a application manager to export the service in order to pass the resolving for the client
1:         // In the real situation, we don't allow customers' bundles to explicitly import the runtime services.
1:         ZipFixture bundle = ArchiveFixture.newJar().manifest()
1:                 .attribute(Constants.BUNDLE_SYMBOLICNAME, fake_app_management)
1:                 .attribute(Constants.BUNDLE_MANIFESTVERSION, "2")
1:                 .attribute(Constants.BUNDLE_VERSION, "1.0.0").end();
1: 
1:         OutputStream out = new FileOutputStream(fake_app_management + ".jar");
1:         bundle.writeOut(out);
1:         out.close();
1: 
1: 
1:         ZipFixture testEba = ArchiveFixture.newZip()
1:                 .jar("org.apache.aries.application.itests.minimports.jar")
1:                 .manifest().symbolicName("org.apache.aries.application.itests.minimports")
1:                 .attribute("Bundle-Version", "1.0.0")
1:                 .attribute("Import-Package", "org.apache.aries.application.management")
1:                 .end()
1:                 .binary("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class",
1:                         MinimumImportsTest.class.getClassLoader().getResourceAsStream("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class"))
1:                 .binary("OSGI-INF/blueprint/app-mgr-client.xml",
1:                         MinimumImportsTest.class.getClassLoader().getResourceAsStream("app-mgr-client.xml"))
1:                 .end();
1: 
1:         FileOutputStream fout = new FileOutputStream("appmgrclienttest.eba");
1:         testEba.writeOut(fout);
1:         fout.close();
1: 
1:         StringBuilder repositoryXML = new StringBuilder();
1: 
1:         BufferedReader reader = new BufferedReader(new InputStreamReader(MinimumImportsTest.class.getResourceAsStream("/basic/fakeAppMgrServiceRepo.xml")));
1:         String line;
1: 
1:         while ((line = reader.readLine()) != null) {
1:             repositoryXML.append(line);
1:             repositoryXML.append("\r\n");
1:         String repo = repositoryXML.toString().replaceAll("bundle_location", new File(fake_app_management + ".jar").toURI().toString());
1:         System.out.println(repo);
1:         FileWriter writer = new FileWriter("repository.xml");
1:         writer.write(repo);
1:         writer.close();
1:         createdApplications = true;
1:     public static class AppMgrClientBlueprintListener implements BlueprintListener {
1:         Boolean success = null;
1:         public void blueprintEvent(BlueprintEvent event) {
1:             if (event.getBundle().getSymbolicName().equals(
1:                     "org.apache.aries.application.itests.minimports")) {
1:                 if (event.getType() == event.FAILURE) {
1:                     success = Boolean.FALSE;
1:                 }
1:                 if (event.getType() == event.CREATED) {
1:                     success = Boolean.TRUE;
1:                 }
1:             }
1:         }
1:     @Test
1:     public void testAppUsingAriesApplicationManager() throws Exception {
1:         // Register a BlueprintListener to listen for the events from the BlueprintContainer for the bundle in the appmgrclienttest.eba
1:         AppMgrClientBlueprintListener acbl = new AppMgrClientBlueprintListener();
1:         ServiceRegistration sr = bundleContext.registerService("org.osgi.service.blueprint.container.BlueprintListener", acbl, null);
1:         AriesApplicationManager manager = context().getService(AriesApplicationManager.class);
1:         AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("appmgrclienttest.eba")));
1:         RepositoryAdmin repositoryAdmin = context().getService(RepositoryAdmin.class);
1:         Repository[] repos = repositoryAdmin.listRepositories();
1:         for (Repository repo : repos) {
1:             repositoryAdmin.removeRepository(repo.getURI());
1:         }
1:         repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
1:         AriesApplicationContext ctx = manager.install(app);
1:         ctx.start();
1: 
1:         int sleepfor = 3000;
1:         while ((acbl.success == null || acbl.success == false) && sleepfor > 0) {
1:             Thread.sleep(100);
1:             sleepfor -= 100;
1:         }
1:         assertNotNull("Timed out - didn't receive Blueprint CREATED or FAILURE event", acbl.success);
1:         assertTrue("Received Blueprint FAILURE event", acbl.success);
1: 
1:         ctx.stop();
1:         manager.uninstall(ctx);
1:         sr.unregister();
1:     }
1: 
1:     @Configuration
1:     public static Option[] configuration() {
1:         return options(
1: 
1:                 // framework / core bundles
1:                 mavenBundle("org.osgi", "org.osgi.core").versionAsInProject(),
0:                 mavenBundle("org.osgi", "org.osgi.compendium").versionAsInProject(),
1:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-api").versionAsInProject(),
1:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-service").versionAsInProject(),
1: 
1:                 // Logging
1:                 systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("INFO"),
1: 
1:                 // Bundles
1:                 junitBundles(),
1:                 mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit").versionAsInProject(),
1: 
1:                 // Bundles
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.api").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.management").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.default.local.platform").versionAsInProject(),
1:                 mavenBundle("org.apache.aries", "org.apache.aries.util").versionAsInProject(),
1:                 mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.modeller").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint").versionAsInProject(),
1:                 mavenBundle("org.ow2.asm", "asm-all").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.proxy", "org.apache.aries.proxy").versionAsInProject());
1:     }
author:John Ross
-------------------------------------------------------------------------------
commit:cffbcb0
/////////////////////////////////////////////////////////////////////////
0: import static org.apache.aries.itest.ExtraOptions.mavenBundle;
0: import static org.apache.aries.itest.ExtraOptions.paxLogging;
0: import static org.apache.aries.itest.ExtraOptions.testOptions;
/////////////////////////////////////////////////////////////////////////
0: import org.ops4j.pax.exam.junit.MavenConfiguredJUnit4TestRunner;
0: @RunWith(MavenConfiguredJUnit4TestRunner.class)
/////////////////////////////////////////////////////////////////////////
0:   public static Option[] configuration()
0: 			  PaxRunnerOptions.rawPaxRunnerOption("config", "classpath:ss-runner.properties")        
commit:f34e6a1
/////////////////////////////////////////////////////////////////////////
1:   /*
0:    * Commented out to avoid an NPE due to a ConcurrentModificationException in
0:    * the Aries build. See https://issues.apache.org/jira/browse/ARIES-931.
1:    */
0:   //@org.ops4j.pax.exam.junit.Configuration
/////////////////////////////////////////////////////////////////////////
0:   /*
0:    * Commented out to avoid an NPE due to a ConcurrentModificationException in
0:    * the Aries build. See https://issues.apache.org/jira/browse/ARIES-931.
0:    */
0:   //@org.ops4j.pax.exam.junit.Configuration
/////////////////////////////////////////////////////////////////////////
1:   
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] equinox38Options()
0:   {
0: 	  return testOptions(
0: 			  generalConfiguration(),
0: 			  PaxRunnerOptions.rawPaxRunnerOption("config", "classpath:ss-runner.properties"),          
0: 	          equinox().version("3.8.0.V20120529-1548")
0: 	          );
1:   }
author:Holly Cummins
-------------------------------------------------------------------------------
commit:8069959
/////////////////////////////////////////////////////////////////////////
0: import org.ops4j.pax.exam.container.def.PaxRunnerOptions;
/////////////////////////////////////////////////////////////////////////
0:   public static Option[] generalConfiguration() {
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.osgi", "org.osgi.compendium")
/////////////////////////////////////////////////////////////////////////
0:         );
1:   
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] equinox35Options()
0:   {
0: 	  return testOptions(
0: 			  generalConfiguration(),
0: 	          equinox().version("3.5.0")
0: 	          );
1:   }
1: 
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] equinox37Options()
0:   {
0: 	  return testOptions(
0: 			  generalConfiguration(),
0: 			  PaxRunnerOptions.rawPaxRunnerOption("config", "classpath:ss-runner.properties"),          
0: 	          equinox().version("3.7.0.v20110613")
0: 	          );
1:   }
1: 
author:Emily Jiang
-------------------------------------------------------------------------------
commit:2b7f337
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.ow2.asm", "asm-all"),
author:Valentin Mahrwald
-------------------------------------------------------------------------------
commit:86224ba
/////////////////////////////////////////////////////////////////////////
0: import static org.apache.aries.itest.ExtraOptions.*;
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.itest.AbstractIntegrationTest;
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
0:     AriesApplicationManager manager = context().getService(AriesApplicationManager.class);
0:     RepositoryAdmin repositoryAdmin = context().getService(RepositoryAdmin.class);
/////////////////////////////////////////////////////////////////////////
0:     return testOptions(
0:         paxLogging("DEBUG"),
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
commit:910fec0
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.util.filesystem.FileSystem;
author:Alasdair Nottingham
-------------------------------------------------------------------------------
commit:be6ac25
/////////////////////////////////////////////////////////////////////////
commit:5254613
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("asm", "asm-all"),
0:         mavenBundle("org.apache.aries.proxy", "org.apache.aries.proxy"),
author:Mark Nuttall
-------------------------------------------------------------------------------
commit:d3efe20
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.default.local.platform"),
commit:a0eca03
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.noop.platform.repo"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.noop.postresolve.process"),
commit:92429ff
/////////////////////////////////////////////////////////////////////////
1: import java.io.BufferedReader;
1: import java.io.File;
1: import java.io.FileOutputStream;
1: import java.io.FileWriter;
1: import java.io.InputStreamReader;
1: import java.io.OutputStream;
1: 
1: import org.apache.felix.bundlerepository.Repository;
1: import org.apache.felix.bundlerepository.RepositoryAdmin;
1: import org.osgi.framework.Constants;
1: 
1: 
0:   static String fake_app_management = "application.management.fake";
1: 
0:     // need to fake a application manager to export the service in order to pass the resolving for the client
0:     // In the real situation, we don't allow customers' bundles to explicitly import the runtime services.
0:     ZipFixture bundle = ArchiveFixture.newJar().manifest()
0:     .attribute(Constants.BUNDLE_SYMBOLICNAME, fake_app_management)
0:     .attribute(Constants.BUNDLE_MANIFESTVERSION, "2")
0:     .attribute(Constants.BUNDLE_VERSION, "1.0.0").end();
1: 
0:     OutputStream out = new FileOutputStream(fake_app_management + ".jar");
0:     bundle.writeOut(out);
0:     out.close();
1: 
1: 
0:     .jar("org.apache.aries.application.itests.minimports.jar")
0:     .manifest().symbolicName("org.apache.aries.application.itests.minimports")
0:     .attribute("Bundle-Version", "1.0.0")
0:     .attribute("Import-Package", "org.apache.aries.application.management")
0:     .end()
0:     .binary("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class", 
0:         MinimumImportsTest.class.getClassLoader().getResourceAsStream("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class"))
0:             .end();
1: 
1: 
0:     StringBuilder repositoryXML = new StringBuilder();
1: 
0:     BufferedReader reader = new BufferedReader(new InputStreamReader(MinimumImportsTest.class.getResourceAsStream("/basic/fakeAppMgrServiceRepo.xml")));
0:     String line;
1: 
0:     while ((line = reader.readLine()) != null) {
0:       repositoryXML.append(line);
0:       repositoryXML.append("\r\n");
1:     }
1: 
0:     String repo = repositoryXML.toString().replaceAll("bundle_location", new File(fake_app_management + ".jar").toURI().toString());
1: 
0:     System.out.println(repo);
1: 
0:     FileWriter writer = new FileWriter("repository.xml");
0:     writer.write(repo);
0:     writer.close();
1: 
1: 
1: 
/////////////////////////////////////////////////////////////////////////
0: 
0: 
0: 
0: 
0:     RepositoryAdmin repositoryAdmin = getOsgiService(RepositoryAdmin.class);
0: 
0:     Repository[] repos = repositoryAdmin.listRepositories();
0:     for (Repository repo : repos) {
0:       repositoryAdmin.removeRepository(repo.getURI());
1:     }
0: 
0:     repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
0: 
0: 
/////////////////////////////////////////////////////////////////////////
0: 
0: 
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.modeller"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management"),
0: 
0:         /* For debugging, uncomment the next two lines*/
0:         /*vmOption ("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5007"),
0:           waitForFrameworkStartup(),*/
0: 
0:         /*and add these imports:
0:           import static org.ops4j.pax.exam.CoreOptions.waitForFrameworkStartup;
0:           import static org.ops4j.pax.exam.container.def.PaxRunnerOptions.vmOption;*/
0: 
author:Jarek Gawor
-------------------------------------------------------------------------------
commit:694eb45
/////////////////////////////////////////////////////////////////////////
0: /*
1:  * Licensed to the Apache Software Foundation (ASF) under one
1:  * or more contributor license agreements.  See the NOTICE file
1:  * distributed with this work for additional information
1:  * regarding copyright ownership.  The ASF licenses this file
1:  * to you under the Apache License, Version 2.0 (the
1:  * "License"); you may not use this file except in compliance
1:  * with the License.  You may obtain a copy of the License at
1:  *
1:  *   http://www.apache.org/licenses/LICENSE-2.0
1:  *
1:  * Unless required by applicable law or agreed to in writing,
1:  * software distributed under the License is distributed on an
1:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
1:  * KIND, either express or implied.  See the License for the
1:  * specific language governing permissions and limitations
1:  * under the License.
0:  */
1: package org.apache.aries.application.runtime.itests;
0: 
0: import java.io.File;
0: import java.io.FileOutputStream;
0: 
1: import static org.junit.Assert.assertNotNull;
1: import static org.junit.Assert.assertTrue;
0: import static org.ops4j.pax.exam.CoreOptions.equinox;
0: import static org.ops4j.pax.exam.CoreOptions.options;
0: import static org.ops4j.pax.exam.CoreOptions.systemProperty;
0: 
1: import org.apache.aries.application.management.AriesApplication;
1: import org.apache.aries.application.management.AriesApplicationContext;
1: import org.apache.aries.application.management.AriesApplicationManager;
0: import org.apache.aries.application.utils.filesystem.FileSystem;
1: import org.apache.aries.unittest.fixture.ArchiveFixture;
1: import org.apache.aries.unittest.fixture.ArchiveFixture.ZipFixture;
1: import org.junit.Before;
1: import org.junit.Test;
1: import org.junit.runner.RunWith;
1: import org.ops4j.pax.exam.Option;
0: import org.ops4j.pax.exam.junit.JUnit4TestRunner;
1: import org.osgi.framework.ServiceRegistration;
1: import org.osgi.service.blueprint.container.BlueprintEvent;
1: import org.osgi.service.blueprint.container.BlueprintListener;
0: 
0: 
0: @RunWith(JUnit4TestRunner.class)
1: public class MinimumImportsTest extends AbstractIntegrationTest {
0:   
0:   /* Use @Before not @BeforeClass so as to ensure that these resources
0:    * are created in the paxweb temp directory, and not in the svn tree 
0:    */
0:   static boolean createdApplications = false;
0:   @Before
0:   public static void createApplications() throws Exception {
0: 
0:     if (createdApplications) { 
0:       return;
0:     }
0:     ZipFixture testEba = ArchiveFixture.newZip()
0:       .jar("org.apache.aries.application.itests.minimports.jar")
0:         .manifest().symbolicName("org.apache.aries.application.itests.minimports")
0:           .attribute("Bundle-Version", "1.0.0")
0:           .attribute("Import-Package", "org.apache.aries.application.management")
0:           .end()
0:         .binary("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class", 
0:             MinimumImportsTest.class.getClassLoader().getResourceAsStream("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class"))
0:         .binary("OSGI-INF/blueprint/app-mgr-client.xml", 
0:             MinimumImportsTest.class.getClassLoader().getResourceAsStream("app-mgr-client.xml"))
0:         .end();
0:       
0:     FileOutputStream fout = new FileOutputStream("appmgrclienttest.eba");
0:     testEba.writeOut(fout);
0:     fout.close();
0:     
0:     createdApplications = true;
0:   }
0:   
0:   public static class AppMgrClientBlueprintListener implements BlueprintListener {
0:     
0:     Boolean success = null;
0:     
0:     public void blueprintEvent(BlueprintEvent event) {
0:       if (event.getBundle().getSymbolicName().equals(
0:           "org.apache.aries.application.itests.minimports")) {
0:         if (event.getType() == event.FAILURE) {
0:           success = Boolean.FALSE;
0:         }
0:         if (event.getType() == event.CREATED) {
0:           success = Boolean.TRUE;
0:         }
0:       }
0:     }
0:   }
0:   
0:   @Test
0:   public void testAppUsingAriesApplicationManager() throws Exception {
0:     
0:     // Register a BlueprintListener to listen for the events from the BlueprintContainer for the bundle in the appmgrclienttest.eba
0:     
0:     AppMgrClientBlueprintListener acbl = new AppMgrClientBlueprintListener();
0:     ServiceRegistration sr = bundleContext.registerService("org.osgi.service.blueprint.container.BlueprintListener", acbl, null);
0:     
0:     AriesApplicationManager manager = getOsgiService(AriesApplicationManager.class);
0:     AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("appmgrclienttest.eba")));
0:     AriesApplicationContext ctx = manager.install(app);
0:     ctx.start();
0:     
0:     int sleepfor = 3000;
0:     while ((acbl.success == null || acbl.success == false) && sleepfor > 0) {
0:       Thread.sleep(100);
0:       sleepfor-=100;
0:     }
0:     assertNotNull("Timed out - didn't receive Blueprint CREATED or FAILURE event", acbl.success);
0:     assertTrue("Received Blueprint FAILURE event", acbl.success);
0:     
0:     ctx.stop();
0:     manager.uninstall(ctx);
0:     sr.unregister();
0:   }
0:   
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] configuration() {
0:     Option[] options = options(
0:         // Log
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-api"),
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-service"),
0:         // Felix Config Admin
0:         mavenBundle("org.apache.felix", "org.apache.felix.configadmin"),
0:         // Felix mvn url handler
0:         mavenBundle("org.ops4j.pax.url", "pax-url-mvn"),
0: 
0:         // this is how you set the default log level when using pax
0:         // logging (logProfile)
0:         systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("DEBUG"),
0: 
0:         // Bundles
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.api"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces"),
0:         mavenBundle("org.apache.aries", "org.apache.aries.util"),
0:         mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint"), 
0:         mavenBundle("org.osgi", "org.osgi.compendium"),
0:         mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit"),
0:         
0:         /* For debugging, uncomment the next two lines
0:         vmOption ("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5006"),
0:         waitForFrameworkStartup(),
0:         
0:         and add these imports:
0:         import static org.ops4j.pax.exam.CoreOptions.waitForFrameworkStartup;
0:         import static org.ops4j.pax.exam.container.def.PaxRunnerOptions.vmOption;
0:         */
0: 
0:         equinox().version("3.5.0"));
0:     options = updateOptions(options);
0:     return options;
0:   }
0: }
commit:948b72b
/////////////////////////////////////////////////////////////////////////
0: import org.apache.aries.application.management.AriesApplicationContext;
/////////////////////////////////////////////////////////////////////////
0:     AriesApplicationContext ctx = manager.install(app);
author:David Jencks
-------------------------------------------------------------------------------
commit:0aad0ca
/////////////////////////////////////////////////////////////////////////
0:     assertTrue("Received Blueprint FAILURE event", acbl.success);
author:Jeremy Hughes
-------------------------------------------------------------------------------
commit:eaca117
/////////////////////////////////////////////////////////////////////////
commit:1d69f01
/////////////////////////////////////////////////////////////////////////
0: /*
0:  * Licensed to the Apache Software Foundation (ASF) under one
0:  * or more contributor license agreements.  See the NOTICE file
0:  * distributed with this work for additional information
0:  * regarding copyright ownership.  The ASF licenses this file
0:  * to you under the Apache License, Version 2.0 (the
0:  * "License"); you may not use this file except in compliance
0:  * with the License.  You may obtain a copy of the License at
0:  *
0:  *   http://www.apache.org/licenses/LICENSE-2.0
0:  *
0:  * Unless required by applicable law or agreed to in writing,
0:  * software distributed under the License is distributed on an
0:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
0:  * KIND, either express or implied.  See the License for the
0:  * specific language governing permissions and limitations
0:  * under the License.
0:  */
0: package org.apache.aries.application.runtime.itests;
0: 
0: import java.io.File;
0: import java.io.FileOutputStream;
0: 
0: import static org.junit.Assert.assertNotNull;
0: import static org.junit.Assert.assertTrue;
0: import static org.ops4j.pax.exam.CoreOptions.equinox;
0: import static org.ops4j.pax.exam.CoreOptions.options;
0: import static org.ops4j.pax.exam.CoreOptions.systemProperty;
0: 
0: import org.apache.aries.application.management.ApplicationContext;
0: import org.apache.aries.application.management.AriesApplication;
0: import org.apache.aries.application.management.AriesApplicationManager;
0: import org.apache.aries.application.utils.filesystem.FileSystem;
0: import org.apache.aries.unittest.fixture.ArchiveFixture;
0: import org.apache.aries.unittest.fixture.ArchiveFixture.ZipFixture;
0: import org.junit.Before;
0: import org.junit.Test;
0: import org.junit.runner.RunWith;
0: import org.ops4j.pax.exam.Option;
0: import org.ops4j.pax.exam.junit.JUnit4TestRunner;
0: import org.osgi.framework.ServiceRegistration;
0: import org.osgi.service.blueprint.container.BlueprintEvent;
0: import org.osgi.service.blueprint.container.BlueprintListener;
0: 
0: 
0: @RunWith(JUnit4TestRunner.class)
0: public class MinimumImportsTest extends AbstractIntegrationTest {
0:   
0:   /* Use @Before not @BeforeClass so as to ensure that these resources
0:    * are created in the paxweb temp directory, and not in the svn tree 
0:    */
0:   static boolean createdApplications = false;
0:   @Before
0:   public static void createApplications() throws Exception {
0: 
0:     if (createdApplications) { 
0:       return;
0:     }
0:     ZipFixture testEba = ArchiveFixture.newZip()
0:       .jar("org.apache.aries.application.itests.minimports.jar")
0:         .manifest().symbolicName("org.apache.aries.application.itests.minimports")
0:           .attribute("Bundle-Version", "1.0.0")
0:           .attribute("Import-Package", "org.apache.aries.application.management")
0: // use this line instead of the one above to workaround ARIES-159
0: //          .attribute("Import-Package", "org.apache.aries.application.management,org.apache.aries.application.filesystem")
0:           .end()
0:         .binary("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class", 
0:             MinimumImportsTest.class.getClassLoader().getResourceAsStream("org/apache/aries/application/sample/appmgrclient/AppMgrClient.class"))
0:         .binary("OSGI-INF/blueprint/app-mgr-client.xml", 
0:             MinimumImportsTest.class.getClassLoader().getResourceAsStream("app-mgr-client.xml"))
0:         .end();
0:       
0:     FileOutputStream fout = new FileOutputStream("appmgrclienttest.eba");
0:     testEba.writeOut(fout);
0:     fout.close();
0:     
0:     createdApplications = true;
0:   }
0:   
0:   public static class AppMgrClientBlueprintListener implements BlueprintListener {
0:     
0:     Boolean success = null;
0:     
0:     public void blueprintEvent(BlueprintEvent event) {
0:       if (event.getBundle().getSymbolicName().equals(
0:           "org.apache.aries.application.itests.minimports")) {
0:         if (event.getType() == event.FAILURE) {
0:           success = Boolean.FALSE;
0:         }
0:         if (event.getType() == event.CREATED) {
0:           success = Boolean.TRUE;
0:         }
0:       }
0:     }
0:   }
0:   
0:   @Test
0:   public void testAppUsingAriesApplicationManager() throws Exception {
0:     
0:     // Register a BlueprintListener to listen for the events from the BlueprintContainer for the bundle in the appmgrclienttest.eba
0:     
0:     AppMgrClientBlueprintListener acbl = new AppMgrClientBlueprintListener();
0:     ServiceRegistration sr = bundleContext.registerService("org.osgi.service.blueprint.container.BlueprintListener", acbl, null);
0:     
0:     AriesApplicationManager manager = getOsgiService(AriesApplicationManager.class);
0:     AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("appmgrclienttest.eba")));
0:     ApplicationContext ctx = manager.install(app);
0:     ctx.start();
0:     
0:     int sleepfor = 3000;
0:     while ((acbl.success == null || acbl.success == false) && sleepfor > 0) {
0:       Thread.sleep(100);
0:       sleepfor-=100;
0:     }
0:     assertNotNull("Timed out - didn't receive Blueprint CREATED or FAILURE event", acbl.success);
0:     assertTrue("Recevied Blueprint FAILURE event", acbl.success);
0:     
0:     ctx.stop();
0:     manager.uninstall(ctx);
0:     sr.unregister();
0:   }
0:   
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] configuration() {
0:     Option[] options = options(
0:         // Log
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-api"),
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-service"),
0:         // Felix Config Admin
0:         mavenBundle("org.apache.felix", "org.apache.felix.configadmin"),
0:         // Felix mvn url handler
0:         mavenBundle("org.ops4j.pax.url", "pax-url-mvn"),
0: 
0:         // this is how you set the default log level when using pax
0:         // logging (logProfile)
0:         systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("DEBUG"),
0: 
0:         // Bundles
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.api"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces"),
0:         mavenBundle("org.apache.aries", "org.apache.aries.util"),
0:         mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint"), 
0:         mavenBundle("org.osgi", "org.osgi.compendium"),
0:         mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit"),
0:         
0:         /* For debugging, uncomment the next two lines
0:         vmOption ("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5006"),
0:         waitForFrameworkStartup(),
0:         
0:         and add these imports:
0:         import static org.ops4j.pax.exam.CoreOptions.waitForFrameworkStartup;
0:         import static org.ops4j.pax.exam.container.def.PaxRunnerOptions.vmOption;
0:         */
0: 
0:         equinox().version("3.5.0"));
0:     options = updateOptions(options);
0:     return options;
0:   }
0: }
============================================================================