1:f34e6a1: /*
1:694eb45:  * Licensed to the Apache Software Foundation (ASF) under one
1:694eb45:  * or more contributor license agreements.  See the NOTICE file
1:694eb45:  * distributed with this work for additional information
1:694eb45:  * regarding copyright ownership.  The ASF licenses this file
1:694eb45:  * to you under the Apache License, Version 2.0 (the
1:694eb45:  * "License"); you may not use this file except in compliance
1:694eb45:  * with the License.  You may obtain a copy of the License at
1:694eb45:  *
1:694eb45:  *   http://www.apache.org/licenses/LICENSE-2.0
1:694eb45:  *
1:694eb45:  * Unless required by applicable law or agreed to in writing,
1:694eb45:  * software distributed under the License is distributed on an
1:694eb45:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
1:694eb45:  * KIND, either express or implied.  See the License for the
1:694eb45:  * specific language governing permissions and limitations
1:694eb45:  * under the License.
1:f34e6a1:  */
1:694eb45: package org.apache.aries.application.runtime.itests;
1:a12aa78: 
1:374c5a4: import static org.junit.Assert.assertEquals;
1:0223547: import static org.ops4j.pax.exam.CoreOptions.*;
1:a12aa78: 
1:a12aa78: import java.io.BufferedReader;
1:694eb45: import java.io.File;
1:694eb45: import java.io.FileOutputStream;
1:a12aa78: import java.io.FileWriter;
1:a12aa78: import java.io.InputStreamReader;
1:a12aa78: 
1:694eb45: import org.apache.aries.application.management.AriesApplication;
1:374c5a4: import org.apache.aries.application.management.AriesApplicationContext;
1:694eb45: import org.apache.aries.application.management.AriesApplicationManager;
1:86224ba: import org.apache.aries.itest.AbstractIntegrationTest;
1:374c5a4: import org.apache.aries.sample.HelloWorld;
1:694eb45: import org.apache.aries.unittest.fixture.ArchiveFixture;
1:694eb45: import org.apache.aries.unittest.fixture.ArchiveFixture.ZipFixture;
1:910fec0: import org.apache.aries.util.filesystem.FileSystem;
1:248447e: import org.apache.felix.bundlerepository.Capability;
1:248447e: import org.apache.felix.bundlerepository.Repository;
1:248447e: import org.apache.felix.bundlerepository.RepositoryAdmin;
1:248447e: import org.apache.felix.bundlerepository.Resource;
1:694eb45: import org.junit.Before;
1:694eb45: import org.junit.Test;
1:694eb45: import org.junit.runner.RunWith;
1:0223547: import org.ops4j.pax.exam.Configuration;
1:694eb45: import org.ops4j.pax.exam.Option;
1:0223547: import org.ops4j.pax.exam.junit.PaxExam;
1:0223547: import org.ops4j.pax.exam.spi.reactors.ExamReactorStrategy;
1:0223547: import org.ops4j.pax.exam.spi.reactors.PerClass;
1:a12aa78: 
1:0223547: @RunWith(PaxExam.class)
1:0223547: @ExamReactorStrategy(PerClass.class)
1:694eb45: public class OBRAppManagerTest extends AbstractIntegrationTest {
1:a12aa78: 
1:0223547:     /* Use @Before not @BeforeClass so as to ensure that these resources
1:0223547:      * are created in the paxweb temp directory, and not in the svn tree
1:0223547:      */
1:0223547:     static boolean createdApplications = false;
1:d3efe20: 
1:0223547:     @Before
1:0223547:     public void createApplications() throws Exception {
1:0223547:         if (createdApplications) {
1:0223547:             return;
1:0223547:         }
1:0223547:         ZipFixture testBundle = ArchiveFixture.newZip()
1:0223547:                 .manifest().symbolicName("org.apache.aries.sample.bundle")
1:0223547:                 .attribute("Bundle-Version", "1.0.0")
1:0223547:                 .attribute("Import-Package", "org.apache.aries.sample")
1:0223547:                 .attribute("Export-Package", "org.apache.aries.sample.impl")
1:0223547:                 .end()
1:0223547:                 .binary("org/apache/aries/sample/impl/HelloWorldImpl.class",
1:0223547:                         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("org/apache/aries/sample/impl/HelloWorldImpl.class"))
1:0223547:                 .end();
1:f34e6a1: 
1:0223547:         FileOutputStream fout = new FileOutputStream("bundle.jar");
1:0223547:         testBundle.writeOut(fout);
1:0223547:         fout.close();
1:8069959: 
1:0223547:         ZipFixture testEba = ArchiveFixture.newZip()
1:0223547:                 .jar("sample.jar")
1:0223547:                 .manifest().symbolicName("org.apache.aries.sample")
1:0223547:                 .attribute("Bundle-Version", "1.0.0")
1:0223547:                 .attribute("Import-Package", "org.apache.aries.sample.impl,org.apache.aries.sample")
1:0223547:                 .end()
1:0223547:                 .binary("OSGI-INF/blueprint/sample-blueprint.xml",
1:0223547:                         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/sample-blueprint.xml"))
1:0223547:                 .end()
1:0223547:                 .binary("META-INF/APPLICATION.MF",
1:0223547:                         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/APPLICATION.MF"))
1:0223547:                 .end();
1:0223547:         fout = new FileOutputStream("test.eba");
1:0223547:         testEba.writeOut(fout);
1:0223547:         fout.close();
1:8069959: 
1:0223547:         StringBuilder repositoryXML = new StringBuilder();
1:8069959: 
1:0223547:         BufferedReader reader = new BufferedReader(new InputStreamReader(OBRAppManagerTest.class.getResourceAsStream("/obr/repository.xml")));
1:0223547:         String line;
1:a12aa78: 
1:0223547:         while ((line = reader.readLine()) != null) {
1:0223547:             repositoryXML.append(line);
1:0223547:             repositoryXML.append("\r\n");
1:0223547:         }
1:a12aa78: 
1:0223547:         String repo = repositoryXML.toString().replaceAll("bundle_location", new File("bundle.jar").toURI().toString());
1:a12aa78: 
1:0223547:         System.out.println(repo);
1:a12aa78: 
1:0223547:         FileWriter writer = new FileWriter("repository.xml");
1:0223547:         writer.write(repo);
1:0223547:         writer.close();
1:a12aa78: 
1:0223547:         createdApplications = true;
1:0223547:     }
1:a12aa78: 
1:0223547:     @Test
1:0223547:     public void testAppWithApplicationManifest() throws Exception {
1:a12aa78: 
1:0223547:         RepositoryAdmin repositoryAdmin = context().getService(RepositoryAdmin.class);
1:0223547: 
1:0223547:         repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
1:0223547: 
1:0223547:         Repository[] repos = repositoryAdmin.listRepositories();
1:0223547: 
1:0223547:         for (Repository repo : repos) {
1:0223547:             Resource[] resources = repo.getResources();
1:0223547: 
1:0223547:             for (Resource r : resources) {
1:0223547:                 Capability[] cs = r.getCapabilities();
1:0223547: 
1:0223547:                 for (Capability c : cs) {
1:0223547:                     System.out.println(c.getName() + " : " + c.getProperties());
1:0223547:                 }
1:0223547:             }
1:0223547:         }
1:0223547: 
1:0223547:         AriesApplicationManager manager = context().getService(AriesApplicationManager.class);
1:0223547:         AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("test.eba")));
1:0223547:         app = manager.resolve(app);
1:0223547:         //installing requires a valid url for the bundle in repository.xml.
1:0223547:         AriesApplicationContext ctx = manager.install(app);
1:0223547:         ctx.start();
1:0223547: 
1:0223547:         HelloWorld hw = context().getService(HelloWorld.class);
1:0223547:         String result = hw.getMessage();
1:0223547:         assertEquals(result, "hello world");
1:0223547: 
1:0223547:         ctx.stop();
1:0223547:         manager.uninstall(ctx);
1:0223547:     }
1:0223547: 
1:0223547:     @Configuration
1:0223547:     public static Option[] configuration() {
1:0223547:         return options(
1:0223547: 
1:0223547:                 // framework / core bundles
1:0223547:                 mavenBundle("org.osgi", "org.osgi.core").versionAsInProject(),
1:0223547:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-api").versionAsInProject(),
1:0223547:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-service").versionAsInProject(),
1:0223547: 
1:0223547:                 // Logging
1:0223547:                 systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("INFO"),
1:0223547: 
1:0223547:                 // Bundles
1:0223547:                 junitBundles(),
1:0223547:                 mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit").versionAsInProject(),
1:0223547: 
1:0223547:                 // Bundles
1:0223547:                 mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint").versionAsInProject(),
1:0223547:                 mavenBundle("org.ow2.asm", "asm-all").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.proxy", "org.apache.aries.proxy").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries", "org.apache.aries.util").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.api").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.modeller").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.default.local.platform").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.management").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime").versionAsInProject(),
1:0223547:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces").versionAsInProject());
1:0223547:     }
1:a12aa78: 
1:f34e6a1: }
============================================================================
author:Christian Schneider
-------------------------------------------------------------------------------
commit:e334773
/////////////////////////////////////////////////////////////////////////
author:Jean-Baptiste Onofre
-------------------------------------------------------------------------------
commit:0223547
/////////////////////////////////////////////////////////////////////////
1: import static org.ops4j.pax.exam.CoreOptions.*;
/////////////////////////////////////////////////////////////////////////
1: import org.ops4j.pax.exam.Configuration;
1: import org.ops4j.pax.exam.junit.PaxExam;
1: import org.ops4j.pax.exam.spi.reactors.ExamReactorStrategy;
1: import org.ops4j.pax.exam.spi.reactors.PerClass;
1: @RunWith(PaxExam.class)
1: @ExamReactorStrategy(PerClass.class)
1:     /* Use @Before not @BeforeClass so as to ensure that these resources
1:      * are created in the paxweb temp directory, and not in the svn tree
1:      */
1:     static boolean createdApplications = false;
1:     @Before
1:     public void createApplications() throws Exception {
1:         if (createdApplications) {
1:             return;
1:         }
1:         ZipFixture testBundle = ArchiveFixture.newZip()
1:                 .manifest().symbolicName("org.apache.aries.sample.bundle")
1:                 .attribute("Bundle-Version", "1.0.0")
1:                 .attribute("Import-Package", "org.apache.aries.sample")
1:                 .attribute("Export-Package", "org.apache.aries.sample.impl")
1:                 .end()
1:                 .binary("org/apache/aries/sample/impl/HelloWorldImpl.class",
1:                         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("org/apache/aries/sample/impl/HelloWorldImpl.class"))
1:                 .end();
1:         FileOutputStream fout = new FileOutputStream("bundle.jar");
1:         testBundle.writeOut(fout);
1:         fout.close();
1:         ZipFixture testEba = ArchiveFixture.newZip()
1:                 .jar("sample.jar")
1:                 .manifest().symbolicName("org.apache.aries.sample")
1:                 .attribute("Bundle-Version", "1.0.0")
1:                 .attribute("Import-Package", "org.apache.aries.sample.impl,org.apache.aries.sample")
1:                 .end()
1:                 .binary("OSGI-INF/blueprint/sample-blueprint.xml",
1:                         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/sample-blueprint.xml"))
1:                 .end()
1:                 .binary("META-INF/APPLICATION.MF",
1:                         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/APPLICATION.MF"))
1:                 .end();
1:         fout = new FileOutputStream("test.eba");
1:         testEba.writeOut(fout);
1:         fout.close();
1:         StringBuilder repositoryXML = new StringBuilder();
1:         BufferedReader reader = new BufferedReader(new InputStreamReader(OBRAppManagerTest.class.getResourceAsStream("/obr/repository.xml")));
1:         String line;
1:         while ((line = reader.readLine()) != null) {
1:             repositoryXML.append(line);
1:             repositoryXML.append("\r\n");
1:         }
1:         String repo = repositoryXML.toString().replaceAll("bundle_location", new File("bundle.jar").toURI().toString());
1:         System.out.println(repo);
1:         FileWriter writer = new FileWriter("repository.xml");
1:         writer.write(repo);
1:         writer.close();
1:         createdApplications = true;
1:     }
1:     @Test
1:     public void testAppWithApplicationManifest() throws Exception {
1:         RepositoryAdmin repositoryAdmin = context().getService(RepositoryAdmin.class);
1: 
1:         repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
1: 
1:         Repository[] repos = repositoryAdmin.listRepositories();
1: 
1:         for (Repository repo : repos) {
1:             Resource[] resources = repo.getResources();
1: 
1:             for (Resource r : resources) {
1:                 Capability[] cs = r.getCapabilities();
1: 
1:                 for (Capability c : cs) {
1:                     System.out.println(c.getName() + " : " + c.getProperties());
1:                 }
1:             }
1:         }
1: 
1:         AriesApplicationManager manager = context().getService(AriesApplicationManager.class);
1:         AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("test.eba")));
1:         app = manager.resolve(app);
1:         //installing requires a valid url for the bundle in repository.xml.
1:         AriesApplicationContext ctx = manager.install(app);
1:         ctx.start();
1: 
1:         HelloWorld hw = context().getService(HelloWorld.class);
1:         String result = hw.getMessage();
1:         assertEquals(result, "hello world");
1: 
1:         ctx.stop();
1:         manager.uninstall(ctx);
1:     }
1: 
1:     @Configuration
1:     public static Option[] configuration() {
1:         return options(
1: 
1:                 // framework / core bundles
1:                 mavenBundle("org.osgi", "org.osgi.core").versionAsInProject(),
0:                 mavenBundle("org.osgi", "org.osgi.compendium").versionAsInProject(),
1:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-api").versionAsInProject(),
1:                 mavenBundle("org.ops4j.pax.logging", "pax-logging-service").versionAsInProject(),
1: 
1:                 // Logging
1:                 systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("INFO"),
1: 
1:                 // Bundles
1:                 junitBundles(),
1:                 mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit").versionAsInProject(),
1: 
1:                 // Bundles
1:                 mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint").versionAsInProject(),
1:                 mavenBundle("org.ow2.asm", "asm-all").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.proxy", "org.apache.aries.proxy").versionAsInProject(),
1:                 mavenBundle("org.apache.aries", "org.apache.aries.util").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.api").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.modeller").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.default.local.platform").versionAsInProject(),
1:                 mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.management").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime").versionAsInProject(),
1:                 mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces").versionAsInProject());
1:     }
author:John Ross
-------------------------------------------------------------------------------
commit:cffbcb0
/////////////////////////////////////////////////////////////////////////
0: import static org.apache.aries.itest.ExtraOptions.mavenBundle;
0: import static org.apache.aries.itest.ExtraOptions.paxLogging;
0: import static org.apache.aries.itest.ExtraOptions.testOptions;
/////////////////////////////////////////////////////////////////////////
0: import org.ops4j.pax.exam.junit.MavenConfiguredJUnit4TestRunner;
0: @RunWith(MavenConfiguredJUnit4TestRunner.class)
/////////////////////////////////////////////////////////////////////////
0:   public static Option[] configuration()
0: 			  PaxRunnerOptions.rawPaxRunnerOption("config", "classpath:ss-runner.properties")        
commit:f34e6a1
/////////////////////////////////////////////////////////////////////////
1:   /*
0:    * Commented out to avoid an NPE due to a ConcurrentModificationException in
0:    * the Aries build. See https://issues.apache.org/jira/browse/ARIES-931.
1:    */
0:   //@org.ops4j.pax.exam.junit.Configuration
/////////////////////////////////////////////////////////////////////////
0:   /*
0:    * Commented out to avoid an NPE due to a ConcurrentModificationException in
0:    * the Aries build. See https://issues.apache.org/jira/browse/ARIES-931.
0:    */
0:   //@org.ops4j.pax.exam.junit.Configuration
/////////////////////////////////////////////////////////////////////////
1:   
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] equinox38Options()
0:   {
0: 	  return testOptions(
0: 			  generalConfiguration(),
0: 			  PaxRunnerOptions.rawPaxRunnerOption("config", "classpath:ss-runner.properties"),          
0: 	          equinox().version("3.8.0.V20120529-1548")
0: 	          );
1:   }
author:Holly Cummins
-------------------------------------------------------------------------------
commit:8069959
/////////////////////////////////////////////////////////////////////////
0: import org.ops4j.pax.exam.container.def.PaxRunnerOptions;
/////////////////////////////////////////////////////////////////////////
0:   public static Option[] generalConfiguration() {
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.osgi", "org.osgi.compendium")
/////////////////////////////////////////////////////////////////////////
0:         );
1:   
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] equinox35Options()
0:   {
0: 	  return testOptions(
0: 			  generalConfiguration(),
0: 	          equinox().version("3.5.0")
0: 	          );
0:   }
1: 
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] equinox37Options()
0:   {
0: 	  return testOptions(
0: 			  generalConfiguration(),
0: 			  PaxRunnerOptions.rawPaxRunnerOption("config", "classpath:ss-runner.properties"),          
0: 	          equinox().version("3.7.0.v20110613")
0: 	          );
0:   }
1: 
author:Emily Jiang
-------------------------------------------------------------------------------
commit:2b7f337
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.ow2.asm", "asm-all"),
author:Valentin Mahrwald
-------------------------------------------------------------------------------
commit:86224ba
/////////////////////////////////////////////////////////////////////////
0: import static org.apache.aries.itest.ExtraOptions.*;
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.itest.AbstractIntegrationTest;
/////////////////////////////////////////////////////////////////////////
0: 	    RepositoryAdmin repositoryAdmin = context().getService(RepositoryAdmin.class);
/////////////////////////////////////////////////////////////////////////
0: 	    AriesApplicationManager manager = context().getService(AriesApplicationManager.class);
0: 	    HelloWorld hw = context().getService(HelloWorld.class);
/////////////////////////////////////////////////////////////////////////
0:     return testOptions(
0:         paxLogging("DEBUG"),
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
commit:910fec0
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.util.filesystem.FileSystem;
author:Alasdair Nottingham
-------------------------------------------------------------------------------
commit:be6ac25
/////////////////////////////////////////////////////////////////////////
commit:5254613
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("asm", "asm-all"),
0:         mavenBundle("org.apache.aries.proxy", "org.apache.aries.proxy"),
commit:248447e
/////////////////////////////////////////////////////////////////////////
1: import org.apache.felix.bundlerepository.Capability;
1: import org.apache.felix.bundlerepository.Repository;
1: import org.apache.felix.bundlerepository.RepositoryAdmin;
1: import org.apache.felix.bundlerepository.Resource;
commit:5e15171
/////////////////////////////////////////////////////////////////////////
0:     app = manager.resolve(app);
commit:a12aa78
/////////////////////////////////////////////////////////////////////////
0: import static org.ops4j.pax.exam.CoreOptions.equinox;
0: import static org.ops4j.pax.exam.CoreOptions.options;
0: import static org.ops4j.pax.exam.CoreOptions.systemProperty;
1: 
1: import java.io.BufferedReader;
1: import java.io.FileWriter;
1: import java.io.InputStreamReader;
/////////////////////////////////////////////////////////////////////////
0: import org.osgi.service.obr.Capability;
0: import org.osgi.service.obr.Repository;
0: import org.osgi.service.obr.Resource;
/////////////////////////////////////////////////////////////////////////
1:     
0:     StringBuilder repositoryXML = new StringBuilder();
1:     
0:     BufferedReader reader = new BufferedReader(new InputStreamReader(OBRAppManagerTest.class.getResourceAsStream("/obr/repository.xml")));
0:     String line;
1:     
0:     while ((line = reader.readLine()) != null) {
0:       repositoryXML.append(line);
0:       repositoryXML.append("\r\n");
0:     }
1:     
0:     String repo = repositoryXML.toString().replaceAll("bundle_location", new File("bundle.jar").getAbsolutePath());
1:     
0:     System.out.println(repo);
1:     
0:     FileWriter writer = new FileWriter("repository.xml");
0:     writer.write(repo);
0:     writer.close();
1:     
1:     
0:     repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
0:     Repository[] repos = repositoryAdmin.listRepositories();
1:     
0:     for (Repository repo : repos) {
0:       Resource[] resources = repo.getResources();
1:       
0:       for (Resource r : resources) {
0:         Capability[] cs = r.getCapabilities();
1:         
0:         for (Capability c : cs) {
0:           System.out.println(c.getName() + " : " + c.getProperties());
0:         }
0:       }
0:     }
1:     
author:Mark Nuttall
-------------------------------------------------------------------------------
commit:d3efe20
/////////////////////////////////////////////////////////////////////////
1: 	    
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.default.local.platform"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime"),
commit:a0eca03
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.noop.platform.repo"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.noop.postresolve.process"),
commit:58f55bd
/////////////////////////////////////////////////////////////////////////
0: import org.apache.felix.bundlerepository.Capability;
0: import org.apache.felix.bundlerepository.Repository;
0: import org.apache.felix.bundlerepository.RepositoryAdmin;
0: import org.apache.felix.bundlerepository.Resource;
/////////////////////////////////////////////////////////////////////////
0: 
0:         mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint"),
0:         mavenBundle("org.apache.aries", "org.apache.aries.util"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime").noStart(),
0: 
commit:92429ff
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.deployment.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.modeller"),
0:         mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr"),
/////////////////////////////////////////////////////////////////////////
0:         //        /* For debugging, uncomment the next two lines
0:         //        vmOption ("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"),
0:         //        waitForFrameworkStartup(),
0:          */
commit:4870be3
/////////////////////////////////////////////////////////////////////////
0:   
0:   @Before
commit:374c5a4
/////////////////////////////////////////////////////////////////////////
1: import static org.junit.Assert.assertEquals;
/////////////////////////////////////////////////////////////////////////
1: import org.apache.aries.application.management.AriesApplicationContext;
1: import org.apache.aries.sample.HelloWorld;
/////////////////////////////////////////////////////////////////////////
0: 	    if (createdApplications) {
0: 	      return;
0: 	    }
0: 	    ZipFixture testBundle = ArchiveFixture.newZip()
0: 	        .manifest().symbolicName("org.apache.aries.sample.bundle")
0: 	          .attribute("Bundle-Version", "1.0.0")
0: 	          .attribute("Import-Package", "org.apache.aries.sample")
0: 	          .attribute("Export-Package", "org.apache.aries.sample.impl")
0: 	          .end()
0: 	        .binary("org/apache/aries/sample/impl/HelloWorldImpl.class",
0: 	            OBRAppManagerTest.class.getClassLoader().getResourceAsStream("org/apache/aries/sample/impl/HelloWorldImpl.class"))
0: 	        .end();
0: 	    FileOutputStream fout = new FileOutputStream("bundle.jar");
0: 	    testBundle.writeOut(fout);
0: 	    fout.close();
0: 	    ZipFixture testEba = ArchiveFixture.newZip()
0: 	      .jar("sample.jar")
0: 	        .manifest().symbolicName("org.apache.aries.sample")
0: 	          .attribute("Bundle-Version", "1.0.0")
0: 	          .attribute("Import-Package", "org.apache.aries.sample.impl,org.apache.aries.sample")
0: 	          .end()
0: 	        .binary("OSGI-INF/blueprint/sample-blueprint.xml",
0: 	            OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/sample-blueprint.xml"))
0: 	        .end()
0: 	         .binary("META-INF/APPLICATION.MF",
0: 	        OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/APPLICATION.MF"))
0: 	        .end();
0: 	    fout = new FileOutputStream("test.eba");
0: 	    testEba.writeOut(fout);
0: 	    fout.close();
0: 	    
0: 	    StringBuilder repositoryXML = new StringBuilder();
0: 	    
0: 	    BufferedReader reader = new BufferedReader(new InputStreamReader(OBRAppManagerTest.class.getResourceAsStream("/obr/repository.xml")));
0: 	    String line;
0: 	    
0: 	    while ((line = reader.readLine()) != null) {
0: 	      repositoryXML.append(line);
0: 	      repositoryXML.append("\r\n");
0: 	    }
0: 	    
0: 	    String repo = repositoryXML.toString().replaceAll("bundle_location", new File("bundle.jar").toURI().toString());
0: 	    
0: 	    System.out.println(repo);
0: 	    
0: 	    FileWriter writer = new FileWriter("repository.xml");
0: 	    writer.write(repo);
0: 	    writer.close();
0: 	    
0: 	    createdApplications = true;
0: 	  }
0: 	  @Test
0: 	  public void testAppWithApplicationManifest() throws Exception {
0: 	    startApplicationRuntimeBundle();
0: 	    RepositoryAdmin repositoryAdmin = getOsgiService(RepositoryAdmin.class);
0: 	    
0: 	    repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
0: 	    Repository[] repos = repositoryAdmin.listRepositories();
0: 	    
0: 	    for (Repository repo : repos) {
0: 	      Resource[] resources = repo.getResources();
0: 	      
0: 	      for (Resource r : resources) {
0: 	        Capability[] cs = r.getCapabilities();
0: 	        
0: 	        for (Capability c : cs) {
0: 	          System.out.println(c.getName() + " : " + c.getProperties());
0: 	        }
0: 	      }
0: 	    }
0: 	    
0: 	    AriesApplicationManager manager = getOsgiService(AriesApplicationManager.class);
0: 	    AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("test.eba")));
0: 	    app = manager.resolve(app);
0: 	    //installing requires a valid url for the bundle in repository.xml.
0: 	    AriesApplicationContext ctx = manager.install(app);
0: 	    ctx.start();
0: 	    HelloWorld hw = getOsgiService(HelloWorld.class);
0: 	    String result = hw.getMessage();
0: 	    assertEquals (result, "hello world");
0: 	    ctx.stop();
0: 	    manager.uninstall(ctx);
0: 	  }
author:Lin Sun
-------------------------------------------------------------------------------
commit:48d72a7
/////////////////////////////////////////////////////////////////////////
0:     startApplicationRuntimeBundle();
0: 
/////////////////////////////////////////////////////////////////////////
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime").noStart(),
author:Jarek Gawor
-------------------------------------------------------------------------------
commit:694eb45
/////////////////////////////////////////////////////////////////////////
0: /*
1:  * Licensed to the Apache Software Foundation (ASF) under one
1:  * or more contributor license agreements.  See the NOTICE file
1:  * distributed with this work for additional information
1:  * regarding copyright ownership.  The ASF licenses this file
1:  * to you under the Apache License, Version 2.0 (the
1:  * "License"); you may not use this file except in compliance
1:  * with the License.  You may obtain a copy of the License at
1:  *
1:  *   http://www.apache.org/licenses/LICENSE-2.0
1:  *
1:  * Unless required by applicable law or agreed to in writing,
1:  * software distributed under the License is distributed on an
1:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
1:  * KIND, either express or implied.  See the License for the
1:  * specific language governing permissions and limitations
1:  * under the License.
0:  */
1: package org.apache.aries.application.runtime.itests;
0: 
0: import static org.ops4j.pax.exam.CoreOptions.equinox;
0: import static org.ops4j.pax.exam.CoreOptions.options;
0: import static org.ops4j.pax.exam.CoreOptions.systemProperty;
0: 
0: import java.io.BufferedReader;
1: import java.io.File;
1: import java.io.FileOutputStream;
0: import java.io.FileWriter;
0: import java.io.InputStreamReader;
0: 
1: import org.apache.aries.application.management.AriesApplication;
1: import org.apache.aries.application.management.AriesApplicationManager;
0: import org.apache.aries.application.utils.filesystem.FileSystem;
1: import org.apache.aries.unittest.fixture.ArchiveFixture;
1: import org.apache.aries.unittest.fixture.ArchiveFixture.ZipFixture;
1: import org.junit.Before;
1: import org.junit.Test;
1: import org.junit.runner.RunWith;
1: import org.ops4j.pax.exam.Option;
0: import org.ops4j.pax.exam.junit.JUnit4TestRunner;
0: import org.osgi.service.obr.Capability;
0: import org.osgi.service.obr.Repository;
0: import org.osgi.service.obr.RepositoryAdmin;
0: import org.osgi.service.obr.Resource;
0: 
0: @RunWith(JUnit4TestRunner.class)
1: public class OBRAppManagerTest extends AbstractIntegrationTest {
0: 
0:   /* Use @Before not @BeforeClass so as to ensure that these resources
0:    * are created in the paxweb temp directory, and not in the svn tree
0:    */
0:   static boolean createdApplications = false;
0:   @Before
0:   public static void createApplications() throws Exception {
0:     if (createdApplications) {
0:       return;
0:     }
0:     ZipFixture testBundle = ArchiveFixture.newZip()
0:         .manifest().symbolicName("org.apache.aries.sample")
0:           .attribute("Bundle-Version", "1.0.0")
0:           .attribute("Export-Package", "org.apache.aries.sample.impl")
0:           .end()
0:         .binary("org/apache/aries/sample/impl/HelloWorldImpl.class",
0:             OBRAppManagerTest.class.getClassLoader().getResourceAsStream("org/apache/aries/sample/impl/HelloWorldImpl.class"))
0:         .end();
0: 
0:     FileOutputStream fout = new FileOutputStream("bundle.jar");
0:     testBundle.writeOut(fout);
0:     fout.close();
0: 
0:     ZipFixture testEba = ArchiveFixture.newZip()
0:       .jar("sample.jar")
0:         .manifest().symbolicName("org.apache.aries.sample")
0:           .attribute("Bundle-Version", "1.0.0")
0:           .attribute("Import-Package", "org.apache.aries.sample.impl")
0:           .end()
0:         .binary("OSGI-INF/blueprint/sample-blueprint.xml",
0:             OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/sample-blueprint.xml"))
0:         .end()
0:          .binary("META-INF/APPLICATION.MF",
0:         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/APPLICATION.MF"))
0:         .end();
0:     fout = new FileOutputStream("test.eba");
0:     testEba.writeOut(fout);
0:     fout.close();
0:     
0:     StringBuilder repositoryXML = new StringBuilder();
0:     
0:     BufferedReader reader = new BufferedReader(new InputStreamReader(OBRAppManagerTest.class.getResourceAsStream("/obr/repository.xml")));
0:     String line;
0:     
0:     while ((line = reader.readLine()) != null) {
0:       repositoryXML.append(line);
0:       repositoryXML.append("\r\n");
0:     }
0:     
0:     String repo = repositoryXML.toString().replaceAll("bundle_location", new File("bundle.jar").getAbsolutePath());
0:     
0:     System.out.println(repo);
0:     
0:     FileWriter writer = new FileWriter("repository.xml");
0:     writer.write(repo);
0:     writer.close();
0:     
0:     createdApplications = true;
0:   }
0: 
0:   @Test
0:   public void testAppWithApplicationManifest() throws Exception {
0:     RepositoryAdmin repositoryAdmin = getOsgiService(RepositoryAdmin.class);
0:     
0:     repositoryAdmin.addRepository(new File("repository.xml").toURI().toURL());
0: 
0:     Repository[] repos = repositoryAdmin.listRepositories();
0:     
0:     for (Repository repo : repos) {
0:       Resource[] resources = repo.getResources();
0:       
0:       for (Resource r : resources) {
0:         Capability[] cs = r.getCapabilities();
0:         
0:         for (Capability c : cs) {
0:           System.out.println(c.getName() + " : " + c.getProperties());
0:         }
0:       }
0:     }
0:     
0:     AriesApplicationManager manager = getOsgiService(AriesApplicationManager.class);
0:     AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("test.eba")));
0:     app = manager.resolve(app);
0:     //installing requires a valid url for the bundle in repository.xml.
0: //    ApplicationContext ctx = manager.install(app);
0: //    ctx.start();
0: 
0: //    HelloWorld hw = getOsgiService(HelloWorld.class);
0: //    String result = hw.getMessage();
0: //    assertEquals (result, "hello world");
0: //
0: //    ctx.stop();
0: //    manager.uninstall(ctx);
0:   }
0: 
0: 
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] configuration() {
0:     Option[] options = options(
0:         // Log
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-api"),
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-service"),
0:         // Felix Config Admin
0:         mavenBundle("org.apache.felix", "org.apache.felix.configadmin"),
0:         // Felix mvn url handler
0:         mavenBundle("org.ops4j.pax.url", "pax-url-mvn"),
0: 
0:         // this is how you set the default log level when using pax
0:         // logging (logProfile)
0:         systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("DEBUG"),
0: 
0:         // Bundles
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.api"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr"),
0:         mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces"),
0:         mavenBundle("org.apache.aries", "org.apache.aries.util"),
0:         mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint"),
0:         mavenBundle("org.osgi", "org.osgi.compendium"),
0:         mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit"),
0: 
0: //        /* For debugging, uncomment the next two lines
0: //        vmOption ("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"),
0: //        waitForFrameworkStartup(),
0: 
0:         /* For debugging, uncomment the next two lines
0:         and add these imports:
0:         import static org.ops4j.pax.exam.CoreOptions.waitForFrameworkStartup;
0:         import static org.ops4j.pax.exam.container.def.PaxRunnerOptions.vmOption;
0:         */
0: 
0:         equinox().version("3.5.0"));
0:     options = updateOptions(options);
0:     return options;
0:   }
author:David Jencks
-------------------------------------------------------------------------------
commit:0aad0ca
/////////////////////////////////////////////////////////////////////////
0: /*
0:  * Licensed to the Apache Software Foundation (ASF) under one
0:  * or more contributor license agreements.  See the NOTICE file
0:  * distributed with this work for additional information
0:  * regarding copyright ownership.  The ASF licenses this file
0:  * to you under the Apache License, Version 2.0 (the
0:  * "License"); you may not use this file except in compliance
0:  * with the License.  You may obtain a copy of the License at
0:  *
0:  *   http://www.apache.org/licenses/LICENSE-2.0
0:  *
0:  * Unless required by applicable law or agreed to in writing,
0:  * software distributed under the License is distributed on an
0:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
0:  * KIND, either express or implied.  See the License for the
0:  * specific language governing permissions and limitations
0:  * under the License.
0:  */
0: package org.apache.aries.application.runtime.itests;
0: 
0: import java.io.File;
0: import java.io.FileOutputStream;
0: 
0: import org.apache.aries.application.management.ApplicationContext;
0: import org.apache.aries.application.management.AriesApplication;
0: import org.apache.aries.application.management.AriesApplicationManager;
0: import org.apache.aries.application.utils.filesystem.FileSystem;
0: import org.apache.aries.sample.HelloWorld;
0: import org.apache.aries.unittest.fixture.ArchiveFixture;
0: import org.apache.aries.unittest.fixture.ArchiveFixture.ZipFixture;
0: import org.junit.Before;
0: import org.junit.Test;
0: import org.junit.runner.RunWith;
0: import org.ops4j.pax.exam.Option;
0: import org.ops4j.pax.exam.junit.JUnit4TestRunner;
0: import org.osgi.service.obr.RepositoryAdmin;
0: 
0: import static org.junit.Assert.assertEquals;
0: import static org.ops4j.pax.exam.CoreOptions.equinox;
0: import static org.ops4j.pax.exam.CoreOptions.options;
0: import static org.ops4j.pax.exam.CoreOptions.systemProperty;
0: import static org.ops4j.pax.exam.CoreOptions.waitForFrameworkStartup;
0: import static org.ops4j.pax.exam.container.def.PaxRunnerOptions.vmOption;
0: 
0: @RunWith(JUnit4TestRunner.class)
0: public class OBRAppManagerTest extends AbstractIntegrationTest {
0: 
0:   /* Use @Before not @BeforeClass so as to ensure that these resources
0:    * are created in the paxweb temp directory, and not in the svn tree
0:    */
0:   static boolean createdApplications = false;
0:   @Before
0:   public static void createApplications() throws Exception {
0:     if (createdApplications) {
0:       return;
0:     }
0:     ZipFixture testBundle = ArchiveFixture.newZip()
0:         .manifest().symbolicName("org.apache.aries.sample")
0:           .attribute("Bundle-Version", "1.0.0")
0:           .attribute("Export-Package", "org.apache.aries.sample.impl")
0:           .end()
0:         .binary("org/apache/aries/sample/impl/HelloWorldImpl.class",
0:             OBRAppManagerTest.class.getClassLoader().getResourceAsStream("org/apache/aries/sample/impl/HelloWorldImpl.class"))
0:         .end();
0: 
0:     FileOutputStream fout = new FileOutputStream("bundle.jar");
0:     testBundle.writeOut(fout);
0:     fout.close();
0: 
0:     ZipFixture testEba = ArchiveFixture.newZip()
0:       .jar("sample.jar")
0:         .manifest().symbolicName("org.apache.aries.sample")
0:           .attribute("Bundle-Version", "1.0.0")
0:           .attribute("Import-Package", "org.apache.aries.sample.impl")
0:           .end()
0:         .binary("OSGI-INF/blueprint/sample-blueprint.xml",
0:             OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/sample-blueprint.xml"))
0:         .end()
0:          .binary("META-INF/APPLICATION.MF",
0:         OBRAppManagerTest.class.getClassLoader().getResourceAsStream("basic/APPLICATION.MF"))
0:         .end();
0:     fout = new FileOutputStream("test.eba");
0:     testEba.writeOut(fout);
0:     fout.close();
0: 
0:     createdApplications = true;
0:   }
0: 
0:   @Test
0:   public void testAppWithApplicationManifest() throws Exception {
0:     RepositoryAdmin repositoryAdmin = getOsgiService(RepositoryAdmin.class);
0:     repositoryAdmin.addRepository(OBRAppManagerTest.class.getClassLoader().getResource("obr/repository.xml"));
0: 
0:     AriesApplicationManager manager = getOsgiService(AriesApplicationManager.class);
0:     AriesApplication app = manager.createApplication(FileSystem.getFSRoot(new File("test.eba")));
0:     //installing requires a valid url for the bundle in repository.xml.
0: //    ApplicationContext ctx = manager.install(app);
0: //    ctx.start();
0: 
0: //    HelloWorld hw = getOsgiService(HelloWorld.class);
0: //    String result = hw.getMessage();
0: //    assertEquals (result, "hello world");
0: //
0: //    ctx.stop();
0: //    manager.uninstall(ctx);
0:   }
0: 
0: 
0:   @org.ops4j.pax.exam.junit.Configuration
0:   public static Option[] configuration() {
0:     Option[] options = options(
0:         // Log
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-api"),
0:         mavenBundle("org.ops4j.pax.logging", "pax-logging-service"),
0:         // Felix Config Admin
0:         mavenBundle("org.apache.felix", "org.apache.felix.configadmin"),
0:         // Felix mvn url handler
0:         mavenBundle("org.ops4j.pax.url", "pax-url-mvn"),
0: 
0:         // this is how you set the default log level when using pax
0:         // logging (logProfile)
0:         systemProperty("org.ops4j.pax.logging.DefaultServiceLog.level").value("DEBUG"),
0: 
0:         // Bundles
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.api"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.utils"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.management"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.resolver.obr"),
0:         mavenBundle("org.apache.felix", "org.apache.felix.bundlerepository"),
0:         mavenBundle("org.apache.aries.application", "org.apache.aries.application.runtime.itest.interfaces"),
0:         mavenBundle("org.apache.aries", "org.apache.aries.util"),
0:         mavenBundle("org.apache.aries.blueprint", "org.apache.aries.blueprint"),
0:         mavenBundle("org.osgi", "org.osgi.compendium"),
0:         mavenBundle("org.apache.aries.testsupport", "org.apache.aries.testsupport.unit"),
0: 
0: //        /* For debugging, uncomment the next two lines
0: //        vmOption ("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"),
0: //        waitForFrameworkStartup(),
0: 
0:         /* For debugging, uncomment the next two lines
0:         and add these imports:
0:         import static org.ops4j.pax.exam.CoreOptions.waitForFrameworkStartup;
0:         import static org.ops4j.pax.exam.container.def.PaxRunnerOptions.vmOption;
0:         */
0: 
0:         equinox().version("3.5.0"));
0:     options = updateOptions(options);
0:     return options;
0:   }
0: }
============================================================================