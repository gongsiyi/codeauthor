1:0bace1a: /*
1:0bace1a:  * Licensed to the Apache Software Foundation (ASF) under one
1:0bace1a:  * or more contributor license agreements.  See the NOTICE file
1:0bace1a:  * distributed with this work for additional information
1:0bace1a:  * regarding copyright ownership.  The ASF licenses this file
1:0bace1a:  * to you under the Apache License, Version 2.0 (the
1:0bace1a:  * "License"); you may not use this file except in compliance
1:0bace1a:  * with the License.  You may obtain a copy of the License at
1:0bace1a:  *
1:0bace1a:  *   http://www.apache.org/licenses/LICENSE-2.0
1:0bace1a:  *
1:0bace1a:  * Unless required by applicable law or agreed to in writing,
1:0bace1a:  * software distributed under the License is distributed on an
1:0bace1a:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
1:0bace1a:  * KIND, either express or implied.  See the License for the
1:0bace1a:  * specific language governing permissions and limitations
1:0bace1a:  * under the License.
1:0bace1a:  */
11:0bace1a: 
1:0bace1a: package org.apache.derbyTesting.functionTests.tests.jdbcapi;
1:0bace1a: 
1:0bace1a: import java.lang.reflect.Method;
1:0bace1a: import java.sql.SQLException;
1:0bace1a: import javax.sql.ConnectionPoolDataSource;
1:0bace1a: import javax.sql.XADataSource;
1:0bace1a: import junit.extensions.TestSetup;
1:0bace1a: import junit.framework.Assert;
1:0bace1a: import junit.framework.Test;
1:0bace1a: import org.apache.derbyTesting.junit.BaseJDBCTestCase;
1:1ae02c9: import org.apache.derbyTesting.junit.BaseTestSuite;
1:0bace1a: import org.apache.derbyTesting.junit.J2EEDataSource;
1:0bace1a: import org.apache.derbyTesting.junit.JDBCDataSource;
1:0bace1a: import org.apache.derbyTesting.junit.TestConfiguration;
1:0bace1a: 
1:0bace1a: public class PoolXADSCreateShutdownDBTest extends BaseJDBCTestCase {
1:0bace1a: 
1:0bace1a:     static final String[] ADDITIONAL_DBS = {
1:0bace1a:         "dscreateconatdb1",
1:0bace1a:         "dscreateshutdowndb1", 
1:0bace1a:         "dscreateshutdowndb2",
1:0bace1a:         "conflict1",
1:0bace1a:         "conflict2",
1:0bace1a:         "conflict3",
1:0bace1a:         "conflict4",
1:0bace1a:         "conflict5",
1:0bace1a:         "conflict6",
1:0bace1a:         "conflict7"
1:0bace1a:     };
1:0bace1a:     
1:0bace1a:     static String DBNotFoundState;
1:0bace1a: 
1:0bace1a: 	private String ShutdownState = "08006";
1:0bace1a:     
1:0bace1a:     public PoolXADSCreateShutdownDBTest(String name) {
1:0bace1a:         super(name);
10:0bace1a:     }
1:0bace1a: 
1:0bace1a:     public static Test suite() 
4:0bace1a:     {
1:1ae02c9:         BaseTestSuite suite = new BaseTestSuite("PoolXADSCreateShutdownTest");
1:0bace1a:         Test test = TestConfiguration.defaultSuite(PoolXADSCreateShutdownDBTest.class);        
1:0bace1a:         //Test test = TestConfiguration.clientServerSuite(DSCreateShutdownDBTest.class);
1:0bace1a:         suite.addTest(test);
1:0bace1a:         
1:0bace1a:         TestSetup setup = TestConfiguration.singleUseDatabaseDecorator(suite);
1:0bace1a:         // we need a couple extra databases to test they get created
1:0bace1a:         for (int i = 0; i < ADDITIONAL_DBS.length; i++)
1:0bace1a:         {
1:0bace1a:             setup = TestConfiguration.additionalDatabaseDecorator(setup,
1:0bace1a:                 "emb" + ADDITIONAL_DBS[i]);
1:0bace1a:             setup = TestConfiguration.additionalDatabaseDecorator(setup,
1:0bace1a:                 "srv" + ADDITIONAL_DBS[i]);
1:0bace1a:         }
1:0bace1a:     
1:0bace1a:         return suite;
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     public void tearDown() throws Exception {
1:0bace1a:         // attempt to get rid of any databases. 
1:0bace1a:         // only 5 dbs (in addition to the defaultdb) should actually get
1:0bace1a:         // created, but just in case...
1:e18f54b:         TestConfiguration conf = TestConfiguration.getCurrent();
1:e18f54b:         for (int i = 0; i < ADDITIONAL_DBS.length; i++) {
1:e18f54b:             removeDirectory(conf.getDatabasePath("emb" + ADDITIONAL_DBS[i]));
1:e18f54b:             removeDirectory(conf.getDatabasePath("srv" + ADDITIONAL_DBS[i]));
1:e18f54b:         }
1:0bace1a:         super.tearDown();
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     public void testPoolDS() throws SQLException {
1:0bace1a:         ConnectionPoolDataSource ds = 
1:0bace1a:             J2EEDataSource.getConnectionPoolDataSource();
1:0bace1a:         doCreateAndShutdown(ds);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     public void testXADS() throws SQLException {
1:0bace1a:         XADataSource ds = J2EEDataSource.getXADataSource();
1:0bace1a:         doCreateAndShutdown(ds);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     public void doCreateAndShutdown(Object ds) throws SQLException {
1:0bace1a:         
1:0bace1a:         if (usingEmbedded())
1:0bace1a:             DBNotFoundState = "XJ004";
1:0bace1a:         else
1:0bace1a:             DBNotFoundState = "08004"; 
1:0bace1a:              
1:0bace1a:    
1:0bace1a:         
1:0bace1a:         // first play with default db, which is already created.
1:0bace1a:         String dbName = 
1:0bace1a:             TestConfiguration.getCurrent().getDefaultDatabaseName();
1:0bace1a:         // just check that we really access the database
1:0bace1a:         assertUpdateCount(createStatement(), 0, "set schema APP");
1:0bace1a:    
1:0bace1a:         // check that first the value is null
1:0bace1a:         assertGetNull(ds, dbName);
1:0bace1a:         // check that we can set & that when set we can get
1:0bace1a:         // doesn't actually open connections so a little silly.
1:0bace1a:         assertSetAndGet(ds, dbName, "shutdownDatabase", "shutdown");
1:0bace1a:         assertSetAndGet(ds, dbName, "createDatabase", "create");
1:0bace1a:         // set to an invalid value, should get ignored
1:0bace1a:         assertNotSetAndGet(ds, dbName, "shutdownDatabase", "boo");
1:0bace1a:         assertNotSetAndGet(ds, dbName, "createDatabase", "boo");
1:0bace1a:         assertNotSetAndGet(ds, dbName, "shutdownDatabase", "false");
1:0bace1a:         assertNotSetAndGet(ds, dbName, "createDatabase", "false");
1:0bace1a:         
1:0bace1a:         assertReset(ds, dbName);
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // check that create using ConnAttributes works
1:0bace1a:         assertCreateUsingConnAttrsOK(
1:0bace1a:             ds, composeDatabaseName(ADDITIONAL_DBS[0]));
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // check that shutting down using Attributes works
1:0bace1a:         assertShutdownUsingConnAttrsOK(ds, dbName);
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // now, actually create using setCreateDB, and shutdown a database
1:0bace1a:         // first ensure it's not there yet
1:0bace1a:         dbName = composeDatabaseName(ADDITIONAL_DBS[1]);
1:0bace1a:         
1:0bace1a:         assertNoDB(ds, dbName);
1:0bace1a:         // straightforward create and shutdown
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         assertPositive(ds, dbName);
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // what happens when you combine set*Database and 
1:0bace1a:         // matching connection attribute? (should work)
1:0bace1a:         dbName = composeDatabaseName(ADDITIONAL_DBS[2]);
1:0bace1a:         assertNoDB(ds, dbName);
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         assertTwiceOK(ds, dbName);
1:0bace1a:         
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // the rest of the testing is on conflicted settings
1:0bace1a:         // the result is not defined, so a change in behavior does not 
1:0bace1a:         // necessarily indicate a bug, but may be relevant for existing apps
1:0bace1a:         // what happens when you combine create and shutdown connattr?
1:0bace1a:         // database does not get created.
1:0bace1a:         assertShutdownAndCreateConnAttr(DBNotFoundState, ds,  
1:0bace1a:             composeDatabaseName(ADDITIONAL_DBS[3]), 
1:0bace1a:             "shutdown=true;create=true");
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         assertShutdownAndCreateConnAttr(DBNotFoundState, ds, 
1:0bace1a:             composeDatabaseName(ADDITIONAL_DBS[4]), 
1:0bace1a:             "create=true;shutdown=true");
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // and when you set both setShutdownDatabase and setCreateDatabase?
1:0bace1a:         // database does not get created
1:0bace1a:         assertConflictedSettersOK(ds, composeDatabaseName(ADDITIONAL_DBS[5]));
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         // what happens when you combine set*Database and
1:0bace1a:         // opposing connection attributes? database does not get created. 
1:0bace1a:         assertConflictedSetterConnAttrOK(ds);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected String composeDatabaseName(String dbName) {
1:0bace1a:         if (usingEmbedded())
1:0bace1a:             return "emb" + dbName;
1:0bace1a:         else 
1:0bace1a:             return "srv" + dbName;
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertGetNull(Object ds, String dbName) throws SQLException {
1:0bace1a:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         assertNull(getBeanProperty(ds, "createDatabase"));
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertSetAndGet(
1:0bace1a:         Object ds, String dbName, String propertyString, String setValue)
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, propertyString, setValue);
1:0bace1a:         assertEquals(setValue,getBeanProperty(ds, propertyString).toString());
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertNotSetAndGet(
1:0bace1a:         Object ds, String dbName, String propertyString, String setValue)
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, propertyString, setValue);
1:0bace1a:         assertNull(getBeanProperty(ds, propertyString));
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertReset(Object ds, String dbName) 
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "");
1:0bace1a:         assertNull(getBeanProperty(ds, "createDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "create");
1:0bace1a:         assertEquals("create", getBeanProperty(ds, "createDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "boo");
1:0bace1a:         assertNull(getBeanProperty(ds, "createDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "create");
1:0bace1a:         assertEquals("create", getBeanProperty(ds, "createDatabase"));
1:9cf3fb5:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "false");
1:0bace1a:         assertNull(getBeanProperty(ds, "createDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "create");
1:0bace1a:         assertEquals("create", getBeanProperty(ds, "createDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "");
1:0bace1a:         assertNull(getBeanProperty(ds, "createDatabase"));
1:0bace1a:         try { 
1:0bace1a:             JDBCDataSource.setBeanProperty(ds, "createDatabase", "");
1:0bace1a:         } catch (Exception e) {
1:0bace1a:             e.printStackTrace();
1:0bace1a:         }
1:0bace1a:         
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "");
1:0bace1a:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:0bace1a:         assertEquals("shutdown", getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "boo");
1:0bace1a:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "false");
1:0bace1a:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:0bace1a:         assertEquals("shutdown", getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "");
1:0bace1a:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:0bace1a:         try { 
1:0bace1a:             JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "");
1:0bace1a:         } catch (Exception e) {
1:0bace1a:             e.printStackTrace();
1:0bace1a:         }
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     public static Object getBeanProperty(Object ds, String propertyString)
1:0bace1a:     {
1:0bace1a:         String getterName = getGetterName(propertyString);
1:0bace1a: 
1:0bace1a:         // Base the type of the setter method from the value's class.
1:0bace1a: 
1:0bace1a:         Object retObject=null;
1:0bace1a:         try {
1:0bace1a:             Method getter = ds.getClass().getMethod(getterName, null);
1:0bace1a:             retObject = getter.invoke(ds, null);
1:0bace1a:         } catch (Exception e) {
1:0bace1a:             Assert.fail(e.getMessage());
1:0bace1a:         }
1:0bace1a:         return retObject;
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     private static String getGetterName(String attribute) {
1:0bace1a:         return "get" + Character.toUpperCase(attribute.charAt(0))
1:0bace1a:         + attribute.substring(1);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     // if the connattr parameter is true, we set both setShutdownDatabase
1:0bace1a:     // and ConnectionAttribute shutdown=true.
1:0bace1a:     protected void assertShutdownUsingSetOK(
1:0bace1a:         Object ds, String dbName, boolean connAttr) throws SQLException {
1:0bace1a: 
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         if (connAttr)
1:0bace1a:             JDBCDataSource.setBeanProperty(
1:0bace1a:                 ds, "ConnectionAttributes", "shutdown=true");
1:0bace1a:         assertDSConnectionFailed(ShutdownState, ds);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     // for completeness' sake, test create=true conn attr.
1:0bace1a:     protected void assertCreateUsingConnAttrsOK(Object ds, String dbName)
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(
1:0bace1a:                 ds, "ConnectionAttributes", "create=true");
1:0bace1a:         JDBCDataSource.setBeanProperty(ds,"databaseName", dbName);
1:0bace1a:         assertUpdateCount(ds);
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "ConnectionAttributes");
1:0bace1a:         assertShutdownUsingSetOK(ds, dbName, false);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertShutdownUsingConnAttrsOK(Object ds, String dbName)
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(
1:0bace1a:             ds, "ConnectionAttributes", "shutdown=true");
1:0bace1a:         assertDSConnectionFailed(ShutdownState, ds);
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     protected void assertShutdownAndCreateConnAttr(
1:0bace1a:         String expectedSQLState, Object ds, String dbName, String twoPropertyString)
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(
1:0bace1a:             ds, "ConnectionAttributes", twoPropertyString);
1:0bace1a:         assertDSConnectionFailed(expectedSQLState, ds);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertDSConnectionFailed(
1:0bace1a:         String expectedSQLState, Object ds) throws SQLException {
1:0bace1a:         try {
1:0bace1a:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:0bace1a:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:0bace1a:             else
1:0bace1a:                 ((XADataSource)ds).getXAConnection();
1:0bace1a:             fail("expected an sqlexception " + expectedSQLState);
1:0bace1a:         } catch (SQLException sqle) {
1:0bace1a:             assertSQLState(expectedSQLState, sqle);
1:0bace1a:         }
1:0bace1a:     }    
1:0bace1a:     
1:0bace1a:     protected void assertNoDB(Object ds, String dbName) throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         assertDSConnectionFailed(DBNotFoundState, ds);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertPositive(Object ds, String dbName) 
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "CreateDatabase", "create");
1:0bace1a:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:0bace1a:         assertUpdateCount(ds); 
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         assertShutdownUsingSetOK(ds, dbName, false);
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     protected void assertTwiceOK(Object ds, String dbName) throws SQLException{
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "CreateDatabase", "create");
1:0bace1a:         JDBCDataSource.setBeanProperty(
1:0bace1a:             ds, "ConnectionAttributes", "create=true");
1:0bace1a:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:0bace1a:         assertUpdateCount(ds);
1:0bace1a:         clearBeanProperties(ds);
1:0bace1a:         
1:0bace1a:         assertShutdownUsingSetOK(ds, dbName, true);
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     protected void assertConflictedSettersOK(Object ds, String dbName) 
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "CreateDatabase", "create");
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:0bace1a:         try {
1:0bace1a:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:0bace1a:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:0bace1a:             else
1:0bace1a:                 ((XADataSource)ds).getXAConnection();
1:0bace1a:             fail("expected an sqlexception " + DBNotFoundState);
1:0bace1a:         } catch (SQLException se) {
1:0bace1a:             assertSQLState(DBNotFoundState, se);
1:0bace1a:         }
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     protected void assertConflictedSetterConnAttrOK(Object ds) 
1:0bace1a:     throws SQLException {
1:0bace1a:         assertConSetOK(ds, DBNotFoundState, 
1:0bace1a:             composeDatabaseName(ADDITIONAL_DBS[6]), 
1:0bace1a:             "shutdown=true", "CreateDatabase", "create");
1:0bace1a:         // with the new networkserver methods, this actually works...
1:0bace1a:         assertConSetOK(ds, DBNotFoundState, 
1:0bace1a:             composeDatabaseName(ADDITIONAL_DBS[7]),
1:0bace1a:             "create=true", "ShutdownDatabase", "shutdown");
1:0bace1a:         assertSetConOK(ds, DBNotFoundState, 
1:0bace1a:             composeDatabaseName(ADDITIONAL_DBS[8]), 
1:0bace1a:             "shutdown=true", "CreateDatabase", "create");
1:0bace1a:         // with the new networkserver methods, this actually works...
1:0bace1a:         assertSetConOK(ds, DBNotFoundState, 
1:0bace1a:             composeDatabaseName(ADDITIONAL_DBS[9]),
1:0bace1a:             "create=true", "ShutdownDatabase", "shutdown");
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     // first sets setCreate/ShutdownDB, then sets ConnectionAttributes
1:0bace1a:     protected void assertConSetOK(Object ds, String expectedSQLState, 
1:0bace1a:         String dbName, String connAttrValue, String setter, String setValue) 
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, setter, setValue);
1:0bace1a:         JDBCDataSource.setBeanProperty(
1:0bace1a:             ds, "ConnectionAttributes", connAttrValue);
1:0bace1a:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:0bace1a:         try {
1:0bace1a:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:0bace1a:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:0bace1a:             else
1:0bace1a:                 ((XADataSource)ds).getXAConnection();
1:0bace1a:             fail("expected an sqlexception " + expectedSQLState);
1:0bace1a:         } catch (SQLException se) {
1:0bace1a:             assertSQLState(expectedSQLState, se);
1:0bace1a:         }
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, setter);
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "ConnectionAttributes");
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     // sets ConnectionAttributes first, then SetCreate/ShutdownDB
1:0bace1a:     protected void assertSetConOK(Object ds, String expectedSQLState, 
1:0bace1a:         String dbName, String connAttrValue, String setter, String setValue) 
1:0bace1a:     throws SQLException {
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:0bace1a:         JDBCDataSource.setBeanProperty(
1:0bace1a:             ds, "ConnectionAttributes", connAttrValue);
1:0bace1a:         JDBCDataSource.setBeanProperty(ds, setter, setValue);
1:0bace1a:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:0bace1a:         try {
1:0bace1a:             
1:0bace1a:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:0bace1a:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:0bace1a:             else
1:0bace1a:                 ((XADataSource)ds).getXAConnection();
1:0bace1a:             fail("expected an sqlexception " + expectedSQLState);
1:0bace1a:         } catch (SQLException se) {
1:0bace1a:             assertSQLState(expectedSQLState, se);
1:0bace1a:         }
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "ConnectionAttributes");
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, setter);
1:0bace1a:     }
1:0bace1a: 
1:0bace1a:     protected void assertUpdateCount(Object ds) throws SQLException {        
1:0bace1a:         if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:0bace1a:             assertUpdateCount(
1:0bace1a:                 ((ConnectionPoolDataSource)ds).getPooledConnection().getConnection().createStatement(), 0, "set schema APP");
1:0bace1a:         else
1:0bace1a:             assertUpdateCount(
1:0bace1a:                 ((XADataSource)ds).getXAConnection().getConnection().createStatement(), 0, "set schema APP");
1:0bace1a:     }
1:0bace1a:     
1:0bace1a:     
1:0bace1a:     /**
1:0bace1a:      * Clear bean properties for next test
1:0bace1a:      * @param ds
1:0bace1a:      * @throws SQLException
1:0bace1a:      */
1:0bace1a:     private void clearBeanProperties(Object ds) throws SQLException {
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "createDatabase");
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "shutdownDatabase");
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "connectionAttributes");
1:0bace1a:         JDBCDataSource.clearStringBeanProperty(ds, "databaseName");
1:0bace1a:     }
1:0bace1a:  
1:0bace1a: }
============================================================================
author:Dag H. Wanvik
-------------------------------------------------------------------------------
commit:1ae02c9
/////////////////////////////////////////////////////////////////////////
1: import org.apache.derbyTesting.junit.BaseTestSuite;
/////////////////////////////////////////////////////////////////////////
1:         BaseTestSuite suite = new BaseTestSuite("PoolXADSCreateShutdownTest");
author:Knut Anders Hatlen
-------------------------------------------------------------------------------
commit:e18f54b
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
1:         TestConfiguration conf = TestConfiguration.getCurrent();
1:         for (int i = 0; i < ADDITIONAL_DBS.length; i++) {
1:             removeDirectory(conf.getDatabasePath("emb" + ADDITIONAL_DBS[i]));
1:             removeDirectory(conf.getDatabasePath("srv" + ADDITIONAL_DBS[i]));
1:         }
author:Kristian Waagan
-------------------------------------------------------------------------------
commit:7fe51c3
/////////////////////////////////////////////////////////////////////////
commit:9cf3fb5
/////////////////////////////////////////////////////////////////////////
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "false");
author:Katherine Marsden
-------------------------------------------------------------------------------
commit:0bace1a
/////////////////////////////////////////////////////////////////////////
1: /*
1:  * Licensed to the Apache Software Foundation (ASF) under one
1:  * or more contributor license agreements.  See the NOTICE file
1:  * distributed with this work for additional information
1:  * regarding copyright ownership.  The ASF licenses this file
1:  * to you under the Apache License, Version 2.0 (the
1:  * "License"); you may not use this file except in compliance
1:  * with the License.  You may obtain a copy of the License at
1:  *
1:  *   http://www.apache.org/licenses/LICENSE-2.0
1:  *
1:  * Unless required by applicable law or agreed to in writing,
1:  * software distributed under the License is distributed on an
1:  * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
1:  * KIND, either express or implied.  See the License for the
1:  * specific language governing permissions and limitations
1:  * under the License.
1:  */
1: 
1: package org.apache.derbyTesting.functionTests.tests.jdbcapi;
1: 
0: import java.io.File;
1: import java.lang.reflect.Method;
0: import java.security.AccessController;
1: import java.sql.SQLException;
1: 
0: import javax.sql.DataSource;
1: import javax.sql.ConnectionPoolDataSource;
1: import javax.sql.XADataSource;
1: 
1: import junit.extensions.TestSetup;
1: import junit.framework.Assert;
1: import junit.framework.Test;
0: import junit.framework.TestSuite;
1: 
1: import org.apache.derbyTesting.junit.BaseJDBCTestCase;
0: import org.apache.derbyTesting.junit.BaseTestCase;
1: import org.apache.derbyTesting.junit.J2EEDataSource;
1: import org.apache.derbyTesting.junit.JDBCDataSource;
1: import org.apache.derbyTesting.junit.TestConfiguration;
1: 
1: public class PoolXADSCreateShutdownDBTest extends BaseJDBCTestCase {
1: 
1:     static final String[] ADDITIONAL_DBS = {
1:         "dscreateconatdb1",
1:         "dscreateshutdowndb1", 
1:         "dscreateshutdowndb2",
1:         "conflict1",
1:         "conflict2",
1:         "conflict3",
1:         "conflict4",
1:         "conflict5",
1:         "conflict6",
1:         "conflict7"
1:     };
1:     
1:     static String DBNotFoundState;
1: 
1: 	private String ShutdownState = "08006";
1:     
1:     public PoolXADSCreateShutdownDBTest(String name) {
1:         super(name);
1:     }
1: 
1:     public static Test suite() 
1:     {
0:         TestSuite suite = new TestSuite("PoolXADSCreateShutdownTest"); 
1:         Test test = TestConfiguration.defaultSuite(PoolXADSCreateShutdownDBTest.class);        
1:         //Test test = TestConfiguration.clientServerSuite(DSCreateShutdownDBTest.class);
1:         suite.addTest(test);
1:         
1:         TestSetup setup = TestConfiguration.singleUseDatabaseDecorator(suite);
1:         // we need a couple extra databases to test they get created
1:         for (int i = 0; i < ADDITIONAL_DBS.length; i++)
1:         {
1:             setup = TestConfiguration.additionalDatabaseDecorator(setup,
1:                 "emb" + ADDITIONAL_DBS[i]);
1:             setup = TestConfiguration.additionalDatabaseDecorator(setup,
1:                 "srv" + ADDITIONAL_DBS[i]);
1:         }
1:     
1:         return suite;
1:     }
1:     
1:     public void tearDown() throws Exception {
1:         // attempt to get rid of any databases. 
1:         // only 5 dbs (in addition to the defaultdb) should actually get
1:         // created, but just in case...
0:         AccessController.doPrivileged(new java.security.PrivilegedAction() {
0:             public Object run() {
0:                 for (int i=0 ; i < ADDITIONAL_DBS.length ; i++)
1:                 {   
0:                     removeDatabase("emb" + ADDITIONAL_DBS[i]);
0:                     removeDatabase("srv" + ADDITIONAL_DBS[i]);
1:                 } 
0:                 return null;
1:             }
1:             
0:             void removeDatabase(String dbName)
1:             {
0:                 //TestConfiguration config = TestConfiguration.getCurrent();
0:                 dbName = dbName.replace('/', File.separatorChar);
0:                 String dsh = BaseTestCase.getSystemProperty("derby.system.home");
0:                 if (dsh == null) {
0:                     fail("not implemented");
0:                 } else {
0:                     dbName = dsh + File.separator + dbName;
1:                 }
0:                 removeDirectory(dbName);
1:             }
1: 
0:             void removeDirectory(String path)
1:             {
0:                 final File dir = new File(path);
0:                 removeDir(dir);
1:             }
1: 
0:             private void removeDir(File dir) {
1:                 
0:                 // Check if anything to do!
0:                 // Database may not have been created.
0:                 if (!dir.exists())
0:                     return;
1: 
0:                 String[] list = dir.list();
1: 
0:                 // Some JVMs return null for File.list() when the
0:                 // directory is empty.
0:                 if (list != null) {
0:                     for (int i = 0; i < list.length; i++) {
0:                         File entry = new File(dir, list[i]);
1: 
0:                         if (entry.isDirectory()) {
0:                             removeDir(entry);
0:                         } else {
0:                             entry.delete();
0:                             //assertTrue(entry.getPath(), entry.delete());
1:                         }
1:                     }
1:                 }
0:                 dir.delete();
0:                 //assertTrue(dir.getPath(), dir.delete());
1:             }
0:         });
1:         super.tearDown();
1:     }
1: 
1:     public void testPoolDS() throws SQLException {
1:         ConnectionPoolDataSource ds = 
1:             J2EEDataSource.getConnectionPoolDataSource();
1:         doCreateAndShutdown(ds);
1:     }
1:     
1:     public void testXADS() throws SQLException {
1:         XADataSource ds = J2EEDataSource.getXADataSource();
1:         doCreateAndShutdown(ds);
1:     }
1:     
1:     public void doCreateAndShutdown(Object ds) throws SQLException {
1:         
1:         if (usingEmbedded())
1:             DBNotFoundState = "XJ004";
1:         else
1:             DBNotFoundState = "08004"; 
1:              
1:    
1:         
1:         // first play with default db, which is already created.
1:         String dbName = 
1:             TestConfiguration.getCurrent().getDefaultDatabaseName();
1:         // just check that we really access the database
1:         assertUpdateCount(createStatement(), 0, "set schema APP");
1:    
1:         // check that first the value is null
1:         assertGetNull(ds, dbName);
1:         // check that we can set & that when set we can get
1:         // doesn't actually open connections so a little silly.
1:         assertSetAndGet(ds, dbName, "shutdownDatabase", "shutdown");
1:         assertSetAndGet(ds, dbName, "createDatabase", "create");
1:         // set to an invalid value, should get ignored
1:         assertNotSetAndGet(ds, dbName, "shutdownDatabase", "boo");
1:         assertNotSetAndGet(ds, dbName, "createDatabase", "boo");
1:         assertNotSetAndGet(ds, dbName, "shutdownDatabase", "false");
1:         assertNotSetAndGet(ds, dbName, "createDatabase", "false");
1:         
1:         assertReset(ds, dbName);
1:         clearBeanProperties(ds);
1:         // check that create using ConnAttributes works
1:         assertCreateUsingConnAttrsOK(
1:             ds, composeDatabaseName(ADDITIONAL_DBS[0]));
1:         clearBeanProperties(ds);
1:         // check that shutting down using Attributes works
1:         assertShutdownUsingConnAttrsOK(ds, dbName);
1:         clearBeanProperties(ds);
1:         // now, actually create using setCreateDB, and shutdown a database
1:         // first ensure it's not there yet
1:         dbName = composeDatabaseName(ADDITIONAL_DBS[1]);
1:         
1:         assertNoDB(ds, dbName);
1:         // straightforward create and shutdown
1:         clearBeanProperties(ds);
1:         assertPositive(ds, dbName);
1:         clearBeanProperties(ds);
1:         // what happens when you combine set*Database and 
1:         // matching connection attribute? (should work)
1:         dbName = composeDatabaseName(ADDITIONAL_DBS[2]);
1:         assertNoDB(ds, dbName);
1:         clearBeanProperties(ds);
1:         assertTwiceOK(ds, dbName);
1:         
1:         clearBeanProperties(ds);
1:         // the rest of the testing is on conflicted settings
1:         // the result is not defined, so a change in behavior does not 
1:         // necessarily indicate a bug, but may be relevant for existing apps
1:         // what happens when you combine create and shutdown connattr?
1:         // database does not get created.
1:         assertShutdownAndCreateConnAttr(DBNotFoundState, ds,  
1:             composeDatabaseName(ADDITIONAL_DBS[3]), 
1:             "shutdown=true;create=true");
1:         clearBeanProperties(ds);
1:         assertShutdownAndCreateConnAttr(DBNotFoundState, ds, 
1:             composeDatabaseName(ADDITIONAL_DBS[4]), 
1:             "create=true;shutdown=true");
1:         clearBeanProperties(ds);
1:         // and when you set both setShutdownDatabase and setCreateDatabase?
1:         // database does not get created
1:         assertConflictedSettersOK(ds, composeDatabaseName(ADDITIONAL_DBS[5]));
1:         clearBeanProperties(ds);
1:         // what happens when you combine set*Database and
1:         // opposing connection attributes? database does not get created. 
1:         assertConflictedSetterConnAttrOK(ds);
1:     }
1:     
1:     protected String composeDatabaseName(String dbName) {
1:         if (usingEmbedded())
1:             return "emb" + dbName;
1:         else 
1:             return "srv" + dbName;
1:     }
1:     
1:     protected void assertGetNull(Object ds, String dbName) throws SQLException {
1:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:         assertNull(getBeanProperty(ds, "createDatabase"));
1:     }
1:     
1:     protected void assertSetAndGet(
1:         Object ds, String dbName, String propertyString, String setValue)
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, propertyString, setValue);
1:         assertEquals(setValue,getBeanProperty(ds, propertyString).toString());
1:     }
1:     
1:     protected void assertNotSetAndGet(
1:         Object ds, String dbName, String propertyString, String setValue)
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, propertyString, setValue);
1:         assertNull(getBeanProperty(ds, propertyString));
1:     }
1:     
1:     protected void assertReset(Object ds, String dbName) 
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "");
1:         assertNull(getBeanProperty(ds, "createDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "create");
1:         assertEquals("create", getBeanProperty(ds, "createDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "boo");
1:         assertNull(getBeanProperty(ds, "createDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "create");
1:         assertEquals("create", getBeanProperty(ds, "createDatabase"));
0:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "false");
1:         assertNull(getBeanProperty(ds, "createDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "create");
1:         assertEquals("create", getBeanProperty(ds, "createDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "createDatabase", "");
1:         assertNull(getBeanProperty(ds, "createDatabase"));
1:         try { 
1:             JDBCDataSource.setBeanProperty(ds, "createDatabase", "");
1:         } catch (Exception e) {
1:             e.printStackTrace();
1:         }
1:         
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "");
1:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:         assertEquals("shutdown", getBeanProperty(ds, "shutdownDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "boo");
1:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "false");
1:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:         assertEquals("shutdown", getBeanProperty(ds, "shutdownDatabase"));
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "");
1:         assertNull(getBeanProperty(ds, "shutdownDatabase"));
1:         try { 
1:             JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "");
1:         } catch (Exception e) {
1:             e.printStackTrace();
1:         }
1:     }
1:     
1:     public static Object getBeanProperty(Object ds, String propertyString)
1:     {
1:         String getterName = getGetterName(propertyString);
1: 
1:         // Base the type of the setter method from the value's class.
1: 
1:         Object retObject=null;
1:         try {
1:             Method getter = ds.getClass().getMethod(getterName, null);
1:             retObject = getter.invoke(ds, null);
1:         } catch (Exception e) {
1:             Assert.fail(e.getMessage());
1:         }
1:         return retObject;
1:     }
1: 
1:     private static String getGetterName(String attribute) {
1:         return "get" + Character.toUpperCase(attribute.charAt(0))
1:         + attribute.substring(1);
1:     }
1:     
1:     // if the connattr parameter is true, we set both setShutdownDatabase
1:     // and ConnectionAttribute shutdown=true.
1:     protected void assertShutdownUsingSetOK(
1:         Object ds, String dbName, boolean connAttr) throws SQLException {
1: 
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         if (connAttr)
1:             JDBCDataSource.setBeanProperty(
1:                 ds, "ConnectionAttributes", "shutdown=true");
1:         assertDSConnectionFailed(ShutdownState, ds);
1:     }
1:     
1:     // for completeness' sake, test create=true conn attr.
1:     protected void assertCreateUsingConnAttrsOK(Object ds, String dbName)
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(
1:                 ds, "ConnectionAttributes", "create=true");
1:         JDBCDataSource.setBeanProperty(ds,"databaseName", dbName);
1:         assertUpdateCount(ds);
1:         JDBCDataSource.clearStringBeanProperty(ds, "ConnectionAttributes");
1:         assertShutdownUsingSetOK(ds, dbName, false);
1:     }
1:     
1:     protected void assertShutdownUsingConnAttrsOK(Object ds, String dbName)
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(
1:             ds, "ConnectionAttributes", "shutdown=true");
1:         assertDSConnectionFailed(ShutdownState, ds);
1:     }
1: 
1:     protected void assertShutdownAndCreateConnAttr(
1:         String expectedSQLState, Object ds, String dbName, String twoPropertyString)
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(
1:             ds, "ConnectionAttributes", twoPropertyString);
1:         assertDSConnectionFailed(expectedSQLState, ds);
1:     }
1:     
1:     protected void assertDSConnectionFailed(
1:         String expectedSQLState, Object ds) throws SQLException {
1:         try {
1:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:             else
1:                 ((XADataSource)ds).getXAConnection();
1:             fail("expected an sqlexception " + expectedSQLState);
1:         } catch (SQLException sqle) {
1:             assertSQLState(expectedSQLState, sqle);
1:         }
1:     }    
1:     
1:     protected void assertNoDB(Object ds, String dbName) throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         assertDSConnectionFailed(DBNotFoundState, ds);
1:     }
1:     
1:     protected void assertPositive(Object ds, String dbName) 
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(ds, "CreateDatabase", "create");
1:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:         assertUpdateCount(ds); 
1:         clearBeanProperties(ds);
1:         assertShutdownUsingSetOK(ds, dbName, false);
1:     }
1: 
1:     protected void assertTwiceOK(Object ds, String dbName) throws SQLException{
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(ds, "CreateDatabase", "create");
1:         JDBCDataSource.setBeanProperty(
1:             ds, "ConnectionAttributes", "create=true");
1:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:         assertUpdateCount(ds);
1:         clearBeanProperties(ds);
1:         
1:         assertShutdownUsingSetOK(ds, dbName, true);
1:     }
1:     
1:     protected void assertConflictedSettersOK(Object ds, String dbName) 
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(ds, "CreateDatabase", "create");
1:         JDBCDataSource.setBeanProperty(ds, "shutdownDatabase", "shutdown");
1:         try {
1:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:             else
1:                 ((XADataSource)ds).getXAConnection();
1:             fail("expected an sqlexception " + DBNotFoundState);
1:         } catch (SQLException se) {
1:             assertSQLState(DBNotFoundState, se);
1:         }
1:     }
1: 
1:     protected void assertConflictedSetterConnAttrOK(Object ds) 
1:     throws SQLException {
1:         assertConSetOK(ds, DBNotFoundState, 
1:             composeDatabaseName(ADDITIONAL_DBS[6]), 
1:             "shutdown=true", "CreateDatabase", "create");
1:         // with the new networkserver methods, this actually works...
1:         assertConSetOK(ds, DBNotFoundState, 
1:             composeDatabaseName(ADDITIONAL_DBS[7]),
1:             "create=true", "ShutdownDatabase", "shutdown");
1:         assertSetConOK(ds, DBNotFoundState, 
1:             composeDatabaseName(ADDITIONAL_DBS[8]), 
1:             "shutdown=true", "CreateDatabase", "create");
1:         // with the new networkserver methods, this actually works...
1:         assertSetConOK(ds, DBNotFoundState, 
1:             composeDatabaseName(ADDITIONAL_DBS[9]),
1:             "create=true", "ShutdownDatabase", "shutdown");
1:     }
1:     
1:     // first sets setCreate/ShutdownDB, then sets ConnectionAttributes
1:     protected void assertConSetOK(Object ds, String expectedSQLState, 
1:         String dbName, String connAttrValue, String setter, String setValue) 
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(ds, setter, setValue);
1:         JDBCDataSource.setBeanProperty(
1:             ds, "ConnectionAttributes", connAttrValue);
1:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:         try {
1:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:             else
1:                 ((XADataSource)ds).getXAConnection();
1:             fail("expected an sqlexception " + expectedSQLState);
1:         } catch (SQLException se) {
1:             assertSQLState(expectedSQLState, se);
1:         }
1:         JDBCDataSource.clearStringBeanProperty(ds, setter);
1:         JDBCDataSource.clearStringBeanProperty(ds, "ConnectionAttributes");
1:     }
1: 
1:     // sets ConnectionAttributes first, then SetCreate/ShutdownDB
1:     protected void assertSetConOK(Object ds, String expectedSQLState, 
1:         String dbName, String connAttrValue, String setter, String setValue) 
1:     throws SQLException {
1:         JDBCDataSource.setBeanProperty(ds, "databaseName", dbName);
1:         JDBCDataSource.setBeanProperty(
1:             ds, "ConnectionAttributes", connAttrValue);
1:         JDBCDataSource.setBeanProperty(ds, setter, setValue);
1:         // check that the db exists; execute an unnecessary, but harmless, stmt
1:         try {
1:             
1:             if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:                 ((ConnectionPoolDataSource)ds).getPooledConnection();
1:             else
1:                 ((XADataSource)ds).getXAConnection();
1:             fail("expected an sqlexception " + expectedSQLState);
1:         } catch (SQLException se) {
1:             assertSQLState(expectedSQLState, se);
1:         }
1:         JDBCDataSource.clearStringBeanProperty(ds, "ConnectionAttributes");
1:         JDBCDataSource.clearStringBeanProperty(ds, setter);
1:     }
1: 
1:     protected void assertUpdateCount(Object ds) throws SQLException {        
1:         if (ds instanceof javax.sql.ConnectionPoolDataSource)
1:             assertUpdateCount(
1:                 ((ConnectionPoolDataSource)ds).getPooledConnection().getConnection().createStatement(), 0, "set schema APP");
1:         else
1:             assertUpdateCount(
1:                 ((XADataSource)ds).getXAConnection().getConnection().createStatement(), 0, "set schema APP");
1:     }
1:     
1:     
1:     /**
1:      * Clear bean properties for next test
1:      * @param ds
1:      * @throws SQLException
1:      */
1:     private void clearBeanProperties(Object ds) throws SQLException {
1:         JDBCDataSource.clearStringBeanProperty(ds, "createDatabase");
1:         JDBCDataSource.clearStringBeanProperty(ds, "shutdownDatabase");
1:         JDBCDataSource.clearStringBeanProperty(ds, "connectionAttributes");
1:         JDBCDataSource.clearStringBeanProperty(ds, "databaseName");
1:     }
1:  
1: }
============================================================================