1:33b73ac: /**
1:57b4941:  * Licensed to the Apache Software Foundation (ASF) under one or more
1:57b4941:  * contributor license agreements.  See the NOTICE file distributed with
1:57b4941:  * this work for additional information regarding copyright ownership.
1:57b4941:  * The ASF licenses this file to You under the Apache License, Version 2.0
1:57b4941:  * (the "License"); you may not use this file except in compliance with
1:57b4941:  * the License.  You may obtain a copy of the License at
3:33b73ac:  *
1:230a86c:  *      http://www.apache.org/licenses/LICENSE-2.0
1:33b73ac:  *
1:33b73ac:  * Unless required by applicable law or agreed to in writing, software
1:33b73ac:  * distributed under the License is distributed on an "AS IS" BASIS,
1:33b73ac:  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
1:33b73ac:  * See the License for the specific language governing permissions and
1:33b73ac:  * limitations under the License.
1:33b73ac:  */
1:33b73ac: package org.apache.activemq.openwire.v1;
35:33b73ac: 
1:4821b9d: import java.io.DataInput;
1:4821b9d: import java.io.DataOutput;
1:33b73ac: import java.io.IOException;
1:33b73ac: import java.lang.reflect.Constructor;
1:f812e34: 
1:33b73ac: import org.apache.activemq.command.DataStructure;
1:33b73ac: import org.apache.activemq.openwire.BooleanStream;
1:33b73ac: import org.apache.activemq.openwire.DataStreamMarshaller;
1:33b73ac: import org.apache.activemq.openwire.OpenWireFormat;
1:88acb0e: import org.apache.activemq.util.ByteSequence;
1:33b73ac: 
1:fc00993: public abstract class BaseDataStreamMarshaller implements DataStreamMarshaller {
1:33b73ac: 
1:fc00993:     public static final Constructor STACK_TRACE_ELEMENT_CONSTRUCTOR;
1:33b73ac: 
1:33b73ac:     static {
1:f812e34:         Constructor constructor = null;
1:33b73ac:         try {
1:f812e34:             constructor = StackTraceElement.class.getConstructor(new Class[] {String.class, String.class,
1:f812e34:                                                                               String.class, int.class});
1:f812e34:         } catch (Throwable e) {
6:33b73ac:         }
1:33b73ac:         STACK_TRACE_ELEMENT_CONSTRUCTOR = constructor;
1:33b73ac:     }
1:f812e34: 
1:fc00993:     public abstract byte getDataStructureType();
1:f812e34: 
1:fc00993:     public abstract DataStructure createObject();
1:f812e34: 
1:33b73ac:     public int tightMarshal1(OpenWireFormat wireFormat, Object o, BooleanStream bs) throws IOException {
1:33b73ac:         return 0;
1:33b73ac:     }
1:f812e34: 
1:f812e34:     public void tightMarshal2(OpenWireFormat wireFormat, Object o, DataOutput dataOut, BooleanStream bs)
1:f812e34:         throws IOException {
1:33b73ac:     }
1:f812e34: 
1:f812e34:     public void tightUnmarshal(OpenWireFormat wireFormat, Object o, DataInput dataIn, BooleanStream bs)
1:f812e34:         throws IOException {
1:33b73ac:     }
1:f812e34: 
1:33b73ac:     public int tightMarshalLong1(OpenWireFormat wireFormat, long o, BooleanStream bs) throws IOException {
1:f812e34:         if (o == 0) {
1:33b73ac:             bs.writeBoolean(false);
1:33b73ac:             bs.writeBoolean(false);
1:33b73ac:             return 0;
1:74a7a8b:         } else if ((o & 0xFFFFFFFFFFFF0000L) == 0) {
1:33b73ac:             bs.writeBoolean(false);
1:f812e34:             bs.writeBoolean(true);
1:33b73ac:             return 2;
1:74a7a8b:         } else if ((o & 0xFFFFFFFF00000000L) == 0) {
2:33b73ac:             bs.writeBoolean(true);
1:33b73ac:             bs.writeBoolean(false);
1:33b73ac:             return 4;
1:33b73ac:         } else {
1:33b73ac:             bs.writeBoolean(true);
1:33b73ac:             bs.writeBoolean(true);
1:33b73ac:             return 8;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     public void tightMarshalLong2(OpenWireFormat wireFormat, long o, DataOutput dataOut, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:f812e34:             if (bs.readBoolean()) {
1:33b73ac:                 dataOut.writeLong(o);
1:33b73ac:             } else {
1:f812e34:                 dataOut.writeInt((int)o);
1:33b73ac:             }
1:33b73ac:         } else {
1:f812e34:             if (bs.readBoolean()) {
1:f812e34:                 dataOut.writeShort((int)o);
1:33b73ac:             }
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     public long tightUnmarshalLong(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:f812e34:             if (bs.readBoolean()) {
1:33b73ac:                 return dataIn.readLong();
1:33b73ac:             } else {
1:f1e4459:                 return toLong(dataIn.readInt());
1:33b73ac:             }
1:33b73ac:         } else {
1:f812e34:             if (bs.readBoolean()) {
1:f1e4459:                 return toLong(dataIn.readShort());
1:33b73ac:             } else {
1:33b73ac:                 return 0;
1:33b73ac:             }
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f1e4459:     protected long toLong(short value) {
1:f1e4459:         // lets handle negative values
1:f1e4459:         long answer = value;
1:f1e4459:         return answer & 0xffffL;
1:33b73ac:     }
1:f812e34: 
1:f1e4459:     protected long toLong(int value) {
1:f1e4459:         // lets handle negative values
1:f1e4459:         long answer = value;
1:f1e4459:         return answer & 0xffffffffL;
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected DataStructure tightUnmarsalNestedObject(OpenWireFormat wireFormat, DataInput dataIn,
1:f812e34:                                                       BooleanStream bs) throws IOException {
1:33b73ac:         return wireFormat.tightUnmarshalNestedObject(dataIn, bs);
1:f812e34:     }
1:f812e34: 
1:f812e34:     protected int tightMarshalNestedObject1(OpenWireFormat wireFormat, DataStructure o, BooleanStream bs)
1:f812e34:         throws IOException {
1:33b73ac:         return wireFormat.tightMarshalNestedObject1(o, bs);
1:f812e34:     }
1:f812e34: 
1:f812e34:     protected void tightMarshalNestedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut,
1:f812e34:                                              BooleanStream bs) throws IOException {
1:33b73ac:         wireFormat.tightMarshalNestedObject2(o, dataOut, bs);
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected DataStructure tightUnmarsalCachedObject(OpenWireFormat wireFormat, DataInput dataIn,
1:f812e34:                                                       BooleanStream bs) throws IOException {
1:f812e34:         if (wireFormat.isCacheEnabled()) {
1:f812e34:             if (bs.readBoolean()) {
1:33b73ac:                 short index = dataIn.readShort();
1:33b73ac:                 DataStructure object = wireFormat.tightUnmarshalNestedObject(dataIn, bs);
1:33b73ac:                 wireFormat.setInUnmarshallCache(index, object);
1:33b73ac:                 return object;
1:33b73ac:             } else {
1:33b73ac:                 short index = dataIn.readShort();
1:33b73ac:                 return wireFormat.getFromUnmarshallCache(index);
1:33b73ac:             }
1:33b73ac:         } else {
1:33b73ac:             return wireFormat.tightUnmarshalNestedObject(dataIn, bs);
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected int tightMarshalCachedObject1(OpenWireFormat wireFormat, DataStructure o, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (wireFormat.isCacheEnabled()) {
1:33b73ac:             Short index = wireFormat.getMarshallCacheIndex(o);
1:33b73ac:             bs.writeBoolean(index == null);
1:f812e34:             if (index == null) {
1:33b73ac:                 int rc = wireFormat.tightMarshalNestedObject1(o, bs);
1:33b73ac:                 wireFormat.addToMarshallCache(o);
1:f812e34:                 return 2 + rc;
1:33b73ac:             } else {
1:33b73ac:                 return 2;
1:f812e34:             }
1:33b73ac:         } else {
1:33b73ac:             return wireFormat.tightMarshalNestedObject1(o, bs);
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void tightMarshalCachedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut,
1:f812e34:                                              BooleanStream bs) throws IOException {
1:f812e34:         if (wireFormat.isCacheEnabled()) {
1:33b73ac:             Short index = wireFormat.getMarshallCacheIndex(o);
1:f812e34:             if (bs.readBoolean()) {
1:33b73ac:                 dataOut.writeShort(index.shortValue());
1:33b73ac:                 wireFormat.tightMarshalNestedObject2(o, dataOut, bs);
1:33b73ac:             } else {
1:33b73ac:                 dataOut.writeShort(index.shortValue());
1:33b73ac:             }
1:33b73ac:         } else {
1:33b73ac:             wireFormat.tightMarshalNestedObject2(o, dataOut, bs);
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected Throwable tightUnmarsalThrowable(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:f812e34:             String clazz = tightUnmarshalString(dataIn, bs);
1:33b73ac:             String message = tightUnmarshalString(dataIn, bs);
1:33b73ac:             Throwable o = createThrowable(clazz, message);
1:f812e34:             if (wireFormat.isStackTraceEnabled()) {
1:f812e34:                 if (STACK_TRACE_ELEMENT_CONSTRUCTOR != null) {
1:33b73ac:                     StackTraceElement ss[] = new StackTraceElement[dataIn.readShort()];
1:33b73ac:                     for (int i = 0; i < ss.length; i++) {
1:33b73ac:                         try {
1:f812e34:                             ss[i] = (StackTraceElement)STACK_TRACE_ELEMENT_CONSTRUCTOR
1:f812e34:                                 .newInstance(new Object[] {tightUnmarshalString(dataIn, bs),
1:f812e34:                                                            tightUnmarshalString(dataIn, bs),
1:f812e34:                                                            tightUnmarshalString(dataIn, bs),
1:f812e34:                                                            new Integer(dataIn.readInt())});
1:33b73ac:                         } catch (IOException e) {
1:33b73ac:                             throw e;
2:33b73ac:                         } catch (Throwable e) {
1:33b73ac:                         }
1:33b73ac:                     }
1:33b73ac:                     o.setStackTrace(ss);
1:33b73ac:                 } else {
1:33b73ac:                     short size = dataIn.readShort();
1:33b73ac:                     for (int i = 0; i < size; i++) {
3:33b73ac:                         tightUnmarshalString(dataIn, bs);
1:f812e34:                         tightUnmarshalString(dataIn, bs);
1:f812e34:                         tightUnmarshalString(dataIn, bs);
1:33b73ac:                         dataIn.readInt();
1:33b73ac:                     }
1:33b73ac:                 }
1:33b73ac:                 o.initCause(tightUnmarsalThrowable(wireFormat, dataIn, bs));
1:f812e34: 
1:33b73ac:             }
1:33b73ac:             return o;
1:33b73ac:         } else {
1:33b73ac:             return null;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:33b73ac:     private Throwable createThrowable(String className, String message) {
1:33b73ac:         try {
1:27c87d2:             Class clazz = Class.forName(className, false, BaseDataStreamMarshaller.class.getClassLoader());
1:f812e34:             Constructor constructor = clazz.getConstructor(new Class[] {String.class});
1:f812e34:             return (Throwable)constructor.newInstance(new Object[] {message});
1:33b73ac:         } catch (Throwable e) {
1:f812e34:             return new Throwable(className + ": " + message);
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected int tightMarshalThrowable1(OpenWireFormat wireFormat, Throwable o, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (o == null) {
1:33b73ac:             bs.writeBoolean(false);
1:33b73ac:             return 0;
1:33b73ac:         } else {
1:f812e34:             int rc = 0;
1:33b73ac:             bs.writeBoolean(true);
1:33b73ac:             rc += tightMarshalString1(o.getClass().getName(), bs);
1:33b73ac:             rc += tightMarshalString1(o.getMessage(), bs);
1:f812e34:             if (wireFormat.isStackTraceEnabled()) {
1:33b73ac:                 rc += 2;
1:33b73ac:                 StackTraceElement[] stackTrace = o.getStackTrace();
1:33b73ac:                 for (int i = 0; i < stackTrace.length; i++) {
1:33b73ac:                     StackTraceElement element = stackTrace[i];
1:33b73ac:                     rc += tightMarshalString1(element.getClassName(), bs);
1:33b73ac:                     rc += tightMarshalString1(element.getMethodName(), bs);
1:33b73ac:                     rc += tightMarshalString1(element.getFileName(), bs);
1:33b73ac:                     rc += 4;
1:33b73ac:                 }
1:33b73ac:                 rc += tightMarshalThrowable1(wireFormat, o.getCause(), bs);
1:33b73ac:             }
1:33b73ac:             return rc;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void tightMarshalThrowable2(OpenWireFormat wireFormat, Throwable o, DataOutput dataOut,
1:f812e34:                                           BooleanStream bs) throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             tightMarshalString2(o.getClass().getName(), dataOut, bs);
1:33b73ac:             tightMarshalString2(o.getMessage(), dataOut, bs);
1:f812e34:             if (wireFormat.isStackTraceEnabled()) {
1:33b73ac:                 StackTraceElement[] stackTrace = o.getStackTrace();
1:33b73ac:                 dataOut.writeShort(stackTrace.length);
1:33b73ac:                 for (int i = 0; i < stackTrace.length; i++) {
1:33b73ac:                     StackTraceElement element = stackTrace[i];
1:33b73ac:                     tightMarshalString2(element.getClassName(), dataOut, bs);
1:33b73ac:                     tightMarshalString2(element.getMethodName(), dataOut, bs);
1:33b73ac:                     tightMarshalString2(element.getFileName(), dataOut, bs);
1:33b73ac:                     dataOut.writeInt(element.getLineNumber());
1:33b73ac:                 }
1:33b73ac:                 tightMarshalThrowable2(wireFormat, o.getCause(), dataOut, bs);
1:33b73ac:             }
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:933eb2f:     @SuppressWarnings("deprecation")
1:4821b9d:     protected String tightUnmarshalString(DataInput dataIn, BooleanStream bs) throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:f812e34:             if (bs.readBoolean()) {
1:33b73ac:                 int size = dataIn.readShort();
1:33b73ac:                 byte data[] = new byte[size];
1:33b73ac:                 dataIn.readFully(data);
1:933eb2f:                 // Yes deprecated, but we know what we are doing.
1:933eb2f:                 // This allows us to create a String from a ASCII byte array. (no UTF-8 decoding)
1:933eb2f:                 return new String(data, 0);
1:f812e34:             } else {
1:33b73ac:                 return dataIn.readUTF();
1:33b73ac:             }
1:33b73ac:         } else {
1:33b73ac:             return null;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected int tightMarshalString1(String value, BooleanStream bs) throws IOException {
1:f812e34:         bs.writeBoolean(value != null);
1:f812e34:         if (value != null) {
1:f812e34: 
1:33b73ac:             int strlen = value.length();
1:33b73ac:             int utflen = 0;
1:33b73ac:             char[] charr = new char[strlen];
1:933eb2f:             int c = 0;
1:f812e34:             boolean isOnlyAscii = true;
1:33b73ac: 
1:33b73ac:             value.getChars(0, strlen, charr, 0);
1:33b73ac: 
1:33b73ac:             for (int i = 0; i < strlen; i++) {
1:33b73ac:                 c = charr[i];
1:33b73ac:                 if ((c >= 0x0001) && (c <= 0x007F)) {
1:33b73ac:                     utflen++;
1:33b73ac:                 } else if (c > 0x07FF) {
1:33b73ac:                     utflen += 3;
1:f812e34:                     isOnlyAscii = false;
1:33b73ac:                 } else {
1:f812e34:                     isOnlyAscii = false;
1:33b73ac:                     utflen += 2;
1:33b73ac:                 }
1:33b73ac:             }
1:f812e34: 
1:f812e34:             if (utflen >= Short.MAX_VALUE) {
1:33b73ac:                 throw new IOException("Encountered a String value that is too long to encode.");
1:f812e34:             }
1:f812e34:             bs.writeBoolean(isOnlyAscii);
1:f812e34:             return utflen + 2;
1:f812e34: 
1:33b73ac:         } else {
1:33b73ac:             return 0;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:4821b9d:     protected void tightMarshalString2(String value, DataOutput dataOut, BooleanStream bs) throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             // If we verified it only holds ascii values
1:f812e34:             if (bs.readBoolean()) {
1:33b73ac:                 dataOut.writeShort(value.length());
1:33b73ac:                 dataOut.writeBytes(value);
1:33b73ac:             } else {
1:f812e34:                 dataOut.writeUTF(value);
1:f812e34:             }
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected int tightMarshalObjectArray1(OpenWireFormat wireFormat, DataStructure[] objects,
1:f812e34:                                            BooleanStream bs) throws IOException {
1:f812e34:         if (objects != null) {
1:f812e34:             int rc = 0;
1:33b73ac:             bs.writeBoolean(true);
1:33b73ac:             rc += 2;
1:f812e34:             for (int i = 0; i < objects.length; i++) {
1:f812e34:                 rc += tightMarshalNestedObject1(wireFormat, objects[i], bs);
1:33b73ac:             }
1:33b73ac:             return rc;
1:33b73ac:         } else {
1:33b73ac:             bs.writeBoolean(false);
1:33b73ac:             return 0;
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:f812e34:     protected void tightMarshalObjectArray2(OpenWireFormat wireFormat, DataStructure[] objects,
1:f812e34:                                             DataOutput dataOut, BooleanStream bs) throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             dataOut.writeShort(objects.length);
1:f812e34:             for (int i = 0; i < objects.length; i++) {
1:f812e34:                 tightMarshalNestedObject2(wireFormat, objects[i], dataOut, bs);
1:33b73ac:             }
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:33b73ac:     protected int tightMarshalConstByteArray1(byte[] data, BooleanStream bs, int i) throws IOException {
1:33b73ac:         return i;
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void tightMarshalConstByteArray2(byte[] data, DataOutput dataOut, BooleanStream bs, int i)
1:f812e34:         throws IOException {
1:33b73ac:         dataOut.write(data, 0, i);
1:33b73ac:     }
1:33b73ac: 
1:f812e34:     protected byte[] tightUnmarshalConstByteArray(DataInput dataIn, BooleanStream bs, int i)
1:f812e34:         throws IOException {
1:33b73ac:         byte data[] = new byte[i];
1:33b73ac:         dataIn.readFully(data);
1:33b73ac:         return data;
1:33b73ac:     }
1:33b73ac: 
1:33b73ac:     protected int tightMarshalByteArray1(byte[] data, BooleanStream bs) throws IOException {
1:f812e34:         bs.writeBoolean(data != null);
1:f812e34:         if (data != null) {
1:f812e34:             return data.length + 4;
1:33b73ac:         } else {
1:33b73ac:             return 0;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void tightMarshalByteArray2(byte[] data, DataOutput dataOut, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             dataOut.writeInt(data.length);
1:33b73ac:             dataOut.write(data);
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:4821b9d:     protected byte[] tightUnmarshalByteArray(DataInput dataIn, BooleanStream bs) throws IOException {
1:f812e34:         byte rc[] = null;
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             int size = dataIn.readInt();
1:33b73ac:             rc = new byte[size];
1:33b73ac:             dataIn.readFully(rc);
1:33b73ac:         }
1:33b73ac:         return rc;
1:33b73ac:     }
1:f812e34: 
1:33b73ac:     protected int tightMarshalByteSequence1(ByteSequence data, BooleanStream bs) throws IOException {
1:f812e34:         bs.writeBoolean(data != null);
1:f812e34:         if (data != null) {
1:f812e34:             return data.getLength() + 4;
1:33b73ac:         } else {
1:33b73ac:             return 0;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void tightMarshalByteSequence2(ByteSequence data, DataOutput dataOut, BooleanStream bs)
1:f812e34:         throws IOException {
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             dataOut.writeInt(data.getLength());
1:33b73ac:             dataOut.write(data.getData(), data.getOffset(), data.getLength());
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:4821b9d:     protected ByteSequence tightUnmarshalByteSequence(DataInput dataIn, BooleanStream bs) throws IOException {
1:f812e34:         ByteSequence rc = null;
1:f812e34:         if (bs.readBoolean()) {
1:33b73ac:             int size = dataIn.readInt();
1:33b73ac:             byte[] t = new byte[size];
1:33b73ac:             dataIn.readFully(t);
1:33b73ac:             return new ByteSequence(t, 0, size);
1:33b73ac:         }
1:33b73ac:         return rc;
1:33b73ac:     }
1:33b73ac: 
1:33b73ac:     //
1:33b73ac:     // The loose marshaling logic
1:33b73ac:     //
1:f812e34: 
1:f812e34:     public void looseMarshal(OpenWireFormat wireFormat, Object o, DataOutput dataOut) throws IOException {
1:33b73ac:     }
1:f812e34: 
1:f812e34:     public void looseUnmarshal(OpenWireFormat wireFormat, Object o, DataInput dataIn) throws IOException {
1:33b73ac:     }
1:f812e34: 
1:4821b9d:     public void looseMarshalLong(OpenWireFormat wireFormat, long o, DataOutput dataOut) throws IOException {
1:33b73ac:         dataOut.writeLong(o);
1:33b73ac:     }
1:f812e34: 
1:4821b9d:     public long looseUnmarshalLong(OpenWireFormat wireFormat, DataInput dataIn) throws IOException {
1:33b73ac:         return dataIn.readLong();
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected DataStructure looseUnmarsalNestedObject(OpenWireFormat wireFormat, DataInput dataIn)
1:f812e34:         throws IOException {
1:33b73ac:         return wireFormat.looseUnmarshalNestedObject(dataIn);
1:f812e34:     }
1:f812e34: 
1:f812e34:     protected void looseMarshalNestedObject(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut)
1:f812e34:         throws IOException {
1:33b73ac:         wireFormat.looseMarshalNestedObject(o, dataOut);
1:f812e34:     }
1:f812e34: 
1:f812e34:     protected DataStructure looseUnmarsalCachedObject(OpenWireFormat wireFormat, DataInput dataIn)
1:f812e34:         throws IOException {
1:f812e34:         if (wireFormat.isCacheEnabled()) {
1:f812e34:             if (dataIn.readBoolean()) {
1:33b73ac:                 short index = dataIn.readShort();
1:33b73ac:                 DataStructure object = wireFormat.looseUnmarshalNestedObject(dataIn);
1:33b73ac:                 wireFormat.setInUnmarshallCache(index, object);
1:33b73ac:                 return object;
1:33b73ac:             } else {
1:33b73ac:                 short index = dataIn.readShort();
1:33b73ac:                 return wireFormat.getFromUnmarshallCache(index);
1:33b73ac:             }
1:33b73ac:         } else {
1:33b73ac:             return wireFormat.looseUnmarshalNestedObject(dataIn);
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void looseMarshalCachedObject(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut)
1:f812e34:         throws IOException {
1:f812e34:         if (wireFormat.isCacheEnabled()) {
1:33b73ac:             Short index = wireFormat.getMarshallCacheIndex(o);
1:33b73ac:             dataOut.writeBoolean(index == null);
1:f812e34:             if (index == null) {
1:33b73ac:                 index = wireFormat.addToMarshallCache(o);
1:33b73ac:                 dataOut.writeShort(index.shortValue());
1:33b73ac:                 wireFormat.looseMarshalNestedObject(o, dataOut);
1:33b73ac:             } else {
1:33b73ac:                 dataOut.writeShort(index.shortValue());
1:33b73ac:             }
1:33b73ac:         } else {
1:33b73ac:             wireFormat.looseMarshalNestedObject(o, dataOut);
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:f812e34:     protected Throwable looseUnmarsalThrowable(OpenWireFormat wireFormat, DataInput dataIn)
1:f812e34:         throws IOException {
1:f812e34:         if (dataIn.readBoolean()) {
1:f812e34:             String clazz = looseUnmarshalString(dataIn);
1:33b73ac:             String message = looseUnmarshalString(dataIn);
1:33b73ac:             Throwable o = createThrowable(clazz, message);
1:f812e34:             if (wireFormat.isStackTraceEnabled()) {
1:f812e34:                 if (STACK_TRACE_ELEMENT_CONSTRUCTOR != null) {
1:33b73ac:                     StackTraceElement ss[] = new StackTraceElement[dataIn.readShort()];
1:33b73ac:                     for (int i = 0; i < ss.length; i++) {
1:33b73ac:                         try {
1:f812e34:                             ss[i] = (StackTraceElement)STACK_TRACE_ELEMENT_CONSTRUCTOR
1:f812e34:                                 .newInstance(new Object[] {looseUnmarshalString(dataIn),
1:f812e34:                                                            looseUnmarshalString(dataIn),
1:f812e34:                                                            looseUnmarshalString(dataIn),
1:f812e34:                                                            new Integer(dataIn.readInt())});
1:33b73ac:                         } catch (IOException e) {
1:33b73ac:                             throw e;
1:33b73ac:                         } catch (Throwable e) {
1:33b73ac:                         }
1:33b73ac:                     }
1:33b73ac:                     o.setStackTrace(ss);
1:33b73ac:                 } else {
1:33b73ac:                     short size = dataIn.readShort();
1:33b73ac:                     for (int i = 0; i < size; i++) {
3:33b73ac:                         looseUnmarshalString(dataIn);
1:f812e34:                         looseUnmarshalString(dataIn);
1:f812e34:                         looseUnmarshalString(dataIn);
1:33b73ac:                         dataIn.readInt();
1:33b73ac:                     }
1:33b73ac:                 }
1:33b73ac:                 o.initCause(looseUnmarsalThrowable(wireFormat, dataIn));
1:f812e34: 
1:33b73ac:             }
1:33b73ac:             return o;
1:33b73ac:         } else {
1:33b73ac:             return null;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void looseMarshalThrowable(OpenWireFormat wireFormat, Throwable o, DataOutput dataOut)
1:f812e34:         throws IOException {
1:f812e34:         dataOut.writeBoolean(o != null);
1:f812e34:         if (o != null) {
1:33b73ac:             looseMarshalString(o.getClass().getName(), dataOut);
1:33b73ac:             looseMarshalString(o.getMessage(), dataOut);
1:f812e34:             if (wireFormat.isStackTraceEnabled()) {
1:33b73ac:                 StackTraceElement[] stackTrace = o.getStackTrace();
1:33b73ac:                 dataOut.writeShort(stackTrace.length);
1:33b73ac:                 for (int i = 0; i < stackTrace.length; i++) {
1:33b73ac:                     StackTraceElement element = stackTrace[i];
1:33b73ac:                     looseMarshalString(element.getClassName(), dataOut);
1:33b73ac:                     looseMarshalString(element.getMethodName(), dataOut);
1:33b73ac:                     looseMarshalString(element.getFileName(), dataOut);
1:33b73ac:                     dataOut.writeInt(element.getLineNumber());
1:33b73ac:                 }
1:33b73ac:                 looseMarshalThrowable(wireFormat, o.getCause(), dataOut);
1:33b73ac:             }
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:4821b9d:     protected String looseUnmarshalString(DataInput dataIn) throws IOException {
1:f812e34:         if (dataIn.readBoolean()) {
1:33b73ac:             return dataIn.readUTF();
1:33b73ac:         } else {
1:33b73ac:             return null;
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:4821b9d:     protected void looseMarshalString(String value, DataOutput dataOut) throws IOException {
1:f812e34:         dataOut.writeBoolean(value != null);
1:f812e34:         if (value != null) {
1:f812e34:             dataOut.writeUTF(value);
1:f812e34:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void looseMarshalObjectArray(OpenWireFormat wireFormat, DataStructure[] objects,
1:f812e34:                                            DataOutput dataOut) throws IOException {
1:f812e34:         dataOut.writeBoolean(objects != null);
1:f812e34:         if (objects != null) {
1:33b73ac:             dataOut.writeShort(objects.length);
1:f812e34:             for (int i = 0; i < objects.length; i++) {
1:f812e34:                 looseMarshalNestedObject(wireFormat, objects[i], dataOut);
1:33b73ac:             }
1:33b73ac:         }
1:33b73ac:     }
1:f812e34: 
1:f812e34:     protected void looseMarshalConstByteArray(OpenWireFormat wireFormat, byte[] data, DataOutput dataOut,
1:f812e34:                                               int i) throws IOException {
1:33b73ac:         dataOut.write(data, 0, i);
1:33b73ac:     }
1:33b73ac: 
1:4821b9d:     protected byte[] looseUnmarshalConstByteArray(DataInput dataIn, int i) throws IOException {
1:33b73ac:         byte data[] = new byte[i];
1:33b73ac:         dataIn.readFully(data);
1:33b73ac:         return data;
1:33b73ac:     }
1:33b73ac: 
1:f812e34:     protected void looseMarshalByteArray(OpenWireFormat wireFormat, byte[] data, DataOutput dataOut)
1:f812e34:         throws IOException {
1:f812e34:         dataOut.writeBoolean(data != null);
1:f812e34:         if (data != null) {
1:33b73ac:             dataOut.writeInt(data.length);
1:33b73ac:             dataOut.write(data);
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:4821b9d:     protected byte[] looseUnmarshalByteArray(DataInput dataIn) throws IOException {
1:f812e34:         byte rc[] = null;
1:f812e34:         if (dataIn.readBoolean()) {
1:33b73ac:             int size = dataIn.readInt();
1:33b73ac:             rc = new byte[size];
1:33b73ac:             dataIn.readFully(rc);
1:33b73ac:         }
1:33b73ac:         return rc;
1:33b73ac:     }
1:33b73ac: 
1:f812e34:     protected void looseMarshalByteSequence(OpenWireFormat wireFormat, ByteSequence data, DataOutput dataOut)
1:f812e34:         throws IOException {
1:f812e34:         dataOut.writeBoolean(data != null);
1:f812e34:         if (data != null) {
1:33b73ac:             dataOut.writeInt(data.getLength());
1:33b73ac:             dataOut.write(data.getData(), data.getOffset(), data.getLength());
1:33b73ac:         }
1:33b73ac:     }
1:33b73ac: 
1:4821b9d:     protected ByteSequence looseUnmarshalByteSequence(DataInput dataIn) throws IOException {
1:f812e34:         ByteSequence rc = null;
1:f812e34:         if (dataIn.readBoolean()) {
1:33b73ac:             int size = dataIn.readInt();
1:33b73ac:             byte[] t = new byte[size];
1:33b73ac:             dataIn.readFully(t);
1:33b73ac:             rc = new ByteSequence(t, 0, size);
1:33b73ac:         }
1:33b73ac:         return rc;
1:33b73ac:     }
1:33b73ac: }
============================================================================
author:Hadrian Zbarcea
-------------------------------------------------------------------------------
commit:d54d046
author:Hiram R. Chirino
-------------------------------------------------------------------------------
commit:9a8f6e4
commit:27c87d2
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
1:             Class clazz = Class.forName(className, false, BaseDataStreamMarshaller.class.getClassLoader());
commit:933eb2f
/////////////////////////////////////////////////////////////////////////
1:     @SuppressWarnings("deprecation")
1:                 // Yes deprecated, but we know what we are doing.
1:                 // This allows us to create a String from a ASCII byte array. (no UTF-8 decoding)
1:                 return new String(data, 0);
/////////////////////////////////////////////////////////////////////////
1:             int c = 0;
commit:fc00993
/////////////////////////////////////////////////////////////////////////
1: public abstract class BaseDataStreamMarshaller implements DataStreamMarshaller {
1:     public static final Constructor STACK_TRACE_ELEMENT_CONSTRUCTOR;
/////////////////////////////////////////////////////////////////////////
1:     public abstract byte getDataStructureType();
1:     public abstract DataStructure createObject();
commit:74a7a8b
/////////////////////////////////////////////////////////////////////////
1:         } else if ((o & 0xFFFFFFFFFFFF0000L) == 0) {
1:         } else if ((o & 0xFFFFFFFF00000000L) == 0) {
commit:f812e34
/////////////////////////////////////////////////////////////////////////
1: 
1:         Constructor constructor = null;
1:             constructor = StackTraceElement.class.getConstructor(new Class[] {String.class, String.class,
1:                                                                               String.class, int.class});
1:         } catch (Throwable e) {
1: 
1: 
1: 
1:     public void tightMarshal2(OpenWireFormat wireFormat, Object o, DataOutput dataOut, BooleanStream bs)
1:         throws IOException {
1: 
1:     public void tightUnmarshal(OpenWireFormat wireFormat, Object o, DataInput dataIn, BooleanStream bs)
1:         throws IOException {
1: 
1:         if (o == 0) {
0:         } else if ((o & 0xFFFFFFFFFFFF0000l) == 0) {
1:             bs.writeBoolean(true);
0:         } else if ((o & 0xFFFFFFFF00000000l) == 0) {
/////////////////////////////////////////////////////////////////////////
1: 
1:     public void tightMarshalLong2(OpenWireFormat wireFormat, long o, DataOutput dataOut, BooleanStream bs)
1:         throws IOException {
1:         if (bs.readBoolean()) {
1:             if (bs.readBoolean()) {
1:                 dataOut.writeInt((int)o);
1:             if (bs.readBoolean()) {
1:                 dataOut.writeShort((int)o);
1: 
1:     public long tightUnmarshalLong(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs)
1:         throws IOException {
1:         if (bs.readBoolean()) {
1:             if (bs.readBoolean()) {
1:             if (bs.readBoolean()) {
1: 
1: 
1: 
1:     protected DataStructure tightUnmarsalNestedObject(OpenWireFormat wireFormat, DataInput dataIn,
1:                                                       BooleanStream bs) throws IOException {
1:     }
1: 
1:     protected int tightMarshalNestedObject1(OpenWireFormat wireFormat, DataStructure o, BooleanStream bs)
1:         throws IOException {
1: 
1:     protected void tightMarshalNestedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut,
1:                                              BooleanStream bs) throws IOException {
1:     protected DataStructure tightUnmarsalCachedObject(OpenWireFormat wireFormat, DataInput dataIn,
1:                                                       BooleanStream bs) throws IOException {
1:         if (wireFormat.isCacheEnabled()) {
1:             if (bs.readBoolean()) {
/////////////////////////////////////////////////////////////////////////
1:     }
1: 
1:     protected int tightMarshalCachedObject1(OpenWireFormat wireFormat, DataStructure o, BooleanStream bs)
1:         throws IOException {
1:         if (wireFormat.isCacheEnabled()) {
1:             if (index == null) {
1:                 return 2 + rc;
1:     }
1: 
1:     protected void tightMarshalCachedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut,
1:                                              BooleanStream bs) throws IOException {
1:         if (wireFormat.isCacheEnabled()) {
1:             if (bs.readBoolean()) {
/////////////////////////////////////////////////////////////////////////
1: 
1:     protected Throwable tightUnmarsalThrowable(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs)
1:         throws IOException {
1:         if (bs.readBoolean()) {
1:             String clazz = tightUnmarshalString(dataIn, bs);
1:             if (wireFormat.isStackTraceEnabled()) {
1:                 if (STACK_TRACE_ELEMENT_CONSTRUCTOR != null) {
1:                             ss[i] = (StackTraceElement)STACK_TRACE_ELEMENT_CONSTRUCTOR
1:                                 .newInstance(new Object[] {tightUnmarshalString(dataIn, bs),
1:                                                            tightUnmarshalString(dataIn, bs),
1:                                                            tightUnmarshalString(dataIn, bs),
1:                                                            new Integer(dataIn.readInt())});
/////////////////////////////////////////////////////////////////////////
1:                         tightUnmarshalString(dataIn, bs);
1:                         tightUnmarshalString(dataIn, bs);
1: 
1: 
1:             Constructor constructor = clazz.getConstructor(new Class[] {String.class});
1:             return (Throwable)constructor.newInstance(new Object[] {message});
1:             return new Throwable(className + ": " + message);
1: 
1:     protected int tightMarshalThrowable1(OpenWireFormat wireFormat, Throwable o, BooleanStream bs)
1:         throws IOException {
1:         if (o == null) {
1:             int rc = 0;
1:             if (wireFormat.isStackTraceEnabled()) {
/////////////////////////////////////////////////////////////////////////
1: 
1:     protected void tightMarshalThrowable2(OpenWireFormat wireFormat, Throwable o, DataOutput dataOut,
1:                                           BooleanStream bs) throws IOException {
1:         if (bs.readBoolean()) {
1:             if (wireFormat.isStackTraceEnabled()) {
/////////////////////////////////////////////////////////////////////////
1: 
1:         if (bs.readBoolean()) {
1:             if (bs.readBoolean()) {
0:                 return new String(data, 0); // Yes deprecated, but we know what
0:                                             // we are doing.
1:             } else {
1: 
1:     protected int tightMarshalString1(String value, BooleanStream bs) throws IOException {
1:         bs.writeBoolean(value != null);
1:         if (value != null) {
1: 
1:             boolean isOnlyAscii = true;
/////////////////////////////////////////////////////////////////////////
1:                     isOnlyAscii = false;
1:                     isOnlyAscii = false;
1: 
1:             if (utflen >= Short.MAX_VALUE) {
1:             }
1:             bs.writeBoolean(isOnlyAscii);
1:             return utflen + 2;
1: 
1: 
1:         if (bs.readBoolean()) {
1:             if (bs.readBoolean()) {
1:                 dataOut.writeUTF(value);
1:     }
1: 
1:     protected int tightMarshalObjectArray1(OpenWireFormat wireFormat, DataStructure[] objects,
1:                                            BooleanStream bs) throws IOException {
1:         if (objects != null) {
1:             int rc = 0;
1:             for (int i = 0; i < objects.length; i++) {
1:                 rc += tightMarshalNestedObject1(wireFormat, objects[i], bs);
/////////////////////////////////////////////////////////////////////////
1: 
1:     protected void tightMarshalObjectArray2(OpenWireFormat wireFormat, DataStructure[] objects,
1:                                             DataOutput dataOut, BooleanStream bs) throws IOException {
1:         if (bs.readBoolean()) {
1:             for (int i = 0; i < objects.length; i++) {
1:                 tightMarshalNestedObject2(wireFormat, objects[i], dataOut, bs);
/////////////////////////////////////////////////////////////////////////
1: 
1:     protected void tightMarshalConstByteArray2(byte[] data, DataOutput dataOut, BooleanStream bs, int i)
1:         throws IOException {
1:     protected byte[] tightUnmarshalConstByteArray(DataInput dataIn, BooleanStream bs, int i)
1:         throws IOException {
1:         bs.writeBoolean(data != null);
1:         if (data != null) {
1:             return data.length + 4;
1: 
1:     protected void tightMarshalByteArray2(byte[] data, DataOutput dataOut, BooleanStream bs)
1:         throws IOException {
1:         if (bs.readBoolean()) {
1:         byte rc[] = null;
1:         if (bs.readBoolean()) {
1: 
1:         bs.writeBoolean(data != null);
1:         if (data != null) {
1:             return data.getLength() + 4;
1: 
1:     protected void tightMarshalByteSequence2(ByteSequence data, DataOutput dataOut, BooleanStream bs)
1:         throws IOException {
1:         if (bs.readBoolean()) {
1:         ByteSequence rc = null;
1:         if (bs.readBoolean()) {
/////////////////////////////////////////////////////////////////////////
1: 
1:     public void looseMarshal(OpenWireFormat wireFormat, Object o, DataOutput dataOut) throws IOException {
1: 
1:     public void looseUnmarshal(OpenWireFormat wireFormat, Object o, DataInput dataIn) throws IOException {
1: 
1: 
1: 
1:     protected DataStructure looseUnmarsalNestedObject(OpenWireFormat wireFormat, DataInput dataIn)
1:         throws IOException {
1:     }
1: 
1:     protected void looseMarshalNestedObject(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut)
1:         throws IOException {
1:     protected DataStructure looseUnmarsalCachedObject(OpenWireFormat wireFormat, DataInput dataIn)
1:         throws IOException {
1:         if (wireFormat.isCacheEnabled()) {
1:             if (dataIn.readBoolean()) {
/////////////////////////////////////////////////////////////////////////
1:     }
1: 
1:     protected void looseMarshalCachedObject(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut)
1:         throws IOException {
1:         if (wireFormat.isCacheEnabled()) {
1:             if (index == null) {
/////////////////////////////////////////////////////////////////////////
1: 
1:     protected Throwable looseUnmarsalThrowable(OpenWireFormat wireFormat, DataInput dataIn)
1:         throws IOException {
1:         if (dataIn.readBoolean()) {
1:             String clazz = looseUnmarshalString(dataIn);
1:             if (wireFormat.isStackTraceEnabled()) {
1:                 if (STACK_TRACE_ELEMENT_CONSTRUCTOR != null) {
1:                             ss[i] = (StackTraceElement)STACK_TRACE_ELEMENT_CONSTRUCTOR
1:                                 .newInstance(new Object[] {looseUnmarshalString(dataIn),
1:                                                            looseUnmarshalString(dataIn),
1:                                                            looseUnmarshalString(dataIn),
1:                                                            new Integer(dataIn.readInt())});
/////////////////////////////////////////////////////////////////////////
1:                         looseUnmarshalString(dataIn);
1:                         looseUnmarshalString(dataIn);
1: 
1: 
1:     protected void looseMarshalThrowable(OpenWireFormat wireFormat, Throwable o, DataOutput dataOut)
1:         throws IOException {
1:         dataOut.writeBoolean(o != null);
1:         if (o != null) {
1:             if (wireFormat.isStackTraceEnabled()) {
/////////////////////////////////////////////////////////////////////////
1: 
1:         if (dataIn.readBoolean()) {
1: 
1:         dataOut.writeBoolean(value != null);
1:         if (value != null) {
1:             dataOut.writeUTF(value);
1:     }
1: 
1:     protected void looseMarshalObjectArray(OpenWireFormat wireFormat, DataStructure[] objects,
1:                                            DataOutput dataOut) throws IOException {
1:         dataOut.writeBoolean(objects != null);
1:         if (objects != null) {
1:             for (int i = 0; i < objects.length; i++) {
1:                 looseMarshalNestedObject(wireFormat, objects[i], dataOut);
1: 
1:     protected void looseMarshalConstByteArray(OpenWireFormat wireFormat, byte[] data, DataOutput dataOut,
1:                                               int i) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected void looseMarshalByteArray(OpenWireFormat wireFormat, byte[] data, DataOutput dataOut)
1:         throws IOException {
1:         dataOut.writeBoolean(data != null);
1:         if (data != null) {
1:         byte rc[] = null;
1:         if (dataIn.readBoolean()) {
/////////////////////////////////////////////////////////////////////////
1:     protected void looseMarshalByteSequence(OpenWireFormat wireFormat, ByteSequence data, DataOutput dataOut)
1:         throws IOException {
1:         dataOut.writeBoolean(data != null);
1:         if (data != null) {
1:         ByteSequence rc = null;
1:         if (dataIn.readBoolean()) {
commit:230a86c
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
1:  *      http://www.apache.org/licenses/LICENSE-2.0
commit:88acb0e
/////////////////////////////////////////////////////////////////////////
1: import org.apache.activemq.util.ByteSequence;
commit:57b4941
/////////////////////////////////////////////////////////////////////////
1:  * Licensed to the Apache Software Foundation (ASF) under one or more
1:  * contributor license agreements.  See the NOTICE file distributed with
1:  * this work for additional information regarding copyright ownership.
1:  * The ASF licenses this file to You under the Apache License, Version 2.0
1:  * (the "License"); you may not use this file except in compliance with
1:  * the License.  You may obtain a copy of the License at
commit:f451ad0
/////////////////////////////////////////////////////////////////////////
0: import org.apache.activeio.packet.ByteSequence;
0: import org.apache.activemq.util.ClassLoading;
commit:33b73ac
/////////////////////////////////////////////////////////////////////////
1: /**
1:  *
0:  * Copyright 2005-2006 The Apache Software Foundation
1:  *
0:  * Licensed under the Apache License, Version 2.0 (the "License");
0:  * you may not use this file except in compliance with the License.
0:  * You may obtain a copy of the License at
1:  *
0:  * http://www.apache.org/licenses/LICENSE-2.0
1:  *
1:  * Unless required by applicable law or agreed to in writing, software
1:  * distributed under the License is distributed on an "AS IS" BASIS,
1:  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
1:  * See the License for the specific language governing permissions and
1:  * limitations under the License.
1:  */
1: package org.apache.activemq.openwire.v1;
1: 
0: import java.io.DataInputStream;
0: import java.io.DataOutputStream;
1: import java.io.IOException;
1: import java.lang.reflect.Constructor;
1: 
0: import org.activeio.ByteSequence;
0: import org.activeio.command.ClassLoading;
1: import org.apache.activemq.command.DataStructure;
1: import org.apache.activemq.openwire.BooleanStream;
1: import org.apache.activemq.openwire.DataStreamMarshaller;
1: import org.apache.activemq.openwire.OpenWireFormat;
1: 
0: abstract public class BaseDataStreamMarshaller implements DataStreamMarshaller {
1: 
0:     static final public Constructor STACK_TRACE_ELEMENT_CONSTRUCTOR;
1:     
1:     static {
0:         Constructor constructor=null;
1:         try {
0:             constructor = StackTraceElement.class.getConstructor(new Class[]{String.class, String.class, String.class, int.class});            
1:         } catch (Throwable e) {            
1:         }
1:         STACK_TRACE_ELEMENT_CONSTRUCTOR = constructor;
1:     }
1:     
1: 
0:     abstract public byte getDataStructureType();
0:     abstract public DataStructure createObject();
1:     
1:     public int tightMarshal1(OpenWireFormat wireFormat, Object o, BooleanStream bs) throws IOException {
1:         return 0;
1:     }
0:     public void tightMarshal2(OpenWireFormat wireFormat, Object o, DataOutputStream dataOut, BooleanStream bs) throws IOException {        
1:     }
0:     public void tightUnmarshal(OpenWireFormat wireFormat, Object o, DataInputStream dataIn, BooleanStream bs) throws IOException {        
1:     }
1:     
1:     public int tightMarshalLong1(OpenWireFormat wireFormat, long o, BooleanStream bs) throws IOException {
0:         if( o == 0 ) {
1:             bs.writeBoolean(false);
1:             bs.writeBoolean(false);
1:             return 0;
0:         } else if ( (o & 0xFFFFFFFFFFFF0000l ) == 0 ) {
1:             bs.writeBoolean(false);
1:             bs.writeBoolean(true);            
1:             return 2;
0:         } else if ( (o & 0xFFFFFFFF00000000l ) == 0) {
1:             bs.writeBoolean(true);
1:             bs.writeBoolean(false);
1:             return 4;
1:         } else {
1:             bs.writeBoolean(true);
1:             bs.writeBoolean(true);
1:             return 8;
1:         }
1:     }
0:     public void tightMarshalLong2(OpenWireFormat wireFormat, long o, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
0:             if( bs.readBoolean() ) {
1:                 dataOut.writeLong(o);
1:             } else {
0:                 dataOut.writeInt((int) o);
1:             }
1:         } else {
0:             if( bs.readBoolean() ) {
0:                 dataOut.writeShort((int) o);
1:             }
1:         }
1:     }
0:     public long tightUnmarshalLong(OpenWireFormat wireFormat, DataInputStream dataIn, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
0:             if( bs.readBoolean() ) {
1:                 return dataIn.readLong();
1:             } else {
0:                 return dataIn.readInt();
1:             }
1:         } else {
0:             if( bs.readBoolean() ) {
0:                 return dataIn.readShort();
1:             } else {
1:                 return 0;
1:             }
1:         }
1:     }
1:     
0:     protected DataStructure tightUnmarsalNestedObject(OpenWireFormat wireFormat, DataInputStream dataIn, BooleanStream bs) throws IOException {
1:         return wireFormat.tightUnmarshalNestedObject(dataIn, bs);
1:     }    
0:     protected int tightMarshalNestedObject1(OpenWireFormat wireFormat, DataStructure o, BooleanStream bs) throws IOException {
1:         return wireFormat.tightMarshalNestedObject1(o, bs);
1:     }
1:     
0:     protected void tightMarshalNestedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutputStream dataOut, BooleanStream bs) throws IOException {
1:         wireFormat.tightMarshalNestedObject2(o, dataOut, bs);
1:     }
1: 
0:     protected DataStructure tightUnmarsalCachedObject(OpenWireFormat wireFormat, DataInputStream dataIn, BooleanStream bs) throws IOException {
0:         if( wireFormat.isCacheEnabled() ) {
0:             if( bs.readBoolean() ) {
1:                 short index = dataIn.readShort();
1:                 DataStructure object = wireFormat.tightUnmarshalNestedObject(dataIn, bs);
1:                 wireFormat.setInUnmarshallCache(index, object);
1:                 return object;
1:             } else {
1:                 short index = dataIn.readShort();
1:                 return wireFormat.getFromUnmarshallCache(index);
1:             }
1:         } else {
1:             return wireFormat.tightUnmarshalNestedObject(dataIn, bs);
1:         }
1:     }    
0:     protected int tightMarshalCachedObject1(OpenWireFormat wireFormat, DataStructure o, BooleanStream bs) throws IOException {
0:         if( wireFormat.isCacheEnabled() ) {
1:             Short index = wireFormat.getMarshallCacheIndex(o);
1:             bs.writeBoolean(index == null);
0:             if( index == null ) {
1:                 int rc = wireFormat.tightMarshalNestedObject1(o, bs);
1:                 wireFormat.addToMarshallCache(o);
0:                 return 2+rc;
1:             } else {
1:                 return 2;
1:             }
1:         } else {
1:             return wireFormat.tightMarshalNestedObject1(o, bs);
1:         }
1:     }    
0:     protected void tightMarshalCachedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( wireFormat.isCacheEnabled() ) {
1:             Short index = wireFormat.getMarshallCacheIndex(o);
0:             if( bs.readBoolean() ) {
1:                 dataOut.writeShort(index.shortValue());
1:                 wireFormat.tightMarshalNestedObject2(o, dataOut, bs);
1:             } else {
1:                 dataOut.writeShort(index.shortValue());
1:             }
1:         } else {
1:             wireFormat.tightMarshalNestedObject2(o, dataOut, bs);
1:         }
1:     }
1:     
0:     protected Throwable tightUnmarsalThrowable(OpenWireFormat wireFormat, DataInputStream dataIn, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
0:             String clazz =  tightUnmarshalString(dataIn, bs);
1:             String message = tightUnmarshalString(dataIn, bs);
1:             Throwable o = createThrowable(clazz, message);
0:             if( wireFormat.isStackTraceEnabled() ) {
0:                 if( STACK_TRACE_ELEMENT_CONSTRUCTOR!=null) {
1:                     StackTraceElement ss[] = new StackTraceElement[dataIn.readShort()];
1:                     for (int i = 0; i < ss.length; i++) {
1:                         try {
0:                             ss[i] = (StackTraceElement) STACK_TRACE_ELEMENT_CONSTRUCTOR.newInstance(new Object[]{
0:                                 tightUnmarshalString(dataIn, bs),
0:                                 tightUnmarshalString(dataIn, bs), 
0:                                 tightUnmarshalString(dataIn, bs), 
0:                                 new Integer(dataIn.readInt())
0:                                 });
1:                         } catch (IOException e) {
1:                             throw e;
1:                         } catch (Throwable e) {
1:                         }
1:                     }
1:                     o.setStackTrace(ss);
1:                 } else {
1:                     short size = dataIn.readShort();
1:                     for (int i = 0; i < size; i++) {
1:                         tightUnmarshalString(dataIn, bs);
1:                         tightUnmarshalString(dataIn, bs); 
1:                         tightUnmarshalString(dataIn, bs); 
1:                         dataIn.readInt();
1:                     }
1:                 }
1:                 o.initCause(tightUnmarsalThrowable(wireFormat, dataIn, bs));
1:                 
1:             }
1:             return o;
1:         } else {
1:             return null;
1:         }
1:     }
1:     
1:     private Throwable createThrowable(String className, String message) {
1:         try {
0:             Class clazz = ClassLoading.loadClass(className, BaseDataStreamMarshaller.class.getClassLoader());
0:             Constructor constructor = clazz.getConstructor(new Class[]{String.class});
0:             return (Throwable) constructor.newInstance(new Object[]{message});
1:         } catch (Throwable e) {
0:             return new Throwable(className+": "+message);
1:         }
1:     }
1:     
0:     protected int tightMarshalThrowable1(OpenWireFormat wireFormat, Throwable o, BooleanStream bs) throws IOException { 
0:         if( o==null ) {
1:             bs.writeBoolean(false);
1:             return 0;
1:         } else {
0:             int rc=0;
1:             bs.writeBoolean(true);
1:             rc += tightMarshalString1(o.getClass().getName(), bs);
1:             rc += tightMarshalString1(o.getMessage(), bs);
0:             if( wireFormat.isStackTraceEnabled() ) {
1:                 rc += 2;
1:                 StackTraceElement[] stackTrace = o.getStackTrace();
1:                 for (int i = 0; i < stackTrace.length; i++) {
1:                     StackTraceElement element = stackTrace[i];
1:                     rc += tightMarshalString1(element.getClassName(), bs);
1:                     rc += tightMarshalString1(element.getMethodName(), bs);
1:                     rc += tightMarshalString1(element.getFileName(), bs);
1:                     rc += 4;
1:                 }
1:                 rc += tightMarshalThrowable1(wireFormat, o.getCause(), bs);
1:             }
1:             return rc;
1:         }
1:     }
1:     
0:     protected void tightMarshalThrowable2(OpenWireFormat wireFormat, Throwable o, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
1:             tightMarshalString2(o.getClass().getName(), dataOut, bs);
1:             tightMarshalString2(o.getMessage(), dataOut, bs);
0:             if( wireFormat.isStackTraceEnabled() ) {
1:                 StackTraceElement[] stackTrace = o.getStackTrace();
1:                 dataOut.writeShort(stackTrace.length);
1:                 for (int i = 0; i < stackTrace.length; i++) {
1:                     StackTraceElement element = stackTrace[i];
1:                     tightMarshalString2(element.getClassName(), dataOut, bs);
1:                     tightMarshalString2(element.getMethodName(), dataOut, bs);
1:                     tightMarshalString2(element.getFileName(), dataOut, bs);
1:                     dataOut.writeInt(element.getLineNumber());
1:                 }
1:                 tightMarshalThrowable2(wireFormat, o.getCause(), dataOut, bs);
1:             }
1:         }
1:     }
1:     
0:     protected String tightUnmarshalString(DataInputStream dataIn, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
0:             if( bs.readBoolean() ) {
1:                 int size = dataIn.readShort();
1:                 byte data[] = new byte[size];
1:                 dataIn.readFully(data);
0:                 return new String(data,0); // Yes deprecated, but we know what we are doing.
0:             }  else {
1:                 return dataIn.readUTF();
1:             }
1:         } else {
1:             return null;
1:         }
1:     }
1:     
0:     protected int tightMarshalString1(String value, BooleanStream bs) throws IOException { 
0:         bs.writeBoolean(value!=null);
0:         if( value!=null ) {
1:             
1:             int strlen = value.length();
1:             int utflen = 0;
1:             char[] charr = new char[strlen];
0:             int c, count = 0;
0:             boolean isOnlyAscii=true;
1: 
1:             value.getChars(0, strlen, charr, 0);
1: 
1:             for (int i = 0; i < strlen; i++) {
1:                 c = charr[i];
1:                 if ((c >= 0x0001) && (c <= 0x007F)) {
1:                     utflen++;
1:                 } else if (c > 0x07FF) {
1:                     utflen += 3;
0:                     isOnlyAscii=false;
1:                 } else {
0:                     isOnlyAscii=false;
1:                     utflen += 2;
1:                 }
1:             }
1:             
0:             if( utflen >= Short.MAX_VALUE )
1:                 throw new IOException("Encountered a String value that is too long to encode.");
1:             
0:             bs.writeBoolean(isOnlyAscii);            
0:             return utflen+2;
1:             
1:         } else {
1:             return 0;
1:         }
1:     }
1:     
0:     protected void tightMarshalString2(String value, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
1:             // If we verified it only holds ascii values
0:             if( bs.readBoolean() ) {
1:                 dataOut.writeShort(value.length());
1:                 dataOut.writeBytes(value);
1:             } else {
0:                 dataOut.writeUTF(value);                
1:             }
1:         }
1:     }  
1:     
0:     protected int tightMarshalObjectArray1(OpenWireFormat wireFormat, DataStructure[] objects, BooleanStream bs) throws IOException {
0:         if( objects != null ) {
0:             int rc=0;
1:             bs.writeBoolean(true);
1:             rc += 2;
0:             for( int i=0; i < objects.length; i++ ) {
0:                 rc += tightMarshalNestedObject1(wireFormat,objects[i], bs);
1:             }
1:             return rc;
1:         } else {
1:             bs.writeBoolean(false);
1:             return 0;
1:         }
1:     }
1:     
0:     protected void tightMarshalObjectArray2(OpenWireFormat wireFormat, DataStructure[] objects, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ) {
1:             dataOut.writeShort(objects.length);
0:             for( int i=0; i < objects.length; i++ ) {
0:                 tightMarshalNestedObject2(wireFormat,objects[i], dataOut, bs);
1:             }
1:         }
1:     }
1: 
1:     protected int tightMarshalConstByteArray1(byte[] data, BooleanStream bs, int i) throws IOException {
1:         return i;
1:     }
0:     protected void tightMarshalConstByteArray2(byte[] data, DataOutputStream dataOut, BooleanStream bs, int i) throws IOException {
1:         dataOut.write(data, 0, i);
1:     }
1: 
0:     protected byte[] tightUnmarshalConstByteArray(DataInputStream dataIn, BooleanStream bs, int i) throws IOException {
1:         byte data[] = new byte[i];
1:         dataIn.readFully(data);
1:         return data;
1:     }
1: 
1:     protected int tightMarshalByteArray1(byte[] data, BooleanStream bs) throws IOException {
0:         bs.writeBoolean(data!=null);
0:         if( data!=null ){
0:             return data.length+4;
1:         } else {
1:             return 0;
1:         }
1:     }
1:     
0:     protected void tightMarshalByteArray2(byte[] data, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ){
1:             dataOut.writeInt(data.length);
1:             dataOut.write(data);
1:         }
1:     }
1: 
0:     protected byte[] tightUnmarshalByteArray(DataInputStream dataIn, BooleanStream bs) throws IOException {
0:         byte rc[]=null;
0:         if( bs.readBoolean() ) {
1:             int size = dataIn.readInt();
1:             rc = new byte[size];
1:             dataIn.readFully(rc);
1:         }
1:         return rc;
1:     }
1:     
1:     protected int tightMarshalByteSequence1(ByteSequence data, BooleanStream bs) throws IOException {
0:         bs.writeBoolean(data!=null);
0:         if( data!=null ){
0:             return data.getLength()+4;
1:         } else {
1:             return 0;
1:         }
1:     }
1:     
0:     protected void tightMarshalByteSequence2(ByteSequence data, DataOutputStream dataOut, BooleanStream bs) throws IOException {
0:         if( bs.readBoolean() ){
1:             dataOut.writeInt(data.getLength());
1:             dataOut.write(data.getData(), data.getOffset(), data.getLength());
1:         }
1:     }
1: 
0:     protected ByteSequence tightUnmarshalByteSequence(DataInputStream dataIn, BooleanStream bs) throws IOException {
0:         ByteSequence rc=null;
0:         if( bs.readBoolean() ) {
1:             int size = dataIn.readInt();
1:             byte[] t = new byte[size];
1:             dataIn.readFully(t);
1:             return new ByteSequence(t, 0, size);
1:         }
1:         return rc;
1:     }
1: 
1:     //
1:     // The loose marshaling logic
1:     //
1:     
0:     public void looseMarshal(OpenWireFormat wireFormat, Object o, DataOutputStream dataOut) throws IOException {        
1:     }
0:     public void looseUnmarshal(OpenWireFormat wireFormat, Object o, DataInputStream dataIn) throws IOException {        
1:     }
1:     
0:     public void looseMarshalLong(OpenWireFormat wireFormat, long o, DataOutputStream dataOut) throws IOException {
1:         dataOut.writeLong(o);
1:     }
0:     public long looseUnmarshalLong(OpenWireFormat wireFormat, DataInputStream dataIn) throws IOException {
1:         return dataIn.readLong();
1:     }
1:     
0:     protected DataStructure looseUnmarsalNestedObject(OpenWireFormat wireFormat, DataInputStream dataIn) throws IOException {
1:         return wireFormat.looseUnmarshalNestedObject(dataIn);
1:     }    
0:     protected void looseMarshalNestedObject(OpenWireFormat wireFormat, DataStructure o, DataOutputStream dataOut) throws IOException {
1:         wireFormat.looseMarshalNestedObject(o, dataOut);
1:     }
1: 
0:     protected DataStructure looseUnmarsalCachedObject(OpenWireFormat wireFormat, DataInputStream dataIn) throws IOException {
0:         if( wireFormat.isCacheEnabled() ) {
0:             if( dataIn.readBoolean() ) {
1:                 short index = dataIn.readShort();
1:                 DataStructure object = wireFormat.looseUnmarshalNestedObject(dataIn);
1:                 wireFormat.setInUnmarshallCache(index, object);
1:                 return object;
1:             } else {
1:                 short index = dataIn.readShort();
1:                 return wireFormat.getFromUnmarshallCache(index);
1:             }
1:         } else {
1:             return wireFormat.looseUnmarshalNestedObject(dataIn);
1:         }
1:     }    
0:     protected void looseMarshalCachedObject(OpenWireFormat wireFormat, DataStructure o, DataOutputStream dataOut) throws IOException {
0:         if( wireFormat.isCacheEnabled() ) {
1:             Short index = wireFormat.getMarshallCacheIndex(o);
1:             dataOut.writeBoolean(index == null);
0:             if( index == null ) {
1:                 index = wireFormat.addToMarshallCache(o);
1:                 dataOut.writeShort(index.shortValue());
1:                 wireFormat.looseMarshalNestedObject(o, dataOut);
1:             } else {
1:                 dataOut.writeShort(index.shortValue());
1:             }
1:         } else {
1:             wireFormat.looseMarshalNestedObject(o, dataOut);
1:         }
1:     }
1:     
0:     protected Throwable looseUnmarsalThrowable(OpenWireFormat wireFormat, DataInputStream dataIn) throws IOException {
0:         if( dataIn.readBoolean() ) {
0:             String clazz =  looseUnmarshalString(dataIn);
1:             String message = looseUnmarshalString(dataIn);
1:             Throwable o = createThrowable(clazz, message);
0:             if( wireFormat.isStackTraceEnabled() ) {
0:                 if( STACK_TRACE_ELEMENT_CONSTRUCTOR!=null) {
1:                     StackTraceElement ss[] = new StackTraceElement[dataIn.readShort()];
1:                     for (int i = 0; i < ss.length; i++) {
1:                         try {
0:                             ss[i] = (StackTraceElement) STACK_TRACE_ELEMENT_CONSTRUCTOR.newInstance(new Object[]{
0:                                 looseUnmarshalString(dataIn),
0:                                 looseUnmarshalString(dataIn), 
0:                                 looseUnmarshalString(dataIn), 
0:                                 new Integer(dataIn.readInt())
0:                                 });
1:                         } catch (IOException e) {
1:                             throw e;
1:                         } catch (Throwable e) {
1:                         }
1:                     }
1:                     o.setStackTrace(ss);
1:                 } else {
1:                     short size = dataIn.readShort();
1:                     for (int i = 0; i < size; i++) {
1:                         looseUnmarshalString(dataIn);
1:                         looseUnmarshalString(dataIn); 
1:                         looseUnmarshalString(dataIn); 
1:                         dataIn.readInt();
1:                     }
1:                 }
1:                 o.initCause(looseUnmarsalThrowable(wireFormat, dataIn));
1:                 
1:             }
1:             return o;
1:         } else {
1:             return null;
1:         }
1:     }
1:         
1:     
0:     protected void looseMarshalThrowable(OpenWireFormat wireFormat, Throwable o, DataOutputStream dataOut) throws IOException {
0:         dataOut.writeBoolean(o!=null);
0:         if( o!=null ) {
1:             looseMarshalString(o.getClass().getName(), dataOut);
1:             looseMarshalString(o.getMessage(), dataOut);
0:             if( wireFormat.isStackTraceEnabled() ) {
1:                 StackTraceElement[] stackTrace = o.getStackTrace();
1:                 dataOut.writeShort(stackTrace.length);
1:                 for (int i = 0; i < stackTrace.length; i++) {
1:                     StackTraceElement element = stackTrace[i];
1:                     looseMarshalString(element.getClassName(), dataOut);
1:                     looseMarshalString(element.getMethodName(), dataOut);
1:                     looseMarshalString(element.getFileName(), dataOut);
1:                     dataOut.writeInt(element.getLineNumber());
1:                 }
1:                 looseMarshalThrowable(wireFormat, o.getCause(), dataOut);
1:             }
1:         }
1:     }
1:     
0:     protected String looseUnmarshalString(DataInputStream dataIn) throws IOException {
0:         if( dataIn.readBoolean() ) {
1:             return dataIn.readUTF();
1:         } else {
1:             return null;
1:         }
1:     }
1:     
0:     protected void looseMarshalString(String value, DataOutputStream dataOut) throws IOException {
0:         dataOut.writeBoolean(value!=null);
0:         if( value!=null ) {
0:             dataOut.writeUTF(value);                
1:         }
1:     }  
1:     
0:     protected void looseMarshalObjectArray(OpenWireFormat wireFormat, DataStructure[] objects, DataOutputStream dataOut) throws IOException {
0:         dataOut.writeBoolean(objects!=null);
0:         if( objects!=null ) {
1:             dataOut.writeShort(objects.length);
0:             for( int i=0; i < objects.length; i++ ) {
0:                 looseMarshalNestedObject(wireFormat,objects[i], dataOut);
1:             }
1:         }
1:     }
1:     
0:     protected void looseMarshalConstByteArray(OpenWireFormat wireFormat, byte[] data, DataOutputStream dataOut, int i) throws IOException {
1:         dataOut.write(data, 0, i);
1:     }
1: 
0:     protected byte[] looseUnmarshalConstByteArray(DataInputStream dataIn, int i) throws IOException {
1:         byte data[] = new byte[i];
1:         dataIn.readFully(data);
1:         return data;
1:     }
1: 
0:     protected void looseMarshalByteArray(OpenWireFormat wireFormat, byte[] data, DataOutputStream dataOut) throws IOException {
0:         dataOut.writeBoolean(data!=null);
0:         if( data!=null ){
1:             dataOut.writeInt(data.length);
1:             dataOut.write(data);
1:         }
1:     }
1: 
0:     protected byte[] looseUnmarshalByteArray(DataInputStream dataIn) throws IOException {
0:         byte rc[]=null;
0:         if( dataIn.readBoolean() ) {
1:             int size = dataIn.readInt();
1:             rc = new byte[size];
1:             dataIn.readFully(rc);
1:         }
1:         return rc;
1:     }
1: 
0:     protected void looseMarshalByteSequence(OpenWireFormat wireFormat, ByteSequence data, DataOutputStream dataOut) throws IOException {
0:         dataOut.writeBoolean(data!=null);
0:         if( data!=null ){
1:             dataOut.writeInt(data.getLength());
1:             dataOut.write(data.getData(), data.getOffset(), data.getLength());
1:         }
1:     }
1: 
0:     protected ByteSequence looseUnmarshalByteSequence(DataInputStream dataIn) throws IOException {
0:         ByteSequence rc=null;
0:         if( dataIn.readBoolean() ) {
1:             int size = dataIn.readInt();
1:             byte[] t = new byte[size];
1:             dataIn.readFully(t);
1:             rc = new ByteSequence(t, 0, size);
1:         }
1:         return rc;
1:     }
1: }
author:Robert Davies
-------------------------------------------------------------------------------
commit:4821b9d
/////////////////////////////////////////////////////////////////////////
1: import java.io.DataInput;
1: import java.io.DataOutput;
/////////////////////////////////////////////////////////////////////////
0:     public void tightMarshal2(OpenWireFormat wireFormat, Object o, DataOutput dataOut, BooleanStream bs) throws IOException {        
0:     public void tightUnmarshal(OpenWireFormat wireFormat, Object o, DataInput dataIn, BooleanStream bs) throws IOException {        
/////////////////////////////////////////////////////////////////////////
0:     public void tightMarshalLong2(OpenWireFormat wireFormat, long o, DataOutput dataOut, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     public long tightUnmarshalLong(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected DataStructure tightUnmarsalNestedObject(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs) throws IOException {
0:     protected void tightMarshalNestedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut, BooleanStream bs) throws IOException {
0:     protected DataStructure tightUnmarsalCachedObject(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void tightMarshalCachedObject2(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected Throwable tightUnmarsalThrowable(OpenWireFormat wireFormat, DataInput dataIn, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void tightMarshalThrowable2(OpenWireFormat wireFormat, Throwable o, DataOutput dataOut, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected String tightUnmarshalString(DataInput dataIn, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected void tightMarshalString2(String value, DataOutput dataOut, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void tightMarshalObjectArray2(OpenWireFormat wireFormat, DataStructure[] objects, DataOutput dataOut, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void tightMarshalConstByteArray2(byte[] data, DataOutput dataOut, BooleanStream bs, int i) throws IOException {
0:     protected byte[] tightUnmarshalConstByteArray(DataInput dataIn, BooleanStream bs, int i) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void tightMarshalByteArray2(byte[] data, DataOutput dataOut, BooleanStream bs) throws IOException {
1:     protected byte[] tightUnmarshalByteArray(DataInput dataIn, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void tightMarshalByteSequence2(ByteSequence data, DataOutput dataOut, BooleanStream bs) throws IOException {
1:     protected ByteSequence tightUnmarshalByteSequence(DataInput dataIn, BooleanStream bs) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     public void looseMarshal(OpenWireFormat wireFormat, Object o, DataOutput dataOut) throws IOException {        
0:     public void looseUnmarshal(OpenWireFormat wireFormat, Object o, DataInput dataIn) throws IOException {        
1:     public void looseMarshalLong(OpenWireFormat wireFormat, long o, DataOutput dataOut) throws IOException {
1:     public long looseUnmarshalLong(OpenWireFormat wireFormat, DataInput dataIn) throws IOException {
0:     protected DataStructure looseUnmarsalNestedObject(OpenWireFormat wireFormat, DataInput dataIn) throws IOException {
0:     protected void looseMarshalNestedObject(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut) throws IOException {
0:     protected DataStructure looseUnmarsalCachedObject(OpenWireFormat wireFormat, DataInput dataIn) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void looseMarshalCachedObject(OpenWireFormat wireFormat, DataStructure o, DataOutput dataOut) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected Throwable looseUnmarsalThrowable(OpenWireFormat wireFormat, DataInput dataIn) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void looseMarshalThrowable(OpenWireFormat wireFormat, Throwable o, DataOutput dataOut) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected String looseUnmarshalString(DataInput dataIn) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected void looseMarshalString(String value, DataOutput dataOut) throws IOException {
0:     protected void looseMarshalObjectArray(OpenWireFormat wireFormat, DataStructure[] objects, DataOutput dataOut) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void looseMarshalConstByteArray(OpenWireFormat wireFormat, byte[] data, DataOutput dataOut, int i) throws IOException {
1:     protected byte[] looseUnmarshalConstByteArray(DataInput dataIn, int i) throws IOException {
0:     protected void looseMarshalByteArray(OpenWireFormat wireFormat, byte[] data, DataOutput dataOut) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected byte[] looseUnmarshalByteArray(DataInput dataIn) throws IOException {
/////////////////////////////////////////////////////////////////////////
0:     protected void looseMarshalByteSequence(OpenWireFormat wireFormat, ByteSequence data, DataOutput dataOut) throws IOException {
/////////////////////////////////////////////////////////////////////////
1:     protected ByteSequence looseUnmarshalByteSequence(DataInput dataIn) throws IOException {
author:James Strachan
-------------------------------------------------------------------------------
commit:f1e4459
/////////////////////////////////////////////////////////////////////////
1:                 return toLong(dataIn.readInt());
1:                 return toLong(dataIn.readShort());
1:     protected long toLong(short value) {
1:         // lets handle negative values
1:         long answer = value;
1:         return answer & 0xffffL;
0:     }
0:     
1:     protected long toLong(int value) {
1:         // lets handle negative values
1:         long answer = value;
1:         return answer & 0xffffffffL;
0:     }
0:     
============================================================================